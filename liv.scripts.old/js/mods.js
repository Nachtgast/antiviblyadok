"use strict";bibil.module("Api",(function(){function Api(e){var t=[],n={},i="",o={};"object"==typeof e?("status"in e&&"statusText"in e&&t.push("Ошибка запроса#"+e.status+": "+e.statusText),"errors"in e&&(e.errors instanceof Array?e.errors.forEach((function(e){t.push(e)})):e.errors instanceof Object?$.each(e.errors,(function(e,n){t.push(e+": "+n)})):"string"==typeof e.errors&&e.errors.length>0&&t.push(e.errors)),0===t.length&&"success"in e&&!e.success&&t.push("Неизвестная ошибка"),"meta"in e&&(o=e.meta,o.redirect&&o.redirect&&(window.location=o.redirect))):t.push("Получены неверные данные"),0===t.length&&("res"in e&&(n=e.res),"success"in e&&(i=e.success)),this.errors=t,this.result=n,this.success=i,this.response=e,this.getErrorHtml=function a(){var e="";return t.forEach((function(t){e+='<div class="alert alert-danger">'+t+"</div>"})),e}}return Api.action=function(e,t,n,i){return Api.request("action/"+e,{action:e,obj:t,obj_id:n,opt:i})},Api.request=function(e,t,n){var i,o=$.Deferred();"object"!=typeof n&&(n={});var a={method:"post",url:0===e.indexOf("/")||/^https?\:\/\//.test(e)?e:"/api/"+e,success:function(e){r(e)},error:function(e){r(e)},complete:function(){}};function r(e){i=new Api(e),0===i.errors.length?o.resolve(e):o.reject(i.errors)}return"undefined"!=typeof FormData&&t instanceof FormData?($.each(Bibil.moduleGlobalOptions.post,(function(e,n){t.append(e,n)})),a.data=t,a.processData=!1,a.contentType=!1):(t=$.extend({},Bibil.moduleGlobalOptions.post,t),a.data=t),$.ajax(a),o},Api})),bibil.module("BlockAjax",(function(){function BlockAjax(e,t){var n,i,o,a=this,r=t.obj||"",s=t.block,l=t.modalHidden,c={block:s,params:bibil.json(t.opt)},d="block_"+bibil.makeid(10),u=$("body"),f=t.target?$(t.target):null,p='<i class="fa fa-spinner fa-spin"></i>';function h(e){o&&(e?o.addClass("app-loading"):o.removeClass("app-loading"))}function m(i){if(a.loading)return error("block is loading...cancel"),!1;i=i||{};var r,l="reload"in i&&i.reload,d="params"in i&&i.params,u=i.post&&"object"==typeof i.post?i.post:{},m=$.Deferred(),v=$.extend({},u,c);return l&&(v.__reload=1),d&&"object"==typeof d&&(v.params=$.extend({},v.params,d)),$.ajax({url:"/api/block/"+s,method:"post",data:v,beforeSend:function(){h(!0),f&&(t.outer?f.html(p):f.prepend(p+" ")),e&&e.trigger("app.block.before"),bibil.UI.loading(!0),a.loading=!0},success:function(t){n=new bibil.Api(t),n.errors.length>0?(bibil.UI.popupFixError(n.errors),m.reject(n.errors,n)):(r=l?function i(e){return o?(g(),b(e,{fade:!1})):b(e)}(n.result.block):b(n.result.block),a.result=n.result,m.resolve(r),a.fire("load",t),e&&e.trigger("app.block.load",t))},error:function(e,t){log(e),bibil.UI.error("Ошибка запроса. "+e.status+": "+e.statusText)},complete:function(){h(!1),bibil.UI.loading(!1),a.loading=!1}}),m}function b(n,r){return r=r||{},i=$('<div class="block-holder"></div>').attr("id",d),i.append(n),o&&o,o=i.find(">.modal"),o.length>0?(e&&e.trigger("app.block.modalCreate",o),a.fire("modalCreate",o),"fade"in r&&!r.fade&&o.removeClass("fade"),function s(n){var i={};n.addClass(""+t.block.replaceAll("\\.","-")),t.fullHeight&&n.addClass("full-height"),n.on("hidden.bs.modal",(function(){g(),e&&e.trigger("close.block.app",n)})),n.on("show.bs.modal",(function(){})),n.on("shown.bs.modal",(function(){a.fire("open",n),e&&e.trigger("app.block.open",n)})),t.disableKeyboard&&(i.keyboard=!1,i.backdrop="static"),n.modal(i),n.hasClass("modal-static")&&$(".modal-backdrop").removeClass("modal-backdrop"),n.data("BlockAjax",a)}(o),u.append(i),o):(o=!1,e&&(t.outer?f.outerHTML(n):t.parent?f.html(n):e.html(n)),a.fire("open",i),e&&e.trigger("app.block.open",i),i)}function g(e){o&&(o.removeClass("fade"),o.modal("hide")),(e||!l&&(void 0===t.removeHolder||t.removeHolder))&&i.remove(),a.fire("remove")}e&&(t.outer?f=e:t.parent&&(f=e.parents("."+t.parent+":first"))),r&&(c.obj=r),"post"in t&&(c=$.extend(c,t.post)),"submit"in t&&(c=$.extend(c,t.submit)),this.showModal=function(){o&&o.modal("show")},this.blockExists=function(){var e=$("#"+d);return!!(e&&e.length>0)&&e},this.load=m,this.reload=function v(e,t){m({reload:!0,params:e,post:t})},this.clear=function y(){o?o.find("modal-body").html(""):e.html("")},this.loading=!1,this.blockId=d,this.blockName=s,this.remove=g,this.result=null}return $.fn.BlockAjax=bibil.registerJqueryPlugin(BlockAjax),BlockAjax}),["Api"]),bibil.module("Chat",(function(){function Chat(e,t){var n,i,o,a,r,s,l,c,d,u,f=this,p=t.room,h=0,m=new this.UserManager,b={},g={},v=t,y=null,w=bibil.Daemon.getWs(),C={},k=!1,x=v.settings,A=t.joinBlock,j=t.introBlock,I=t.theme||Cookies("theme")||"light",S=[],T=[],_=t.uid||!1,D=window.MagickChars?new window.MagickChars:null;if(this.room=p,!p)throw bibil.UI.popupFixError("Команата не передана"),new Error("Команата не передана");if(I&&e.attr("app-smiles-theme",I),bibil.addMutationsSelectorDisabled(".users-list"),t.uri){var M=document.createElement("a"),P=document.createElement("a");M.href=w.getUri(),P.href=t.uri,M.host!==P.host||t.createNewConn?(log("new ws",t.uri),w=new bibil.Ws({uri:t.uri}),w.handler(new bibil.Ws.MessageHandlerDefault),w.connect()):log("use exists ws")}function O(t){var n,o;function a(){if(o=l.getClientId(),o){if(!(o in g))return ie("Пользователь ещё не принял ваш приват, ожидайте",null,{tag:"info"}),!1;n.clientId=l.getClientId()}if(t.length>0||n.images&&n.images.length>0||T.length>0){var e=f.fire("send:before",n),a=[];e.forEach((function(e){"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.then&&"function"==typeof e.catch&&a.push(e)})),me(),a.length>0?$.when.apply(f,a).then((function(){s()})).catch((function(e){s(),bibil.UI.popupFixError(e)})):s()}else i.mark("shake")}function s(){T.forEach((function(e){n.flags[e.name]=e.params||!0})),e.hasClass("messup")&&(n.flags.messup=!0),f.send("chat",n),f.fire("chat",n),window.mobileAppInterfaceReceiver.avail()&&window.mobileAppInterfaceReceiver.call("chatMessSended",{}),e.removeClass("messup"),head.mobile&&(!function t(){i&&i.length>0&&(i.attr("readonly","readonly"),i.attr("disabled","readonly"),setTimeout((function(){i.removeAttr("readonly"),i.removeAttr("disabled")}),100))}(),he("toTopAfterMess")&&setTimeout((function(){window.scrollTo(0,0)}),100)),T=[],me(!1)}n={text:t,flags:{}},this.send=function c(){var e=[];r&&(e=r.getAttached()),e.length>0?bibil.Api.action("attachImages","chat_room","",{files:e}).then((function(e){n.images=e.res.files,a()})).catch((function(e){bibil.UI.popupFixError(e)})):a()}}function U(){this.error=function(e){e.code&&"passwordPrompt"===e.code&&de()},this.joined=function(t){var n=t.self,i=t.lastMessages;ce(n),$(".chat-password-prompt").modal("hide"),C.nickname&&(Cookies.set("chat_nickname",n.nickname,{expires:30}),bibil.storage("chat_nickname",n.nickname)),n.info&&n.info.sex&&bibil.storage("chat_sex",n.info.sex),i&&(te(i,"main",{history:!0}),ee("main").scrollEnd()),function o(){e.find(".chat-join-dialog").remove()}(),Z(!1)},this.message=function(e){var t,n,i=e.from,o=e.owner&&e.owner.info.uid&&ve(e.owner.info.uid);if(e.toUids&&$.each(e.toUids,(function(e,t){ve(t)&&(o=!0)})),o)return log("innored mess, cancel"),!1;if(i){if(n=l.getTab(i.id),!n)return void log("client not join to private");t=n.id,l.isActive(t)||l.setNew(t),bibil.Utils.tabVisible||fe(),bibil.UI.titleInactive("Приват")}else t="main";e.my&&(i||fe(),bibil.UI.titleInactive("Сообщение чат")),te(e,t)},this.updateRoom=function(t){if(void 0!==t.count&&(h=t.count||0,l.updateCount(h),e.find(".count-clients2").text(h)),t.client){if("add"===t.type){var n=se(t.client);!function i(e){if(ye(e)){var t=$('<img width="30px" src="'+e.info.avatar+'"/> <strong><span class="nick-to"></span></strong> зашел <img  src="/i/friend_join.gif"/>');t.find(".nick-to").text(e.nickname),ie(t,null,{tag:"friend"})}}(n)}"remove"===t.type&&function o(e){q(e.id),l.getUsersList().remove(e.id),m.remove(e.id)}(t.client),"update"===t.type&&ae(t.client),t.client.self&&ce(t.client)}},this.users=function(e){e.list.length>50?setTimeout((function(){re(e.list)}),1):re(e.list),l.updateCount(e.count)},this.private=function(e){var t=m.getById(e.clientId);if(he("privateOff")&&!ye(t))return log("privateOff"),!1;t&&(v.privateAutoOpen?N(e.clientId):(c.add({text:t.nickname,icon:t.getAvatar(),descr:"приват",tag:"private"+t.id,click:function(t){var n=m.getById(e.clientId);n?N(e.clientId):log("user not found"),c.remove(t)},cancel:function(e){c.remove(e)}}),f.isOnlyTabs&&f.tabsManager&&f.tabsManager.notifyNew()))},this.privateOpen=function(e){!function t(e){var t=l.getTab(e),n=m.getById(e);t?n?(l.unmuteTab(t.id),ie("Пользователь вошел: "+n.nickname,t.id,{tag:"join"}),l.setTab(t.id),l.isActive(t.id)):error("user not found",e):log("tab not opened",e)}(e.clientId)},this.privateClose=function(e){q(e.clientId)},this.typing=function(e){var t=e.clientId,n=t?ee(t):null;n&&(n.typed(!0),setTimeout((function(){n.typed(!1)}),1e3))},this.ignored=function(e){m.getById(e.clientId),e.client;ae(e.client)},this.ignor=function(e){var t=m.getById(e.clientId);t||error("user not found",e.clientId)},this.banAlert=function(e){var t=[e.alertText];e.comment&&t.push(e.comment),bibil.UI.alert(t)},this.ban=function(e){var t=[e.banText];e.comment&&t.push("<strong>"+e.comment+"</strong>"),bibil.UI.error(t),bibil.Utils.beep("ban")},this.baned=function(e){ie(e.text,"main",{tag:"baned"})},this.dropped=function(t){var n=t.client;bibil.UI.error("Вы сброшены с чата "+(n?n.nickname:"")),e.addClass("self-dropped")},this.moderated=function(e){bibil.UI.popupFix("Вас назначили смотрящим!",{autoHide:!1})},this.moderatedremove=function(){bibil.UI.popupFixError("Вас удалили из смотрящих",{autoHide:!1})},this.selfUpdate=function(e){ce(e.client)},this.passwordPrompt=function(e){de()},this.roomUpdate=function(e){$.extend(u,e)},this.leave=function(){A?ue():bibil.UI.modal("Вы покинули чат")},this.messRemoved=function(t){var n=t.mid,i=t.client,o=e.find(".mess-row[data-mid="+n+"]");if(o.length>0){o.addClass("mess-removed");var a=o.find(".text").html();o.find(".text").html("<i>сообщение удалено "+(i?i.nickname:"")+'</i> <span class="h">'+a+"</span>")}else error("mess not found",n)}}function F(e,t,n){this.privat=function(){H(t.id)},this.ignor=function(){f.ignore(t)},this.exit=function(){f.send("drop",{clientId:t.id})},this.addmoder=function(){(e&&1===e.data("exists")||confirm("Вы уверены, что хотите добавить его в смотрящие? Добавляйте только если ДОВЕРЯЕТЕ пользователю на 100%!"))&&f.send("toggleModer",{clientId:t.id})},this.messchat=function(){pe(t.nickname)},this.info=function(){var e,n=bibil.make(bibil.BlockAjax,null,{block:"chat.card",obj:"chat",opt:{info:t.info.extended,nickname:t.nickname}});n.load().then((function(n){e=n.find("form"),t.info.extended&&e.length}))},this.videocall=function(){f.fire("videocallRequest",t)},this.confJoin=function(){f.fire("confJoin",t)}}function E(t,n){var o={},a="main",r=e.find(".chat-navs-dropdown"),s=0,l=this,c=e.find(".chat-tabs-wrapper"),u=head.mobile&&head.browser.chrome?"scroll":"absolute";function p(){return t.isOverflow()}function h(){if("ie"===head.browser.name&&head.browser.version<=11)return!1;e.toggleClass("tabs-overflowed",p())}function m(t){t?e.addClass("tabs-abs"):e.removeClass("tabs-abs"),h()}function b(e){return o[e]||null}function g(){return o}function v(e){return t.find(".chat-tab[data-id="+e+"]")}function y(){return b(a)}function w(e,n){var o,r=b(e);r?(t.find(".chat-tab").removeClass("active"),o=v(e),o.addClass("active"),o.removeClass("new"),a=e,r.getClientId(),r.openContent(),(!function s(e){var n=function i(e){var n=0;return t.find(".chat-tab").each((function(t){var i=$(this).data("id");if(n+=$(this).outerWidth(),e&&i===e)return!1})),n}(e);return n<t.outerWidth()}(e)&&"absolute"===u||!n&&"scroll"===u&&p())&&A(e),c.toggleClass("active-last",t.find(".chat-tab.active").is(":last-child")),d&&d.toggleList(!0),l.fire("tabActive",e,r)):error("tab not found",e),head.touch||function f(){i.insertAtCaret("")}()}function C(n,i){if("main"!==n){var r,s,c=b(n);c?(s=v(n),s&&(r=s.data("clientid"),r&&f.relay("privateClose",r),s.remove(),h()),c.close(),delete o[n],n===a&&w("main"),1===function d(){return t.find(".chat-tab").length}()&&e.removeClass("tab-opened"),l.fire("tabClose",n,c,i)):error("tab not found",n)}}function k(e,t){b(e);var n=v(e);n&&(t?n.removeClass("tab-mute"):n.addClass("tab-mute"))}function x(e){var t=v("main");t&&t.length>0&&(void 0===e?t.find(".icon").addClass("fa fa-bell-o text-danger animated flash infinite").removeClass("d-none"):t.find(".icon").addClass("d-none"))}function A(e){var n="object"==typeof e?e:v(e);n&&(t.find(".chat-tab:first").after(n),"scroll"===u&&t.scrollLeft(0))}"scroll"===u?e.addClass("chat-tabs-scroll"):e.addClass("chat-tabs-absolute"),r.find("button").on("click",(function(){m(!e.hasClass("tabs-abs"))})),t.on("click",".chat-tab",(function(e){var t=$(this).data("id");w(t,e),"main"===t&&x(!1),"absolute"===u&&m(!1)})),t.on("mousedown",".chat-tab",(function(e){var t=$(this).data("id");2===e.which&&C(t,e)})),t.on("click",".chat-tab .close-tab",(function(e){var t=$(this).parents(".chat-tab:first").data("id");C(t,e)})),t.on("touchstart",".chat-tab",(function(e){s=e.originalEvent.changedTouches[0].clientY})),t.on("touchend",".chat-tab",(function(e){var t=$(this).data("id"),n=e.originalEvent.changedTouches[0].clientY;s>n+30?(C(t,e),log("up")):s<n-30&&log("down")})),this.getUsersList=function j(){var e=b("main");if(e)return e.getUsersList()},this.openTab=function I(i,a){var r={name:"Зрители",icon:""};"object"==typeof i&&(r=i,i=r.id),i||(i="tab_"+bibil.makeid(10));var s=b(i);if(s)log("exists",i);else{var l=a?a.nickname:r.name,c=$('<span class="text-sm-center nav-link chat-tab app-text-overflow" data-id="" href="#"><span class="icon d-none mr-1"></span><span class="name">Чат</span> <span class="count-clients"></span><span class="close-tab"><i class="fa fa-times" aria-hidden="true"></i></span></span>');c.attr("data-id",i),a&&c.attr("data-clientid",a.id),c.find(".name").text(l),r.icon&&c.find(".icon").addClass(r.icon).removeClass("d-none"),s=new B(i,n,a),t.append(c),o[i]=s,h(),"main"!==i&&e.addClass("tab-opened")}return w(i),s},this.getTab=b,this.setTab=w,this.getMessages=function S(e){return b(e).getMessages()},this.updateCount=function T(e){v("main").find(".count-clients").text(e)},this.getClientId=function _(){return y().getClientId()},this.closeTab=C,this.closeAll=function D(){var e=g();for(var t in e)C(t)},this.muteTab=k,this.unmuteTab=function M(e){k(e,!0)},this.getCurrent=y,this.setNew=function P(e){v(e).addClass("new")},this.isActive=function O(e){return v(e).hasClass("active")},this.getAll=g,this.tabToFront=A,this.notifyNew=x}function B(t,n,i){var o,a,r=0;function s(){var e=n.find("[data-tab="+t+"]");return e.length>0?e:null}function l(e){d().stop(!0,!0),k?d().scrollTop(0):d().scrollEnd(e)}function c(e){s().toggleClass("auto-scroll-disable",!e),e&&l(0),d().clearQueue().stop()}function d(){return s().find(".message-tab")}function u(){var e=s();n.find(".tab-pane").removeClass("active"),e?(e.addClass("active"),d().scrollEnd()):error("tab content not found",t)}this.getClientId=function f(){return i?i.id:0},this.setContent=u,this.openContent=function p(){var e=$("#app-chat-tabContent-tpl").clone().removeAttr("id").removeClass("d-none"),i=s();if(!i){o=e.find(".chat-mess-typing"),e.attr("data-tab",t),n.append(e);var a=e.find(".auto-scroll-toggler");k&&a.find(".fa").removeClass("fa-arrow-down").addClass("fa-arrow-up"),he("autoScrollSmartDisabled")||d().on("scroll",(function(){var e,t,n,i,o,a=$(this);if(t=a.scrollTop(),e=a.iScrollEndY(),o=0===t,n=a.scrollBottom(),i=!(t>=r)&&n,r=t,k){if(o)return c(!0);i?o&&c(!0):c(!1)}else i?c(!1):e&&c(!0)})),a.on("click",(function(){c(!0)}))}u()},this.getContent=s,this.setUsersList=function h(t){this.userList=t;var n=s();n&&e.find(".users-list-wrapper").append(t.getElement())},this.getUsersList=function m(){return this.userList},this.getMessages=d,this.scrollEnd=l,this.close=function b(){s().remove()},this.typed=function g(e){a||(a=new Typed(o.find("small")[0],{strings:["","вам","что то","пишет"],loop:!0})),!1===e?(a.stop(),o.addClass("d-none")):(o.removeClass("d-none"),a.start())},this.autoScroll=c,this.autoScrollEnable=function v(){return!s().hasClass("auto-scroll-disable")},this.id=t}function L(){var t,n,i=$("#app-chat-list-tpl > div").clone().removeClass("d-none").removeAttr("id"),o=i.find(".users-list"),a=this;function r(e){var t=o.find("[data-id="+e+"]");return 0===t.length&&error("not found",e,t),t}function s(e){var t=e.confHTML(!0);n=t,o.prepend(t)}function l(t){e.toggleClass("users-list-hidden",t)}i.find(".users-list-spacer").on("click",(function(){l()})),o.on("click",">.user a",(function(){return!1})),o.on("dblclick",">.user",(function(){H($(this).data("id"))})),o.addDomListener({}).on("app.dom.inert app.dom.remove",(function(t,n,i){e.toggleClass("users-list-overflowed",o.isOverflow())})),this.add=function c(e){var i=e.userHTML(!0);t&&!jQuery.contains(o[0],t[0])&&(t=null),n&&!jQuery.contains(o[0],n[0])&&(n=null),n?n.after(i):t&&!e.owner?t.after(i):o.prepend(i),e.info&&e.info.mobile&&i.addClass("mobile"),function r(e){e.addClass("user-popover")}(i),a.fire("add",i),e.videoSettings&&"conf"===e.videoSettings.mode&&s(e),e.owner&&(t=i)},this.remove=function d(e){var t=r(e);t.length>0&&t.remove()},this.getElement=function u(){return i},this.clear=function f(){o.html("")},this.hideList=function p(){e.addClass("users-list-hidden")},this.update=function h(e){var t,n=r(e);if(n.length>0){a.fire("update",n),t=m.getById(e);var i=function l(e){return o.find("[data-id="+e+"].conf")}(e);t&&t.videoSettings&&"conf"===t.videoSettings.mode?0===i.length&&s(t):i.length>0&&i.remove()}else error("user not found",e)},this.getList=function b(){return o},this.toggleList=l}function z(e){var t=e.parent(".chat-notifys-wrapper");function n(e){e.remove()}function i(){e.find(".notify").remove()}e.on("mouseenter",(function(){e.find(".notify.animated").removeClass("animated"),e.scrollEnd()})),e.addDomListener().on("app.dom.inert app.dom.remove",(function(){var n=e.find(".notify").length;t.toggleClass("empty",!n),t.toggleClass("more-items",n>5)})),t.find(".actions-notifys .clean-all").on("click",(function(){i()})),this.add=function o(t){var i=bibil.Template.renderEl("templ-chat-notify",{data:{tag:t.tag,text:t.text,descr:t.descr||!1},computed:{avatar:function(){if("string"==typeof t.icon){if(bibil.isPathImage(t.icon))return $("<img>").attr("src",t.icon).outerHTML();i.addClass("bg-"+t.icon)}else if("object"==typeof t.icon)return t.icon.outerHTML()}}});if(t.tag&&function o(t){return e.find(".notify[data-tag="+t+"]").length>0}(t.tag))return!1;!1!==t.animate&&i.addClass("shake"),e.find(".notify.animated").removeClass("animated"),e.append(i),t.cancel&&i.find(".actions").removeClass("d-none").find(".cancel").on("click",(function(){"function"==typeof t.cancel&&t.cancel(i)})),"function"==typeof t.click?i.on("click",(function(){t.click(i)})):i.on("click",(function(){n(i)})),t.autohide&&setTimeout((function(){n(i)}),t.autohide),e.scrollEnd(),e.isOverflow()&&e.addClass("overflowed")},this.remove=n,this.clear=i,this.find=function a(t){var n=e.find(".notify").filter(t);return n.length>0&&n}}function R(e){var t=m.getById(e);t?(log("open private",t.nickname),l.openTab(e,t),f.relay("privateOpen",e)):error("user not found",e)}function q(e){var t=l.getTab(e),n=m.getById(e);t?n?(l.muteTab(t.id),ie("Пользователь вышел: "+n.nickname,t.id,{tag:"leave"})):error("user not found",e):log("tab not opened",e),e in g&&delete g[e]}function H(e,t){var n=m.getById(e);n?(f.relay("private",n.id,(function(e){V(e.clientId)}),$.extend({},t||{})),R(n.id)):error("client not found",e)}function N(e){var t=m.getById(e);t?(f.replay("private",e),V(e),R(e)):log("user not found",e)}function V(e){var t=m.getById(e);t?g[e]=t:error("user not found",e)}function J(){var u;i=e.find(".chat-bottom [name=message]"),n=e.find(".chat-bottom .btn.submit"),s=e.find(".chat-bottom .form-errors"),o=e.find(".chat-messages"),a=e.find(".chat-tabs"),E.prototype=new Bibil.Base,l=new E(a,o),c=new z(e.find(".chat-notifys")),u=l.openTab("main"),d=new L,u.setUsersList(d),r=function p(){return e.find("#chat_comp_uploader").data("Uploader")}();var h=e.find(".app-recorder");h.length>0&&h.getModule("Recorder",(function(e){e.on("app:complete",(function(e){var t=new O("[speech]"+e+"[/speech]");t.send()}))})),Cookies.get("floating")&&void 0===t.floating&&f.floating(!0),head.screen.width<600&&(x.show_tab_close="1",f.toggleFull()),head.mobile&&(e.addClass("extended-hidden"),e.addClass("smiles-hidden")),be(),e.addClass("inited"),f.fire("inited"),e.trigger("app.chat.init")}function W(){i.on("app.entered",(function(){return Y()})),n.on("click",(function(){return Y()})),e.on("click",".nick-to",(function(){var e=$(this).text()||$(this).data("nickname");pe(e)})),e.find(".chat-messages").on("click",".text-hidden",(function(){$(this).removeClass("text-hidden")})),e.find(".chat-messages").on("click",".mess-row .mess-actions .remove",(function(){var e=$(this).pparent(".mess-row"),t=e.data("mid");f.send("messRemove",{mid:t}),$(this).remove()})),e.find(".chat-bottom .btn.clear").on("click",(function(){!function e(){ee().getMessages().html("")}()})),e.find(".chat-bottom .btn.exit-chat").on("click",(function(){!function e(){f.send("leave")}()})),e.find(".chat-bottom .btn.autoscroll").on("click",(function(){})),e.find(".users-list-wrapper .users-list-options-toggler").on("click",(function(){e.toggleClass("users-list-options-open")})),e.find(".users-list-wrapper form select, .users-list-wrapper form input").on("input change",(function(){var e=$(this).parents("form:first").formToObject();log(e),b.ChatFilter.resetFilter(),b.ChatFilter.setFilterOptions(e),b.ChatFilter.filter(l.getUsersList().getList().find(">.user"),"search")})),i.TypingMess({go:function(){var e=l.getClientId();e&&f.relay("typing",e,null)}}),$(window).on("resize",(function(){})),$("body").on("click",".modal.chat-banlist[data-comp-room="+p+"] .actions .remove",(function(){var e=$(this),t=e.data("bid"),n=$(this).data("clientid");t?f.echo("banRemove",{bid:t,clientId:n},(function(){e.parents(".ban-item:first").mark("bounce").on("app.amimated",(function(){$(this).remove()}))})):error("bid not defined")})).on("click",".modal.chat-moders .actions .remove",(function(e){var t=$(this),n=t.data("mid");n?f.echo("toggleModer",{mid:n},(function(){t.parents(".ban-item:first").mark("bounce").on("app.amimated",(function(){$(this).remove()}))})):error("mid not defined")})),e.on("uploader.upload",".self-avatar",(function(e,t){var n=$(this),i=n.data("Uploader");f.echo("updateAva",{id:t.id},(function(){i.resetUI()}))})),e.on("app.custom",".app-dropdown.status",(function(e,t){f.echo("updateStatus",{status:"custom",statusText:t},(function(){}))})),e.on("app.select",".app-dropdown.status",(function(e,t){f.send("updateStatus",{status:t})})),e.on("app.block.modalCreate",".self-info",(function(e,t){var n=X(),i=$(t).find("form");n&&i.formAssign(n),$(t).find("form.ajax").on("form.before",(function(){var e=$(this),n=e.formToObject();f.echo("updateInfo",{info:n},(function(e){G(e.extended),$(t).modal("hide")}))}))})),e.addDomListener().on("app.dom.inert",(function(t,n,i){$(i).findAndSelf(".user-popover").popova({trigger:"manual",html:!0,delay:v.delayPopover,cls:"app-chat-user-popover-box",group:"user-popover",content:function(){var t=$(this).data("user"),n=$(this);if(t){var i=function o(e,t){"object"!=typeof t&&(t={});return bibil.Template.renderElement("app-chat-user-popover-tpl",$.extend({conf:!1,user:e,self:y,room:p},t))}(t,{conf:$(this).hasClass("conf")}),a=i.find(".app-ban-box");return a.length>0&&(a.data("room",p),a.data("scope","chat"),a.data("nickname",t.nickname),a.data("client_id",t.id),a.data("sid",t.sid||""),a.data("uid",t.info.uid||""),a.data("ip",t.ip||""),y&&a.data("moder_nickname",y.nickname)),i.on("click",".actions .btn, .actions .ahndl",(function(e){var i=$(this).parents("[data-action]:first").data("action"),o=new F($(this),t,e);i in o?o[i]():error("action not found",i),n.length&&!$(this).hasClass("noclose")&&0===$(this).parents(".noclose:first").length&&n.popover("hide")})),e.data("user",t),i}return"Нет данных о пользователе"}})})),bibil.on("smiles.rendered.load",(function(){}))}function G(e){var t=X()||{};try{bibil.storage("chat_info",JSON.stringify($.extend(t,e))),void 0!==e.sex&&bibil.storage("chat_sex",e.sex)}catch(e){error("Ошибка сохранения личной информации")}}function X(){var e=bibil.storage("chat_info");if(e)try{e=JSON.parse(e)}catch(e){error("Ошибка получения личной информации")}return e||{}}function Y(){var e=i.val(),t=new O(e);try{t.send(),function n(){K(""),i.val(""),"function"==typeof autosize&&autosize.destroy(i);r&&r.resetUI()}(),window.mobileAppInterfaceReceiver&&window.mobileAppInterfaceReceiver.avail()?i.blur():i.focus()}catch(e){throw function o(e){K(e,"danger")}("Ошибка отправки сообщения: "+(e.message||"unknown")),e}}function K(e,t){"string"!=typeof e||0!==e.length?s.html(bibil.UI.renderAlert(e,t)):s.html("")}function Q(){var e=X();e&&(C.extended=e),f.send("join",$.extend(C,{room:p}))}function Z(t){void 0===t||t?(e.addClass("disabled"),e.trigger("app:chat:disable",!0)):(e.removeClass("disabled"),e.trigger("app:chat:disable",!1)),"string"==typeof t&&e.find(".app-overlay-chat .app-overlay-loader").text(t)}function ee(e){return e?l.getTab(e):l.getCurrent()}function te(e,t,n){var i,o=[];e instanceof Array||(e=[e]),e.forEach((function(e){var t=e.owner||{},n=t.info||{},a=n.avatar||"";n.profile;i={nickname:t.nickname||"",avatar:a,mid:e.mid||"",flags:e.flags||{},text:e.text,clientId:t.id,nickname_image:t.info.nickname_image||"",my:e.my||!1,stopword:e.stopword||!1,owner:t},o.push(i)})),ie(o,t,n)}function ne(e,t,n){var i="1"===he("whiteMess")?"light":I,o=t&&t.info.font&&t.info.font[i]?t.info.font[i]:"",a=t&&t.info.font&&t.info.font.cls?t.info.font.cls:"";o&&($.extend(e[0].style,o),o.color&&e.addClass("custom-font-color")),a instanceof Array&&a.length>0&&(e.addClass(a.join(" ")),-1!==a.indexOf("app-text-anim")&&e.attr("data-text-anim-timeout",3e3))}function ie(t,n,i){i=i||{};var o,a=n&&"object"==typeof n?n:ee(n),r=function s(){return $("#app-chat-mess-tpl")}(),l=i.tag||"";i.history;a?(t instanceof Array||(t=[t]),t.forEach((function(e){("object"!=typeof e||e instanceof jQuery)&&(e={text:e});var t=r.clone().removeAttr("id"),n=e.avatar||"",i=e.nickname||"",s=e.my||!1,c=e.flags||{},d=(e.profile,e.text||""),u=e.clientId||"",p=e.owner||"";if("string"!=typeof d)try{d=d instanceof jQuery?d.outerHTML():d?d.toString():""}catch(e){error(e),d="неопределенное сообщение"}if(p&&p.info.uid&&ve(p.info.uid))return log("ignored, calcel mess draw"),!1;if(e.stopword&&he("stopListHide"))return log("stop word, cancel mess draw"),!1;var h=f.fire("mess:before",d,t);h.forEach((function(e){"string"==typeof e&&(d=e)})),d=bibil.SmilesLoader.replaceCodes(d,he("whiteMess")?"light":I,5),window.__smiles&&window.__smiles.replaceCodes&&(d=window.__smiles.replaceCodes(d,5)),t.removeClass("d-none"),ne(t.find(".nick span"),p),s&&t.addClass("my"),p&&p.info.uid||t.addClass("anonymous"),c&&"messup"in c&&t.addClass("highlight animated flash"),c&&"sticker"in c&&c.sticker&&(d+='<div class="sticker image text-center"><img src="'+c.sticker.url+'"></div>'),c&&"ad"in c&&t.addClass("ad animated bounce"),p.owner&&t.addClass("owner"),i?t.find(".nick .nick-to").text(i).data("nickname",i):t.find(".nick").addClass("d-none");var b=t.find(".text");if(b.html(d),D&&(head.browser.chrome||head.browser.ff),t.find(".text").find(".nick-to[data-client-id]").each((function(){var e=m.getById($(this).data("clientId"));e&&ne($(this),e)})),u&&(o=m.getById(u),o||(o=m.createUser(p)),t.find(".avatar img").attr("data-id",u).data("user",o),t.attr("data-id",u)),l){t.attr("data-tag",l);"friend"===l?(t.addClass("my"),bibil.Utils.tabVisible||fe()):t.prepend('<div class="col-auto mr-2 text-warning"><i class="fa fa-info-circle"></i></div>')}if(n?t.find(".avatar").find("img").attr("src",n):t.find(".avatar").addClass("d-none"),e.stopword&&t.addClass("stopword"),p&&p.info.mobile&&t.addClass("mobile"),e.mid&&(t.attr("data-mid",e.mid),y.moder)){var g=$('<div class="mess-actions">');g.append('<button class="remove btn btn-sm btn-secondary" data-title="Удалить сообщение"><i class="fa fa-remove"></i></button>'),t.append(g)}if(I){var w=t.find(".app-smile img");w.each((function(){var e=$(this).attr("data-url-"+I);e&&$(this).attr("src",e)}))}t.find(".text img").on("load",(function(){$(this).pparent(".attach ").length,a.autoScrollEnable()&&a.scrollEnd(v.delayMess)})),k?a.getMessages().prepend(t):a.getMessages().append(t),oe(t),f.fire("mess:after",t)})),function c(e){var t=v.autoCleanMessages||0;if(t){var n=e.getMessages().find(".mess-row"),i=n.length;i>t&&(k?n.slice(-(i-t)).remove():n.slice(0,i-t).remove(),e.autoScrollEnable()&&e.getMessages().scrollEnd(0))}}(a),a.autoScrollEnable()&&a.scrollEnd(v.delayMess),e.toggleClass("messages-overflowed",a.getMessages().isOverflow())):error("tab not found",n)}function oe(e){e||(e=o),e&&e.length?e.find(".sticker").each((function(){var e=$(this).find("img"),t=o.height(),n=t?bibil.percent(t,40,!0):0;n?e.css({maxHeight:n+"px"}):error("stickerHeight empty")})):error("parent empty")}function ae(e){m.update(e),l.getUsersList().update(e.id)}function re(e){if(f.updateUsersPending=new Date,!(e&&e instanceof Array))return!1;l.getUsersList().clear(),e.forEach((function(e){se(e)})),f.updateUsersPending=!1}function se(e){var t=m.add(e);return l.getUsersList().add(t),t}function le(){}function ce(t){y=t,t.info.avatar&&e.find(".self-avatar-wrap .avatar-loaded img").attr("src",t.info.avatar),e.toggleClass("moder",t.moder),"extended"in t.info&&G(t.info.extended),f.isModer=t.moder||!1,f.isOwner=t.owner||!1,f.selfClient=y}function de(){var e=$('<input type="text" class="form-control" name="password" autocomplete="off" value="" placeholder=""/>'),t=bibil.UI.win(e,{header:'<i class="fa fa-key" aria-hidden="true"></i> Ведите код доступа',centered:!0,modal:!0});t.btn('<i class="fa fa-unlock" aria-hidden="true"></i> Ввести код').on("click",(function(){var t=e.val();t.length>0?(C.password=t,Q(),bibil.fire("roomPassword",t)):bibil.UI.popupFixError("Вы должны ввести пароль")})),t.el().addClass("chat-password-prompt")}function ue(){if(e.find(".chat-join-dialog").length>0)return!1;var t={block:A,obj:"chat",opt:{room:p}},n=bibil.make(bibil.BlockAjax,null,t);n.on("open",(function(t){e.append(t);var n=t.find("form"),i=bibil.storage("chat_sex");t.addClass("chat-join-dialog"),i&&t.find("[name=sex][value="+i+"]").attr("checked",!0),n.on("form.before",(function(){n.FormAjax("loading",!0),C=$.extend({},C,n.formToObject()),C.sex&&G({sex:C.sex}),f.once("mess.error",(function(){n.FormAjax("loading",!1)})),Q()})),n.find(".app-uploader-wrapper").on("uploader.upload",(function(e,t){C.ava=t.sizes}))})),n.load()}function fe(){he("soundOff")||bibil.Utils.beep("mess")}function pe(e){i.insertAtCaret("#"+e+": ")}function he(e){if("object"!=typeof e){var t=null;try{t=JSON.parse(bibil.storage("chat_settings"))}catch(e){error(e)}"object"!=typeof t&&(t={});var n=$.extend({},x,t);return"string"==typeof e?n[e]:n}bibil.storage("chat_settings",JSON.stringify(e)),be()}function me(e){if(!i||!n)return!1;void 0===e||e?(i.attr("disabled","disabled"),n.attr("disabled","disabled"),f.inputLoading(!0)):(i.removeAttr("disabled","disabled"),n.removeAttr("disabled","disabled"),f.inputLoading(!1))}function be(){var t=he();e.toggleClass("show-tab-close","1"===t.show_tab_close),e.toggleClass("message-white-force","1"===t.whiteMess),e.toggleClass("images-off","1"===t.imagesOff),e.toggleClass("autoscroll-smart-off","1"===t.autoScrollSmartDisabled);var n,o=parseInt(t.font_size)||"",a=[e.find(".message-tab"),i];$.each(a,(function(e,t){t&&t.length>0&&(o&&o>100&&o<=200?t.css("fontSize",o+"%"):(n=t[0].style,"function"==typeof n.removeProperty?n.removeProperty("font-size"):n.hasOwnProperty("fontSize")&&(n.fontSize="")))}))}function ge(){return log("do not need anymore")}function ve(e){return S&&-1!==S.indexOf(e)}function ye(e){return e&&e.info.uid&&bibil.Friends&&bibil.Friends.getFriend&&bibil.Friends.getFriend(e.info.uid)}function we(){f.ws.auth((function(e){ce(e.client),function t(){var e=$.Deferred();j?function t(e){var t={block:j,obj:"chat",opt:{room:p}},n=bibil.make(bibil.BlockAjax,null,t);n.on("open",(function(e){})),n.on("remove",(function(){e.resolve()})),n.load()}(e):e.resolve();e.then((function(){A?ue():Q()}))}()}))}this.setWs(w),this.baseMess={room:p},this.setMessagesTop=function(t){k=t,e.toggleClass("messages-top",k)},this.floating=function(n){if(head.touch)return!1;e.toggleClass("floating",n),n?(e.draggable({handle:".chat-tabs-wrapper, .chat-bottom",cancel:"input,textarea,button,select,option,super-smiles",containment:t.containment||"html",drag:function(e,t){t.position.top>=0&&t.position.left>=0&&bibil.UI.savePosition("chatDimensions",{top:t.position.top,left:t.position.left})}}),e.resizable({handles:"n, e, s, w, se",resize:function(e,t){t.size.width>100&&t.size.height>100&&bibil.UI.savePosition("chatDimensions",{width:t.size.width,height:t.size.height}),oe()}}),bibil.UI.restorePosition("chatDimensions",e)):this.resizeableCancel()},this.resizeableCancel=function(){"function"==typeof e.draggable?(e.is(".ui-draggable")&&e.draggable("destroy"),e.is(".ui-resizable")&&e.resizable("destroy"),e.css({left:"auto",top:"auto",width:"",height:""})):error("chat is not floating")},this.ignore=function(e){e.info.uid&&y.info.uid?bibil.Api.request("ignoreToggle",{uid:e.info.uid}).then((function(e){})).catch((function(e){bibil.UI.error(e)})):f.send("ignore",{clientId:e.id})},L.prototype=new Bibil.Base,this.inputLoading=function(t){e.find(".loader-input").toggleClass("d-none",!t)},this.toggleFull=function(){e.toggleClass("spacious"),f.spacious=e.hasClass("spacious")},this.onlyTabs=function(t){e.toggleClass("only-tabs",t),f.isOnlyTabs=t},this.init=function(){J(),W(),this.addMessHandler(U),this.ws.on("close",(function(){Z()})),_&&ge()},this.testManyMess=function(e){if(this.testManyMessTimer&&!e)return clearTimeout(this.testManyMessTimer),this.testManyMessTimer=null,!1;this.testManyMessTimer=setTimeout((function(){ie(Math.random()),f.testManyMess(!0)}),100)},this.baned=function(){e.addClass("banned")},this.isConf=function(){return!!t.conf},this.init(),this.notifyManager=c,this.redraw=le,this.testOpenPrivate=function Ce(e){var t=m.getAll(),n=0;t.forEach((function(t,i){n++,n>e||setTimeout((function(){R(i)}),5e3*Math.random())}))},this.el=e,this.tabsManager=l,this.userManager=m,this.roomInfo=u,this.setting=he,this.usersListManager=d,this.isModer=!1,this.isOwner=!1,this.selfClient=null,this.insertText=function $e(e){i.insertAtCaret(e)},this.service=function ke(e,t){T.push({name:e,params:t||!0})},this.submit=Y,this.openPrivat=R,this.privateRequest=H,this.privateAccepted=N,this.closePrivate=function xe(e){var t=l.getTab(e);t&&l.closeTab(t.id)},this.isOnlyTabs=!1,this.updateUsersPending=!1,v.plugins instanceof Array&&v.plugins.length>0?bibil.require(v.plugins,(function(){v.plugins.forEach((function(e){b[e]=new bibil[e],b[e].init.call(f,v)})),we()})):we()}return Chat.defaults=$.extend({delayMess:1500,delayPopover:1e3,privateAutoOpen:!1,autoCleanMessages:50,plugins:["ChatFilter","ChatMessParser"],settings:{show_tab_close:"1",whiteMess:"0",imagesOff:"0"}},bibil.sett("chat")),Chat.prototype=new bibil.Ws.BaseMessaging,$.fn.Chat=bibil.registerJqueryPlugin(Chat),Chat}),["Daemon","Smiles","Utils"]),bibil.module("ChatAPI",(function(){function ChatAPI(el,options){var __self=this,jsonViaual=bibil.make(bibil.JSONVisual),meta={clients:{cols:{nickname:"nickname",id:"ClientID",ip:"IP"},id:"id"},rooms:{cols:{alias:"Alias",name:"Name",clientsCount:"Count"}},videosocket:{cols:{id:"ID",active:"Active",created:"Created",offer:"Звонильщик",receiver:"Принимальщик"},id:"id"}};function Handler(){this.extended=function(e){var t=$(".data-extended-info[data-type="+e.type+"][data-id="+e.id+"]");t.length>0&&t.html(jsonViaual.transform(e.data))}}function api(e,t){__self.send("manage",{cmd:e,options:t})}function init(e){__self.setWs(new bibil.Ws({uri:options.uri})),__self.ws.on("message",(function(e,t){el.find("[data-tab]").each((function(n,i){var o=$(i).data("tab");o===e&&renderTab(i,t)}))})),__self.addMessHandler(Handler),__self.ws.on("close",(function(){})),__self.ws.auth((function(e){parseTabs()})),__self.connect()}function events(){var formCmdSend=el.find("#cmdSend"),formBenchmark=el.find("#benchmark");el.find("[data-tab]").on("click",".refresh",(function(){var e=$(this).parents(".card:first");e.trigger("app.chatapi.update")})),el.find("[data-tab]").on("keyup","input[name]",(function(e){var t=$(this).parents(".card:first");"Enter"===e.key&&t.trigger("app.chatapi.update")})),el.find("[data-tab]").on("app.chatapi.update",(function(){var e=$(this).data("cmd"),t=$(this).find("[name]"),n={};t.each((function(){var e=$(this),t=e.attr("name");n[t]=e.val()})),api(e,n)})),el.on("click","[data-extended-info]",(function(){var e,t=$(this),n='<div style="max-height: 600px; overflow: auto" class="data-extended-info" data-type="'+t.data("type")+'" data-id="'+t.data("extendedInfo")+'"></div>',i=$('<button type="button" class="ml-3 refresh btn btn-secondary float-right btn-sm"><i class="fa fa-refresh" aria-hidden="true"></i></button>'),o={id:t.data("extendedInfo"),type:t.data("type")};e=bibil.UI.modal(n),i.on("click",(function(){api("extended",o)})),e.find(".modal-header").addClass("justify-content-start").append(i),api("extended",o)})),formCmdSend.ajaxForm({url:"#",beforeSend:function(xhr,form,fields){var options=formCmdSend.formToObject(),optionsCmd=formCmdSend.find("[name=options]").val();return __self.send(options.cmd,optionsCmd?eval("g = "+optionsCmd):{}),formCmdSend.find(".result").val("Команда "+options.cmd+" послана"),!1},success:function(){}}),formBenchmark.ajaxForm({url:"#",beforeSend:function(xhr,form,fields){var options=formBenchmark.formToObject(),optionsCmd=formBenchmark.find("[name=options]").val(),data=optionsCmd?eval("g = "+optionsCmd):{};return api("benchmark",$.extend(options,{data:data})),formCmdSend.find(".result").val("Команда "+options.cmd+" послана"),!1}})}function renderTab(e,t){var n,i,o=$(e).find(".card-body"),a=$(e).data();t instanceof Array?($(e).find(".count").html(t.length),n=new Table(a.cmd),t.forEach((function(e){n.add(e)})),i=n.getEl()):i=jsonViaual.transform(t),o.html(i)}function Table(e){var t,n=$('<table class="table"><thead><tr></tr></thead><tbody></tbody></table>'),i=meta[e]&&meta[e].cols?meta[e].cols:null;if(this.getEl=function(){return n},i)for(t in i)n.find("thead tr").append("<th>"+i[t]+"</th>");this.add=function(o){var a,r=$("<tr></tr>"),s=i||o,l=0,c=(meta[e]?meta[e].id:"")||"id";for(t in s)a=bibil.escapeHtml(o[t]),"object"==typeof a&&(a=a.info&&void 0!==a.info.uid?a.info.uid?a.info.nickname:a.nickname:"obj"),i&&!(t in i)||(0===l&&(a='<span class="app-link" data-type="'+e+'" data-extended-info="'+(c?o[c]:0)+'">'+a+"</span>"),l++,r.append("<td>"+a+"</td>"));n.find("tbody").append(r)}}function parseTabs(){el.find("[data-tab]").each((function(e,t){var n=$(t),i=n.data("tab"),o=$('<button type="button" class="refresh btn btn-secondary float-right btn-sm"><i class="fa fa-refresh" aria-hidden="true"></i></button>');n.data("cmd")||(n.data("cmd",i),n.find(".card-header").append(o)),n.trigger("app.chatapi.update")}))}init(options),events()}return ChatAPI.defaults={},ChatAPI.prototype=new bibil.Ws.BaseMessaging,ChatAPI}),["Ws","JSONVisual"]),bibil.module("ChatFilter",(function(){return function ChatFilter(){var e,t,n,i,o,a,r,s,l=this;function c(){t=e.find(".chat-users-options");var c=e.find("[data-template-users-option]");bibil.Template.make({data:l,mounted:function(){t=$(this.$el),n=e.find(".filter-wrapper"),r=e.find(".settings-wrapper"),i=n.find("form"),s=r.find("form"),t.find("img.loader").on("mouseenter, mouseleave, mousemove",(function(e){$(this).addClass("invisible ")})),function c(){i.on("form.before",(function(){var e=$(this),t=d();a=e.formToObject(),l.filter(t.find(">.user"),"form")})),s.on("form.before",(function(){var e=$(this).formToObject();o.setting(e)})),i.find("select, input").on("change",(function(){log("form.change"),i.submit()})),s.find("select, input").on("change",(function(){s.submit()})),i.find("input").on("input",(function(){log("form.keyup"),i.submit()})),o.tabsManager.getUsersList().on("add",(function(e){l.filterEnabled&&l.filter(e,"add")})),o.tabsManager.getUsersList().on("update",(function(e){l.filterEnabled&&l.filter(e,"update")}))}()},computed:{},watch:{opened:function(e,t){t||o.usersListManager.toggleList(!1)}}},c)}function d(){var e=o.tabsManager.getUsersList();return e.getList()}function u(e){return e.toLowerCase().trim()}this.opened=!1,this.openedSettings=!1,this.filterEnabled=!1,this.sound=!0,this.spacious=!1,this.salt=bibil.makeid(5),this.toggleFull=function(){o.toggleFull(),l.spacious=o.spacious},this.soundToggle=function(){this.sound=!this.sound},this.closeFilter=function(){l.opened=!1},this.closeSettings=function(){l.openedSettings=!1},this.openSettings=function(){l.openedSettings=!0,s.formAssign(o.setting())},this.toggleSmiles=function(){e.toggleClass("smiles-hidden")},this.toggleExtended=function(){e.toggleClass("extended-hidden")},this.resetFilter=function(){d().find(">.user").removeAttr("filtered-hidden"),i[0].reset(),a=null,this.enableFilter(!1),this.opened=!1,i.find("select.app-select").SelectCustom("reset")},this.enableFilter=function(t){e.toggleClass("filter-on",t),this.filterEnabled=t},this.setFilterOptions=function(e){a||(a={}),a=$.extend(a,e)},this.filter=function(e,t){if(!a)return log("filter empty, cancel"),!1;var n=o.userManager,i=!0,r=!1;log(t),e.each((function(e,o){var s,l,c=$(o),d=c.data("id"),f=n.getById(d),p=!1,h=bibil.sett("userInfoFields");if(f){l=f.info||{},s=l.extended||{};var m=parseInt(l.age)||0,b=parseInt(s.tits)||null,g=parseInt(s.cock)||null,v=l.status||"",y=u(l.statusText||""),w=u(s.text||""),C=u(l.nickname||""),k=u(a.__query&&a.__query.length>0?a.__query:"");$.each(a,(function(e,t){t&&(-1!==$.inArray(e,h)?e in s?t instanceof Array?s[e]instanceof Array?s[e].includesArray(t)||(p=!0):-1===$.inArray(s[e],t)&&(p=!0):s[e]&&t===s[e]||(p=!0):p=!0:(!a.age_from||m&&m>=parseInt(a.age_from)||(p=!0),!a.age_to||m&&m<=parseInt(a.age_to)||(p=!0),a._tits&&(null!==b&&("small"!==a._tits||b<=2)&&("big"!==a._tits||b>=3&&b<=5)&&("bigger"!==a._tits||b>5)||(p=!0)),a._cock&&(null!==g&&("small"!==a._cock||g<=13)&&("normal"!==a._cock||g>=13&&b<=16)&&("big"!==a._cock||g>=16&&b<=20)&&("bigger"!==a._cock||g>20)||(p=!0)),a._status&&a._status!==v&&(p=!0),k&&-1===C.indexOf(k)&&-1===w.indexOf(k)&&-1===y.indexOf(k)&&(p=!0)),i=!1)})),p?c.attr("filtered-hidden","on"):(r=!0,c.removeAttr("filtered-hidden"),"add"!==t&&"update"!==t||c.mark("shake"))}else error(d+" not found")})),"search"!==t&&this.enableFilter(!i),r&&this.sound&&("add"===t||"update"===t)&&bibil.Utils.beep("filter")},this.init=function(t){o=this,e=o.el,l.spacious=o.spacious,c()}}}),[]),bibil.module("ChatMessParser",(function(){return function ChatMessParser(){var e,t=new function n(){this.speech=function(t){if(t.match(/^\/upload\//))return'<button class="btn btn-secondary btn-sm app-playable" data-autoplay="'+(e.setting("soundOff"),'0" data-url="')+t+'"><i class="fa fa-play"></i></button>'}};this.handler=function(){},this.init=function(n){e=this,e.on("send:before",(function(t){var n,i=$.Deferred(),o=t.text||"",a=o.match(/!сказать(.+)/);return a?(n=a[1],bibil.Api.request("speech",{text:n,room_id:e.room}).then((function(e){e.res&&e.res.url&&(t.text=t.text.replace(a[0],"[speech]"+e.res.url+"[/speech]")),i.resolve()})).catch((function(e){i.reject(e)})),i):""})),e.on("send:before",(function(t){var n=$.Deferred(),i=t.text||"",o=i.match(/https?\:\/\/.+\.(jpg|gif|jpeg|png)/i);if(o){var a=o[0];return bibil.Api.action("picsDownload","chat_room","",{link:a,room_id:e.room}).then((function(e){e.res&&e.res.files&&(t.images=e.res.files,t.text=t.text.replace(a,"")),n.resolve()})).catch((function(e){n.reject(e)})),n}return""})),e.on("send:before",(function(t){var n=$.Deferred(),i=t.text||"",o=i.match(/^!!([а-яa-z\_\s]+)/i);if(o){i=o[1];return i.length>50?"":(bibil.Api.action("wiki","chat_room","",{text:i,room_id:e.room}).then((function(e){e.res&&e.res.text&&(t.text=t.text+"\n"+e.res.text),n.resolve()})).catch((function(e){n.reject(e)})),n)}return""})),e.on("send:before",(function(t){if(!e.isModer)return!1;var n=$.Deferred(),i=t.text||"",o=bibil.sett("videolinkrg"),a=bibil.sett("videolinkrgm");if(!o)return"";var r=new RegExp(o,a||""),s=i.match(r);if(s){var l=s[0];return bibil.Api.action("videoPlay","chat_room","",{url:l,room_id:e.room}).then((function(e){e.res&&e.res.title&&(t.text+="\n"+e.res.title),n.resolve()})).catch((function(e){n.reject(e)})),n}return""})),e.on("mess:before",(function(e,n){for(var i,o,a,r,s=["speech"],l=new RegExp("\\[("+s.join("|")+")\\]([^\\]\\[]+)\\[\\/("+s.join("|")+")\\]","g"),c=e;i=l.exec(e);)o=i[1],r=i[2],a=void 0,"function"==typeof t[o]&&(a=t[o](r)),void 0!==a&&(c=c.replace(i[0],a));return c}))}}}),[]),bibil.module("ColorPicker",(function(){function ColorPicker(e,t){e.spectrum($.extend({preferredFormat:"hex"},t))}return $.fn.ColorPicker=bibil.registerJqueryPlugin(ColorPicker),ColorPicker}),[]),bibil.module("Comments",(function(){function Comments(e,t){var n=this,i=t.obj,o=t.objId,a=e.find(".app-comments-out"),r=t.withTrashed,s=0,l="new",c=t.treeOpen||[];function d(t){var i=$.Deferred();if("object"!=typeof t&&(t=function o(t){return e.find("[data-comment-id='"+t+"']")}(t)),0===t.length)return error("comment not found",t),i.reject("Комментарий не найден"),i;var a=t.find("> .col-right > .bottom-reply .children-toggle"),r=(a.find(".fa"),t.data("commentId")),s=t.find("> .col-right > .childrens");return t.hasClass("childrens-loaded")?(t.toggleClass("childrens-open"),i.resolve(),i):(t.addClass("childrens-open").addClass("childrens-loaded"),n.load(r).then((function(e){s.html(e),i.resolve()})).catch((function(){i.reject()})),i)}this.load=function(e,t){var n=$.Deferred();return t||(t={}),t=$.extend(t,{order:l,page:s,pid:e||"",obj_id:o,obj:i,withTrashed:r?1:0}),bibil.Api.request("CommentsHTML",t).then((function(e){n.resolve(e.res.comments)})).catch((function(e){bibil.UI.popupFixError(e),n.reject()})),n},this.update=function(e){a.prepend('<span class="animated headShake infinite badge badge-success" >упс упс</span>'),n.load(0,e).then((function(e){a.html(e)})).catch((function(){}))},function u(){e.parents('[data-block="comments_ajax"]:first'),e.on("click",".children-toggle",(function(){var e=$(this).pparent(".comment-tree");d(e)})),e.on("form.success",".app-form-wrapper form",(function(e,t){var n=$(this),i=n.pparent(".comment-tree");if(0===i.length)a.prepend(t.html);else{var o=i.find("> .col-right > .childrens");i.hasClass("childrens-loaded")?o.prepend(t.html):(i.addClass("childrens-open").addClass("childrens-loaded"),o.html(t.html)),n.pparent(".reply-form").removeClass("show")}n.FormAjax("reset")})),e.on("change",".comments-trashed",(function(){r=$(this).is(":checked"),n.update()})),e.on("click",".pagination a.page-link",(function(){var e=$(this).attr("href"),t=!!e&&e.match(/page=(\d+)/);return t&&(s=t[1],n.update()),!1})),e.on("click",".comments-order .btn",(function(){return $(this).siblings(".btn").removeClass("active"),$(this).addClass("active"),l=$(this).data("order"),n.update({}),!1})),e.on("click",".comments-all",(function(){return n.update({}),$(this).remove(),!1}))}(),c.length>0&&function e(t){var n=t.shift();n&&d(n).then((function(){e(t)}))}(c)}return $.fn.Comments=bibil.registerJqueryPlugin(Comments),Comments}),[]),bibil.module("Content",(function(){function Content(e){var t=e.find("form"),n=e.find(".app-uploader-wrapper"),i=t.find("textarea.editing"),o=e.find(".app-content-html");function a(){o.html(i.val())}e.find(".actions .edit").on("change",(function(){var t=$(this).is(":checked");e.toggleClass("editing",t)})),e.find("form.ajax").on("form.success",(function(e,n){bibil.UI.popupFix("Сохранено"),n&&n.id&&(t.find("[name=alias]").val(n.alias),t.find("[name=id]").val(n.id))})),i.on("input",(function(){a()})),i.trumbowyg({semantic:!1,removeformatPasted:!0,pasteHandlers:[function(e){var t=e.originalEvent&&e.originalEvent.clipboardData?e.originalEvent.clipboardData:"";t&&n.length>0&&bibil.UI.uploadClipboard(t,n)}]}).on("tbwchange",(function(){a()})),n.length>0&&n.on("uploader.upload",(function(e,t){prompt("Вставить?",t._orig)&&i.trumbowyg("execCmd",{cmd:"insertHTML",param:'<a data-fancybox  href="'+t._orig+'"><img src="'+t.big+'"/></a>'})}))}return $.fn.Content=bibil.registerJqueryPlugin(Content),Content}),[]),bibil.module("Editor",(function(){function Editor(e,t){var n=e.find("form.ajax"),i=n.find("textarea.editing"),o=e.find(".publish-button");n.on("form.success",(function(t,o){bibil.UI.popupFix(o.saveText),o&&o.id&&(n.find("[name=post_id]").val(o.id),i.trumbowyg("html",o.text),i.trumbowyg("semanticCode",!0,!1),i.val(o.text),e.removeClass("notedited").removeClass("empty").removeClass("published"))})).on("form.before",(function(){})),n.getModule("FormAjax",(function(e){e.before((function(){var e=new $.Deferred,t=i.data("trumbowyg");return t.semanticCode(!0,!0),setTimeout((function(){e.resolve()}),1),e}))})),window.onunload=function(){},window.onbeforeunload=function(){var e=i.trumbowyg("html");if(e.length>2)return"Закрыть вкладку?"},o.on("action.submit",(function(){e.addClass("published").addClass("notedited")})),setInterval((function(){}),1e4),i.trumbowyg({lang:"ru",btns:[["viewHTML"],["strong","em"],["unorderedList","orderedList"],["p","h3","blockquote"],["link"],["upload","user","stream","video"],["emoji"],["horizontalRule2"],["removeformat"],["undo","redo"],["fullscreen"]],semantic:!0,removeformatPasted:!0,uploader:t.uploader})}return $.fn.Editor=bibil.registerJqueryPlugin(Editor),Editor}),[]),bibil.module("Daemon",(function(){function Daemon(){var e,t,n=this;function i(){this.joined=function(){},this.serviceAlert=function(e){bibil.UI.popupFix(e.text,{type:"warning",autoHide:!1})},this.serverShutdown=function(){bibil.Utils.beep("shutdown"),bibil.UI.popupFix("Чат был перезагружен в целях обслуживания",{type:"warning",autoHide:1e4})},this.alertNotify=function(e){bibil.runOnceTab((function(){bibil.Notify.notify({title:e.title,body:e.body,tag:"mess_notify",link:e.link||""})}),"mess_notify")},this.notify=function(){bibil.Utils.beepOnce();var e=$(".app-notifications");e.length>0&&e.Notifications("update")},this.doskaUpdate=function(e){var t=$(".app-doska");if(t.length>0&&"function"==typeof t.Doska){var n=1e3*bibil.rand(1,20);log("doska update",n),setTimeout((function(){bibil.Utils.beepOnce("doska"),t.Doska("update",e.id)}),n)}},this.mess=function(e){$(".app-message-modal");var t=$(".app-new-message-alert"),n=t.find(".fa"),i=e.tag,o=e.notifyBody||"Новое сообщение",a=t.find(".unread"),r=t.data("uids")||[];if(r.removeObjects((function(t){return t.from===e.from})),r.push({from:e.from,tag:i}),t.data("uids",r),t.addClass("has-new"),!0===e.videocall?n.removeClass("fa-envelope").addClass("fa-video-camera"):n.addClass("fa-envelope").removeClass("fa-video-camera"),a.text(parseInt(a.text())+1),bibil.UI.titleInactive(o),bibil.Messages){var s=bibil.Messages.getWin(e.from,"support"===i);if(s&&(s.append(e.html),e.mess_id&&bibil.Api.request("messMarkRead",{id:e.mess_id,tag:i})),!s||!s.isFront()){var l="support"===i?"support":!0===e.videocall?"videoCall":"mess";bibil.runOnceTab((function(){bibil.Notify.notify({title:e.nickname,body:o,tag:"mess_user",sound:l})}),"mess_user")}}},this.streamsUpdate=function(e){app&&app.onUpdateStreams&&app.onUpdateStreams(e)},this.banedAlert=function(e){var t=e.warning||!1,n=e.comment||"",i=e.text||"",o=e.rule||"",a=e.moderLink||"",r="";if(r+=t?'<div class="text-center alert alert-warning"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>'+i+"</strong></div>":'<div class="text-center alert alert-danger"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> <strong>'+i+"</strong></div>",n&&(r+='<div class="alert alert-warning">Сообщение от модератора:<br/><strong>'+n+"</strong></div>"),o&&(r+='<div class="alert alert-warning"><i class="fa fa-book"></i> Пункт правил: <strong>'+o+'</strong> <a href="/page/rules">Правила</a></div>'),!t&&e.allChats){var s=$(".app-chat");s.length>0&&s.Chat("baned")}a&&(r+='<div class="alert alert-secondary"><i class="fa fa-info-circle"></i> Если вы не согласны <strong>напишите модератору </strong> '+a+' или в  <a target="_blank" href="/support">поддержку</a> </div>'),bibil.UI.alert(r,{header:"Нарушение правил",modal:!0,ok:"Понятно",type:"normal"})},this.alertModal=function(e){bibil.UI.alert(e.text||"Сервисное сообщение",{header:e.header||"Сервисное сообщение",modal:void 0===e.modal||e.modal,icon:"fa fa-info-circle text-warning",type:e.type||"normal"})},this.moderUpdate=function(e){e.moderated||bibil.Utils.beepOnce("moder"),$(".lenta-tracker-fixed .app-list-ajax").each((function(){var e=$(this);setTimeout((function(){e.ListAjax("refresh")}),1e3*bibil.rand(1,5))}))}}this.messagesreadMark=function(e){var t,n=$(".app-new-message-alert"),i=n.data("uids");if(i instanceof Array&&i.length>0){var o=i.pop();if(o&&bibil.Messages&&e){var a="object"==typeof o?o.from:o,r="object"==typeof o&&"support"===o.tag;t=bibil.Messages.openDialog(a,r),t.isOpened()}0===i.length&&(n.removeClass("has-new"),n.find(".unread").text("0")),n.data("uids",i)}},bibil.broadcast("messagesreadMark",(function(e){n.messagesreadMark()})),this.init=function(n){e=$.extend({},n,Daemon.defaults),t=new bibil.Ws({uri:e.uri}),this.setWs(t),t.handler(new i),t.handler(new bibil.Ws.MessageHandlerDefault),t.start((function(){}))},this.init()}var e=bibil.sett("daemon");return Daemon.defaults={uri:e?e.uri:""},Daemon.prototype=new bibil.Ws.BaseMessaging,new Daemon}),["Ws"]),bibil.module("Devices",(function(){function e(e){this.info=e,this.id=e.deviceId,this.type=e.kind,this.error=!e.label,Object.defineProperty(this,"name",{get:function(){return e.label||this.id}})}return new function Devices(t,n){var i=this;this.errorDefault="Не удалось определить ваши устройства. Разрешите сайту доступ к вашей камере и микрофону",this.devices=function(e,t){var n=new $.Deferred;return navigator.mediaDevices?(!e&&head.browser.ff&&(e={audio:!0,video:!0}),e?(i.streamCurrent&&(log("streamCurrent",i.streamCurrent),i.streamCurrent.getTracks().forEach((function(e){error("remove track from stream",e),e.stop()}))),navigator.mediaDevices.getUserMedia(e).then((function(e){i.streamCurrent=e,i._devices(t).then((function(t){n.resolve(t,e)})).catch((function(e){n.reject(e)}))})).catch((function(t){error("getUserMedia error",e),n.reject(t)})),n):this._devices(t)):(n.reject("Ваш браузер не поддерживает mediaDevices"),n)},this._devices=function(t){var n=new $.Deferred;return t||(t={}),navigator.mediaDevices.enumerateDevices().then((function(i){n.resolve(function o(t,n){n||(n={});for(var i={all:new Map,indexOf:function(e,t){t=this[t||"all"];var n=[];return t&&t instanceof Map?(t.forEach((function(e){n.push(e.id)})),n.indexOf(e)):(error("list undefined or not Map",t),-1)}},o=0;o!==t.length;++o){var a=t[o],r=a.kind;void 0===i[r]&&(i[r]=new Map);var s=new e(a);i[r].set(a.deviceId,s),i.all.set(a.deviceId,s)}return i}(i,t))})).catch((function(e){!function t(e){error(e)}(e),log(i.errorDefault),n.reject(i.errorDefault)})),n},this.getAudioCTX=function(){return this.audioCtx||(this.audioCtx=window.AudioContext||window.webkitAudioContext?new(window.AudioContext||window.webkitAudioContext):null),this.audioCtx},this.getLocalStream=function(e){var t,n=new $.Deferred;return e||(e={}),t={},e.video&&(t.video={deviceId:{exact:e.video.id}}),e.audio&&(t.audio={deviceId:{exact:e.audio.id}}),navigator.mediaDevices.getUserMedia(t).then((function(e){n.resolve(e)})).catch((function(e){n.reject(e)})),n},this.attachStream=function(e,t){try{t.srcObject=e}catch(e){}},this.StreamDriver=function(){var e=this;this.intervals=[],this.timeouts=[],this.init=function(){},this.start=function(){},this.stop=function(){},this.micLevel=function(e){},this.streamOptions=function(e){},this.setCamera=function(){},this.resize=function(){},this.setMic=function(){},this.destroy=function(){},this.removeTimers=function(){this.intervals.forEach((function(t,n){clearInterval(t),delete e.intervals[n]})),this.timeouts.forEach((function(t,n){clearTimeout(t),delete e.timeouts[n]}))},this.addInterval=function(e,t){this.intervals.push(setInterval(e,t))},this.addTimeout=function(e,t){this.timeouts.push(setTimeout(e,t))}},this.PlayerDriver=function(){this.init=function(){}},this.StreamDriver.prototype=new Bibil.Base,this.PlayerDriver.prototype=new Bibil.Base}}),[]),bibil.module("Doska",(function(){function Doska(e,t){var n=!1,i=this,o={block:t.templ||"doska.items",obj:"doska",opt:{slider:t.slider||!1,route:t.route}};e.on("click",".close-doska",(function(){r(),setTimeout((function(){r(),i.update()}),6e4*(head.mobile?5:3))}));var a=bibil.make(bibil.BlockAjax,e,o);function r(t){if(!e.hasClass("doska-closed")){var n=new Date;n.setTime(6e5+n.getTime()),bibil.setCookie("doska_closed",(new Date).getTime(),n)}e.toggleClass("doska-closed")}function s(){window.innerHeight<1e3&&setTimeout((function(){e.find(".close-col").removeClass("d-none")}),3e3)}a.on("load",(function(t){t.res.empty||e.removeClass("empty"),s()})),a.on("open",(function(t){var n=e.find(".doska-items");setTimeout((function(){e.find(".doska-wrapper").isOverflow()?(e.addClass("overflow"),e.find(".slide-next").removeClass("d-none")):e.removeClass("overflow"),n.scrollLeft(0)}),1e3),new Date})),e.hasClass("line")&&(e.on("mousedown touchstart",".slide-next, .slide-prev",(function(){var t=$(this);n=!1,function i(){n||function o(t,i,a){var r=$.Deferred(),s=e.find(".doska-wrapper"),l=0,c=s[0].scrollLeft;l=t?c+i:c-i;return s.stop(),s.animate({scrollLeft:l},{easing:"linear",duration:a,step:function(){c=s[0].scrollLeft,e.toggleClass("scroll-ended",s.iScrollEnd()),c<=0?e.find(".slide-prev").addClass("d-none"):e.find(".slide-prev").removeClass("d-none")},always:function(){c=s[0].scrollLeft,(s.iScrollEnd()||c<=0)&&(n=!0),r.resolve()}}),r}(t.hasClass("slide-next"),100,200).then((function(){i()}))}()})),e.on("mouseup touchend",".slide-next, .slide-prev",(function(){log("mouseDOWN"),n=!0,e.find(".doska-wrapper").stop()}))),this.update=function(t){a.reload({id:t}),e.removeClass("doska-closed")},e.find(".doska-items").length>0&&s()}return $.fn.Doska=bibil.registerJqueryPlugin(Doska),Doska})),bibil.module("FormAjax",(function(){function FormAjax(e,t){t=t||{};var n,i,o=this,a=e.parents(".app-form-wrapper:first"),r=a.find(".output:first"),s=t.result?$(t.result):null,l=e.parents(".modal:first"),c=e.attr("action"),d=t.closeModalOnSuccess||!1,u="features"in t?t.features:[];function f(e,t){t||(t="app-loading"),e?a.addClass(t):a.removeClass(t)}function p(e,t){var n="success"==t?"fa-check":"fa-exclamation-circle";e instanceof Array||(e=[e]),e.forEach((function(e){r.append('<div class="alert alert-'+t+'"><i class="fa '+n+'" aria-hidden="true"></i> '+e+" </div>")}))}function h(e){var t=e.target,n=$(t);if(!n.is("[type=submit],[type=image]")){var i=n.closest("[type=submit]");if(0===i.length)return;t=i[0]}var o=t.form;if(o.clk=t,"image"===t.type)if(void 0!==e.offsetX)o.clk_x=e.offsetX,o.clk_y=e.offsetY;else if("function"==typeof $.fn.offset){var a=n.offset();o.clk_x=e.pageX-a.left,o.clk_y=e.pageY-a.top}else o.clk_x=e.pageX-t.offsetLeft,o.clk_y=e.pageY-t.offsetTop;setTimeout((function(){o.clk=o.clk_x=o.clk_y=null}),100)}function m(e){n=new bibil.Api(e),o.api=n,t.finish&&t.finish.call(o),n.errors.length>0?(o.error=n.errors.join("\n"),t.error&&t.error.call(o,n.errors,n.result)):t.success&&t.success.call(o,n.success,n.result)}i=e.find(".app-uploader-wrapper"),t=$.extend({doRespons:function(){f(!0)},success:function(n,o){n&&"string"==typeof n&&p(n,"success"),t.save||(e.addClass("d-none"),l.length>0&&l.find(".submit-trigger").attr("disabled","disabled")),$.inArray("comp.uploader",u)&&i.length>0&&i.data("Uploader")&&i.data("Uploader").resetUI(),o&&s&&s.length>0&&s.html(o),e.trigger("form.success",o),d&&l&&l.modal("hide")},error:function(e){e||(e="Какая-то ошибка..."),e&&p(e,"danger")},finish:function(){f(!1),r.html(""),e.trigger("form.complete")},save:!1},t),this.reset=function(){e[0].reset()},function b(){var n={type:"post",dataType:"json",beforeSubmit:function(){if(e.trigger("form.before"),"#"===c)return!1;!function n(){t.doRespons&&t.doRespons()}()},success:function(e){m(e)},error:function(e,t){m(t)}};e.on("submit.form-plugin",(function(e){var t=$(this);return"function"==typeof o.beforePromise?(f(!0),f(!0,"form-before-send"),o.beforePromise().then((function(){t.ajaxSubmit(n)})).catch((function(){f(!1)})).always((function(){f(!1,"form-before-send")}))):t.ajaxSubmit(n),!1})).on("click.form-plugin",n,h)}(),this.before=function(e){this.beforePromise=e},e.data("FormAjax",this),f(!1),this.error="",this.api=n,this.beforePromise=null,this.loading=f}return $.fn.FormAjax=bibil.registerJqueryPlugin(FormAjax),FormAjax})),bibil.module("Friends",(function(){function Friends(e,t){var n,i=bibil.Daemon,o=new Map;function a(e){var t=e.uid;o.has(t)?(log("friend update"),function n(e,t){o.has(e)?o.get(e)._update(t):error("friend not found in list")}(t,e)):(log("friend add"),o.set(t,new r(e)))}function r(e){var t=bibil.Template.renderEl("tpl-friend-item",{data:e});n&&n.length>0?n.append(t):error("friends list not defined"),this._update=function(t){for(var n in t)e[n]=t[n]}}Friends.friendsList=o,function s(){n=e.find(".app-friends-list"),n.addDomListener().on("app.dom.inert app.dom.remove",(function(){var t=n.find(".friend-item").length;e.toggleClass("empty",!t)}))}(),i.addMessHandler((function l(){this.friend=function(e){if(e.online){var t=e.client;a(e),bibil.Utils.beepOnce("online",.2),bibil.UI.popupLeft(t.nickname+" в сети",{icon:t.info.avatar||"",autoHide:1e4,type:"light"})}else!function i(e){n.find("[data-uid="+e+"]").remove(),o.delete(e)}(e.uid)}})),i.getWs().auth((function(e){e.friends&&function t(e){e.forEach((function(e){a(e)}))}(e.friends)}))}return Friends.getFriend=function(e){return Friends.friendsList?Friends.friendsList.get(e):null},$.fn.Friends=bibil.registerJqueryPlugin(Friends),Friends})),bibil.module("Grid",(function(){return function Grid(e){e=$.extend({},e);var t=e.id,n=$("#"+t),i=e.fields||[],o=e.obj||"",a=e.urlBase||"/api/grid",r=e.token;i.push({type:"control"}),i.push({type:"photo"});var s=function(e){jsGrid.Field.call(this,e)};function l(e,t){var n={},s="action"in t?t.action:"";return"edit"!==s&&"insert"!==s&&"delete"!==s||(n.id=t.fields.id,i.forEach((function(e,i){var o=t.fields[e.name];e.readOnly||("checkbox"===e.type&&(o=o?1:0),n[e.name]=o)}))),t.data=$.extend({fields:n,action:s,obj:o,_token:r},t.data),t=$.extend({dataType:"json",method:"post",url:a,error:function(t,n,i){alert(i),e.reject()},success:function(t,n){var i=new bibil.Api(t);i.errors.length>0?(alert(i.errors.join("\n")),e.reject()):e.resolve(i.result)}},t),$.ajax(t)}s.prototype=new jsGrid.Field({css:"date-field",align:"center",myCustomProperty:"photo",itemTemplate:function(e,t){return $('<button class="btn btn-info" data-block="dialog.images" data-opt=\'{"obj": "'+o+'", "obj_id": "'+t.id+"\" }'>Фото</button>")}}),jsGrid.fields.photo=s,jsGrid.ControlField.prototype.width="100",function c(){n.jsGrid({fields:i,width:"100%",height:"auto",inserting:!0,editing:!0,sorting:!0,paging:!0,pageLoading:!0,pageSize:30,heading:!0,filtering:!0,noDataContent:"ничего не найдено",deleteConfirm:"Удалить позицию?",controller:{loadData:function(e){var t=$.Deferred(),n={};return i.forEach((function(t){t.name in e&&e[t.name]&&(n[t.name]=e[t.name])})),l(t,{action:"load",data:{pageIndex:e.pageIndex||1,pageSize:e.pageSize||0,filter:n}}),t.promise()},insertItem:function(e){var t=$.Deferred();return l(t,{fields:e,action:"insert"}),t.promise()},updateItem:function(e){var t=$.Deferred();return l(t,{fields:e,action:"edit"}),t.promise()},deleteItem:function(e){var t=$.Deferred();return l(t,{fields:e,action:"delete"}),t.promise()}}}),n.jsGrid("loadData"),n.on("keyup",".jsgrid-filter-row input",(function(e){13===e.keyCode&&n.jsGrid("search")}))}()}}),["/js/libs/jsgrid/jsgrid.min.css","/js/libs/jsgrid/jsgrid-theme.min.css","/js/libs/jsgrid/jsgrid.min.js"]),bibil.module("ImageCropper",(function(){function ImageCropper(e,t){var n,i,o,a,r,s=this,l=$.extend({},t.cropper,ImageCropper.defaults.cropper),c=null;function d(e){var r={block:"dialog.cropper",disableKeyboard:!0,fullHeight:!0,opt:$.extend({},t.params)};bibil.require("BlockAjax",(function(){n=bibil.make(bibil.BlockAjax,null,r),n.on("open",(function(t){i=t,function n(){o=i.find(".photo img")}(),e(t),i.find(".modal-footer .submit-trigger").on("click",(function(e){s.fire("complete",c)})),i.find(".modal-footer .cancel").on("click",(function(e){s.fire("cancel")}))})),n.on("close",(function(){!function e(){a&&a.destroy()}()})),n.load()}))}function u(e){o=e;var t=o[0];t.complete&&t.naturalWidth?f():t.onload=function(){f()}}function f(){var e=o[0];e.width,e.naturalWidth;a=new Cropper(e,$.extend({autoCrop:!1,ready:function(e){var n=a.getImageData(),i=n.width/n.naturalWidth;log(i),t.minW&&(a.options.minCropBoxWidth=t.minW*i),t.minH&&(a.options.minCropBoxHeight=t.minH*i),a.crop()},crop:function(e){c=e.detail}},l)),log(a)}e&&(e instanceof File?d((function(t){!function n(e,t){var n;r=e,"function"==typeof FileReader&&(n=new FileReader,n.onload=function(e){t(n.result)},n.readAsDataURL(r))}(e,(function(e){o[0].src=e,u(o)}))})):e[0]instanceof Image&&(o=e,u())),this.openDialog=d,this.coords=c}return ImageCropper.defaults={minW:0,minH:0,cropper:{modal:!0,aspectRatio:1,viewMode:1,zoomable:!1,scalable:!1,movable:!1}},$.fn.ImageCropper=bibil.registerJqueryPlugin(ImageCropper),ImageCropper}),[]),bibil.module("JSONVisual",(function(){return function JSONVisual(e,t){var n={object:{tag:"div",class:"package card ${show} ${type}",children:[{tag:"div",class:"header card-header",children:[{tag:"div",class:function(e){var t=["arrow fa"];return void 0!==i(e.value)&&t.push("hide"),t.join(" ")}},{tag:"span",class:"name",html:"${name}"},{tag:"span",class:"value",html:function(e){var t=bibil.escapeHtml(i(e.value));return void 0!==t?" : "+t:""}},{tag:"span",class:"type",html:"${type}"}]},{tag:"div",class:"children card-body",children:function(e){return function t(e){var t=$.type(e);switch(t){case"array":case"object":return json2html.transform(e,n.object)}}(e.value)}}]}};function i(e){var t=$.type(e);switch(t){case"array":case"object":return;case"function":return"function";case"string":return"'"+e+"'";default:return e}}function o(e,t,n){var i,a,r,s=$.type(t),l=[];switch(void 0===n&&(n="closed"),s){case"array":for(i=t.length,a=0;a<i;++a)l[a]=o(a,t[a]);break;case"object":for(r in a=0,t)l[a]=o(r,t[r]),a++;break;default:l=t}return{name:e,value:l,type:s,show:n}}!function a(){$("body").on("click",".app-json-visual .header",(function(){var e=$(this).parent();if(log(e),!e.hasClass("object")&&!e.hasClass("array"))return!1;e.hasClass("closed")?(e.removeClass("closed"),e.addClass("open")):(e.removeClass("open"),e.addClass("closed"))}))}(),this.transform=function r(e){return'<div class="app-json-visual">'+json2html.transform(o("Данные",e,"open"),n.object)+"</div>"}}}),["/css/ui.json-visual.css","/js/libs/json2html.js"]),bibil.module("ListAjax",(function(){function ListAjax(e,t){var n=$.extend({},t.params),i=e.find(".view-data"),o=t.filter?$(t.filter):null,a=t.scrollSelectorParent||null,r=t.infiniteScroll||!1,s=e,l=null,c=1,d=!1,u=void 0===t.autoload||t.autoload;function f(a){!function r(i,a){o&&(l=o.formToObject()),e.removeClass("d-none"),n.page=c,l?n.filter=l:"filter"in n&&delete n.filter,$.ajax({url:t.url+(a?"?"+$.param(a):""),method:"post",data:n,beforeSend:function(){e.addClass("app-loading"),bibil.UI.loading(!0),e&&e.trigger("app.list-ajax.before")},success:function(t){var n=new bibil.Api(t);n.errors.length>0?bibil.UI.alert(n.errors):(e&&e.trigger("app.list-ajax.success"),i&&i(n.result))},error:function(e,t){},complete:function(){e.removeClass("app-loading"),e.removeClass("empty"),bibil.UI.loading(!1),e&&e.trigger("app.list-ajax.complete")}})}((function(e){d&&1!==c?e.end||i.append(e.view):i.html(e.view)}),a)}"post"in t&&(n=$.extend(n,t.post)),e.on("click",".view-data .pagination a",(function(){var e=$(this).attr("href"),t=!!e&&e.match(/page=(\d+)/);return t&&(c=t[1]),f(),!1})),r&&(a&&(s=e.pparent(a)),s&&s.length&&(d=!0,s.infiniteScroll($.extend(r,{callback:function(){e.hasClass("scroll-infinite-disable")||(log("refresh"),c++,f())}})))),o&&(o.on("form.before",(function(e,t){return c=1,f(),!1})),o.on("reset",(function(e){c=1,l=null,setTimeout((function(){f()}),1)}))),e.addClass("empty"),u&&f(),this.refresh=f}return ListAjax.defaults={url:"/api/getList",template:"",params:{},limit:10},$.fn.ListAjax=bibil.registerJqueryPlugin(ListAjax),ListAjax})),bibil.module("Messages",(function(){function Messages(n,i){i=i||{};var o=this,a=new e;function r(e){e=$(e),e.find("[data-message-send]").on("click",(function(e){var t=$(this).data("messageSend");return 0===$(e.target).pparent(".actions-mess-list").length&&o.openDialog(t,$(this).data("support")),!1})),e.find(".app-message-modal").on("hide.bs.modal",(function(){var e=$(this).data("MessageWin");a.collapse(e)}))}function s(e,t){var n=$(".app-message-modal[data-comp-uid="+e+"]"+(t?".support":":not(.support)"));return n.length>0?n.data("MessageWin"):null}this.init=function l(){r($("body")),bibil.on("domAppend",(function(e,t){r(t)}))},this.getWin=s,this.openDialog=function c(e,n){var i=s(e,n);return i?i.show():(i=new t(e,n),i.open()),i}}function e(){var e=$('<div class="app-messages-dialogs"><div class="row justify-content-center flex-nowrap no-gutters"></div></div>');function t(){e.toggleClass("overflowed",e.isOverflow())}function n(t,n){var i=e.find(".item[data-uid="+t+"]"+(n?".support":":not(.support)"));return i.length>0?i:null}$("body").append(e),e.addDomListener({}).on("app.dom.inert app.dom.remove",(function(e,n,i){t()})),$(window).on("resize",(function(){t()})),this.collapse=function(t){if(!n(t.uid,t.support)){var i=t.support?"btn-primary":"btn-dark",o=$('<div class="col-auto item btn '+i+"  rounded-0 app-text-overflow "+(t.support?" support":"")+'" data-uid="'+t.uid+'"><span class="close-btn bg-dark "><i class="fa fa-remove"></i></span>'+t.user.line+"</div>");e.children(".row").prepend(o)}},e.on("click",".item .close-btn",(function(){var e=$(this).parents(".item"),t=e.data("uid"),i=e.is(".support");return function o(e,t){var i=n(e,t),o=bibil.Messages.getWin(e,t);i?(i.remove(),o&&o.remove()):error("item not found",e)}(t,i),!1})),e.on("click",".item",(function(){var e=$(this).data("uid"),t=$(this).is(".support"),n=bibil.Messages.getWin(e,t);return n?n.show():error("win not found"),!1}))}function t(e,t){var n,i,o,a,r,s,l,c,d,u,f,p,h=this,m=0,b=1,g=bibil.Daemon;function v(e){l&&(c=e?null:l.formToObject(),b=1,k())}function y(){var e=i.find(".modal-body"),t=i.find(".app-message-wrapper");t.height(e.height())}function w(e,t){!function n(e,t){null===e?s.html(""):s.html(bibil.UI.renderAlert(e,t))}(e,"danger")}function C(){var t={offset:m,uid:e,page:b};return h.support&&(t.support=1),c&&"object"==typeof c?(t.filter=c,i.addClass("filtered")):i.removeClass("filtered"),bibil.Api.request("messages",t).then((function(e){!function t(e){i.find(".app-paginations-col").toggleClass("d-none",!(e.pages&&e.pages.length>0)),e.offset?o.append(e.html):(o.html(e.html),function t(e){d.html(e),d.find(".page-item a").on("click",(function(){var e=$(this).attr("href").match(/page=(\d+)/);return e&&(b=e[1]),k(),!1}))}(e.pages));$(e.html).find("img").on("load",(function(){x(0)})),x()}(e.res),w(null)})).catch((function(e){w(e)})).done((function(){}))}function k(){m=0,i.addClass("mess-loading"),C().done((function(){i.removeClass("mess-loading")}))}function x(e){void 0===e&&(e=500),o.scrollEnd(e)}function A(){return i}h.user=null,h.uid=e,h.support=t,p=g.addMessHandler((function j(){this.typedMess=function(t){f&&t.from===e&&(f.TypedFrom("start"),setTimeout((function(){f.TypedFrom("stop")}),1e3))}})),this.open=function I(){var c={block:Messages.defaults.messageTpl,fullHeight:!0,removeHolder:!1,obj:"message",opt:{uid:e}};t&&(c.opt.support=1),n=bibil.make(bibil.BlockAjax,null,c),n&&(n.once("open",(function(t){h.user=n.result.user,i=t,function c(){a=i.find(".app-messages-form form"),u=i.find(".app-uploader-wrapper").data("Uploader"),o=i.find(".app-messages"),d=i.find(".app-paginations"),r=a.find("textarea"),s=i.find(".app-messages-alert"),f=i.find(".chat-mess-typing"),l=i.find(".message-search"),f.TypedFrom(),h.support||r.TypingMess({go:function(){g.send("typingMess",{uid:e})}});a.on("form.success",(function(e,t){!function n(e){o.append(e),x()}(t.html),u&&u.resetUI()})),l.on("form.before",(function(e,t){return v(),!1})),l.on("reset",(function(e){v(!0)})),i.on("shown.bs.modal",(function(){x()}))}(),y(),a.on("form.success",(function(){!function e(){r.val("")}()})),k(),h.nickname="",i.data("MessageWin",h)})),n.load())},this.show=function S(){i?i.modal("show"):w("modal not created")},this.remove=function T(){p&&g&&g.removeMessHandler(p),n&&n.remove(!0)},this.isOpened=A,this.isFront=function _(){var e=A();return e&&e.hasClass("show")},this.update=function D(){i.addClass("mess-updating");var e=o.find(".app-mess-item:last");e.length>0&&(m=e.data("id")),C().done((function(){i.removeClass("mess-updating")}))},this.redraw=y,this.append=function M(e){var t=o.find(".app-mess-item:last");t.length>0?t.after(e):o.append(e),x()}}return Messages.defaults={messageTpl:"comp.message"},new Messages}),["BlockAjax"]),bibil.module("Notify",(function(){return new function Notify(){var e,t=this,n=bibil.sett("uid");function i(t){if(!e)return errror("messaging not inited");log("getToken"),e.getToken().then((function(e){if(e){log("Endpoint: "+e);var n=bibil.storage("endpoint"),i=bibil.sett("endpoints")||[],o=i&&i instanceof Array&&-1!==$.inArray(e,i);if(t||n!==e||!o){var a=bibil.getClientHash()||"";if(!a)return void error("hash not defined, cancel register endpoint");bibil.Api.request("endpointRegister",{endpoint:e,device:JSON.stringify((new UAParser).getResult()),type:head.browser.name,hash:a}).then((function(t){bibil.storage("endpoint",e)})).catch((function(e){error(e)}))}}else error("No Instance ID token available. Request permission to generate one.")})).catch((function(e){error("registerEndpoint error",e)}))}function o(){if(log("serviceWorkerIniting..."),!n)return log("only registered"),!1;(function o(){var e=$.Deferred();try{var t,n="firebase-messaging-database";log("check database",n);var i=indexedDB.open(n,1);i.onerror=function(n,i){t||(error("error open database",n),e.resolve())},i.onupgradeneeded=function(n){error("database not found, migrate..."),t=!0,n.target.transaction.abort(),r().then((function(t){if(!t)return log("registration not found"),void e.resolve();log("found registration, unregister",t),t.unregister().then((function(){e.resolve()})).catch((function(){e.resolve()}))})).catch((function(){e.resolve()}))},i.onsuccess=function(t){i.result;e.resolve()}}catch(t){e.resolve()}return e})().then((function(){bibil.require(["https://www.gstatic.com/firebasejs/7.9.2/firebase-app.js","https://www.gstatic.com/firebasejs/7.9.2/firebase-messaging.js"],(function(){var n=bibil.sett("firebaseConfig");if("undefined"==typeof firebase)return error("firebase init error"),!1;e||(firebase.initializeApp(n),e=firebase.messaging()),Notification.requestPermission().then((function(){i(),e.onTokenRefresh((function(){error("onTokenRefresh"),i(!0)})),e.onMessage((function(e){log("Message received",e);var n=e.notification||{},i=e.data||{};bibil.runOnceTab((function(){t.notify($.extend({tag:"appnotyfy"},n,i))}),"bg_notify")}))}),(function(e){error(e)})).catch((function(e){error("Unable to get permission to notify",e)})),log("serviceWorkerInited")}))})).catch((function(e){error("serviceWorkerInit error",e)}))}function a(e){log("notifySW",e),r().then((function(t){if(t){log(t),e=$.extend({data:e},e);t.showNotification(e.title,e)}else log("reg not found")}))}function r(){var e,t,n=$.Deferred();return navigator.serviceWorker?navigator.serviceWorker.getRegistrations().then((function(i){for(var o in i)if(t=i[o],/firebase\-cloud\-messaging\-push\-scope/i.test(t.scope)){e=t;break}n.resolve(e)})).catch((function(){n.reject()})):n.reject("navigator.serviceWorker is not supported"),n}this.notify=function(e){var t,n=e.title||"Сообщение";"object"!=typeof e&&(e={body:e}),bibil.Utils.beep(e.sound||"mess");var i=$.extend({icon:"/i/logo128.png",badge:"/i/logo128_g.png"},e);if("function"==typeof Notification)try{t=new Notification(n,i),log("Notification",t),t.onclick=function(){"function"==typeof click&&click.call(this),e.link&&(window.location=e.link),this.close()}}catch(e){error(e),a(i)}else a(i)},this.init=function(){n?function e(){if("undefined"!=typeof Notification&&void 0!==Notification.permission){var e=Notification.permission.toLowerCase();if("granted"===e)o();else if("default"===e){var t=bibil.storage("notifyDeny");if(t)return error("notify disabled by user"),!1;setTimeout((function(){var e=bibil.make(bibil.BlockAjax,null,{block:"dialog.notifyPrompt",obj:"user"});e.load()}),5e3)}else error("notify permission denyed")}}():info("notify init cancel: not logged")},this.notifyEnables=function(){if("undefined"!=typeof Notification&&void 0!==Notification.permission){var e=Notification.permission.toLowerCase();if("granted"===e)return!0}return!1},bibil.on("domAppend",(function(e,t){$(t).findAndSelf(".dialog-notifyPrompt").each((function(){var e=$(this);e.find(".submit-trigger").on("click",(function(){bibil.storageRemove("notifyDeny"),function e(){Notification.requestPermission((function(e){"granted"===e?o():bibil.UI.error("Вы заблокировали уведомления в своем браузере. Уведомления приходить не будут до тех пор, пока вы не разрешите сайту в настройках браузера отправлять вам уведомления.")}))}()})),e.find(".close-trigger").on("click",(function(){bibil.storage("notifyDeny",1)}))}))})),this.getServiceWorker=r}})),bibil.module("Streamer",(function(){function Streamer(e,t){var n,i,o,a,r,s,l,c=this,d=bibil.storage("cam")||null,u=bibil.storage("mic")||null,f=parseInt(bibil.storage("micLevel")),p=new this.Reloader({0:3e3,4:1e4,20:1e6});function h(){c.started=!1,c.stopping=!1,c.starting=!1,c.stopped=!0,function e(){c.widthStreamCurrent="",c.acodecCurrent="",c.vcodecCurrent="",c.streamInfo={}}()}function m(e,n){var i,o=e?a:r;if(n?i=o.find(".dropdown-item[data-value='"+n+"']"):(n=e?d:u,n&&(i=o.find("[data-value='"+n+"']").addClass("active"))),i&&i.length){var s={index:i.data("index"),id:n};log("set "+(e?"camera":"mic"),s),e?(c.driver.setCamera(s),bibil.storage("cam",n)):(c.driver.setMic(s),bibil.storage("mic",n))}else"rtmp"===t.type&&error("item not found",n)}function b(e){e||0===e||(e=o.slider("value")),c.driver.micLevel(e),bibil.storage("micLevel",e)}function g(){(function n(){log("driver loading...",t.type);var e=new $.Deferred,n="";return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.RTCPeerConnection?("rtmp"===t.type?(n="StreamerRTMP",bibil.hasFlash()||bibil.UI.error(bibil2.render("flash",{}).html())):"webrtc"===t.type&&(n="StreamerWebRTC"),n?bibil.require(n,(function(){c.driver=new bibil[n](c),e.resolve()})):(error(t.type+" not implemented"),e.reject(t.type+" not implemented")),e):(e.reject("Ваш браузер не поддерживает HTML5 трансляции. Установите современный браузер"),e)})().then((function(){log("driver created",c.driver),c.driver.on("ready",(function(){log("driver ready"),"webrtc"!==t.type&&e.find(".video-wrapper").removeClass("col").addClass("col-auto"),m(!0),m(!1),c.driver.streamOptions(c.streamOptions),c.setVideoOutputDimensions(),b(),e.find(".flash-not-inited").remove(),c.driverReady=!0})),c.driver.on("access",(function(){})),c.driver.stat((function(e){e.widthStream&&(c.widthStreamCurrent=e.widthStream),e.acodec&&(c.acodecCurrent=-1!==e.acodec.indexOf("/")?e.acodec.split("/")[1]:e.acodec),e.vcodec&&(c.vcodecCurrent=-1!==e.vcodec.indexOf("/")?e.vcodec.split("/")[1]:e.vcodec),c.streamInfo=e})),c.driver.on("error",(function(e){error(e),(l||void 0===l)&&e&&bibil.UI.error(e),h()})),c.driver.on("start",(function(){s=!1,c.reconnect(!1),function e(){c.starting=!1,c.started=!0}()})),c.driver.on("stop",(function(){l=!1,h(),s||void 0===s||c.reconnect()})),c.driver.init()})).catch((function(e){error("driver load error",e),bibil.UI.error(e)}))}function v(){return n=e.find(".video-output-container"),a=e.find(".cams-dd"),r=e.find(".mics-dd"),n.length?(o=e.find(".volume-control").slider({orientation:"vertical",range:"min",min:0,max:100,value:f||0===f?f:50,slide:function(e,t){b(t.value)}}),function i(){var e=new $.Deferred;if(log("get devices streamer",t.type),"rtmp"!==t.type)return e.resolve(),e;return bibil.Devices.devices().then((function(n){var i="";log("devices",n),"rtmp"===t.type&&head.browser.ff&&(y(n.audioinput),y(n.videoinput)),n.audioinput&&w(n.audioinput),n.videoinput&&w(n.videoinput),i&&bibil.UI.alert(i),e.resolve()})).catch((function(t){error(t),t&&t.name&&"NotReadableError"===t.name?bibil.UI.alert("Устройство не доступно. Закройте все программы, использующие видеокамеру или микрофон"):bibil.UI.alert(t),e.reject(t)})),e}()):(error("videoOutputContainer not found"),!1)}function y(e){e.forEach((function(t,n){e.forEach((function(i){t.id!==i.id&&-1!==t.name.indexOf(i.name)&&(error("remove dublicate",t.name),e.delete(n))}))}))}function w(t){var n=0;t.forEach((function(t){var i=n,o=t.name,a="audioinput"===t.type,r=a?"mics-dd":"cams-dd",s=e.find("."+r),l=$('<div class="dropdown-item" data-index="'+i+'" data-value="'+t.id+'"><span class="app-text-overflow">'+o+"</span></div>");s.find(".dropdown-menu").append(l),n++}))}function C(){var e=new $.Deferred;return bibil.Api.request("streamerConnection",{stream_id:t.streamId,type:t.type,programm:"flash",server_id:c.serverId}).then((function(t){c.connection=t.res.connection,c.streamOptions=c.connection.streamOptions,c.servers=t.res.servers,c.serverId=t.res.server_id,c.server=t.res.server,c.key=t.res.key,c.streamLimit=t.res.streamLimit,!t.res.connection.beta||c.betaAlert||head.mobile||__debug||(c.betaAlert=!0,bibil.UI.alert("Вы выбрали сервер, который в данное время тестируется и возможны сбои в работе. Если вы уверены, просто закройте это окно, в противном случае выберите другой сервер. <br/><br/><strong>Спасибо за тестирование!</strong>")),e.resolve()})).catch((function(t){bibil.UI.error(t),error(t),e.reject()})),e}this.initPlayable(e,t),this.floating=function(e){Streamer.prototype.floating.call(this,e),this.isFloating&&c.setVideoOutputDimensions()},this.iStarted=function(){return this.started},this.setStopManual=function(){s=!0},this.start=function(){c.starting=!0,C().then((function(){c.driver.start()})).catch((function(){}))},this.stop=function(){this.stopping=!0,c.driver.stop()},this.reconnect=function(e){if("webrtc"===t.type)return!1;log("reconnect"),!1!==e?p.start((function(){if(c.starting)return log("reconnect cancel, is starting"),!1;c.start()})):(log("reload cancel"),p.cancel())},this.getRatio=function(){if(c.streamOptions.ratio){var e=c.streamOptions.ratio.split(".");return e[0]/e[1]}return 1},this.getMinWidth=function(){return parseInt(e.css("minWidth"))||parseInt(e.css("width"))},this.getMinHeight=function(){return parseInt(e.css("minHeight"))||parseInt(e.css("height"))},this.setVideoOutputDimensions=function(){i=e.find(".video-output");var t=n.width(),o=n.height(),a=t,r=a/c.getRatio();r>o&&(r=o,a=r*c.getRatio()),a=Math.floor(a),r=Math.floor(r),a>t&&(a=t),r>o&&(r=o),i.width(a),i.height(r),c.driver&&c.driver.resize(a,r)},this.setCamera=function(e){m(!0,e)},this.setMic=function(e){m(!1,e)},this.destroy=function(){c.driver&&c.driver.destroy()},this.tryReload=function(e){return!c.iStarted()||confirm("Трансляция будет остановлена. Продолжить?")},this.starting=!1,this.started=!1,this.stopping=!1,this.stopped=!0,this.driverReady=!1,this.servers=[],this.server=[],this.streamInfo={},this.connection={},this.serverId=0,this.streamLimit=!1,this.streamOptions={},this.options=t,this.key="",this.vcodecCurrent=null,this.acodecCurrent=null,this.widthStreamCurrent=null,e.renderTemplate({data:this,computed:{controlsEnabled:function(){return c.driverReady}}}),e=$("#"+e.attr("id")),this.el=e,v().then((function(){!function t(){var t=e.find(".stream-settings form");e.find(".start-stream").on("click",(function(){c.started||c.starting?(c.reconnect(!1),s=!0,c.stop()):(l=!0,c.start())})),e.find(".stream-settings .actions .cancel").on("click",(function(){e.removeClass("settings-open")})),t.on("form.success",(function(){var n=t.formToObject();e.removeClass("settings-open"),c.streamOptions=n,c.driver.streamOptions($.extend({},n)),c.setVideoOutputDimensions()})),e.find(".stream-settions-toggler").on("click",(function(){t.formAssign($.extend({},c.streamOptions)),e.addClass("settings-open")})),e.on("resize",(function(){c.setVideoOutputDimensions(event,v)})),a.add(r).on("app.change",(function(e,t){var n=$(this);n.hasClass("cams-dd")?c.setCamera(t.value):c.setMic(t.value)}))}(),C().then((function(){g()})).catch((function(e){error(e)}))})).catch((function(e){error(e)}))}return Streamer.prototype=new bibil.Playable,$.fn.Streamer=bibil.registerJqueryPlugin(Streamer),Streamer.defaults={containment:""},Streamer}),["Playable","Devices"]),bibil.module("StreamerRTMP",(function(){function StreamerRTMP(e){e.options;var t,n,i="app_streamer_flash_object",o=e.el,a="/i/flash/streamer.swf?v="+bibil.sett("ver"),r=this,s=!1,l=!1;function c(e,n,i){var o=null;"string"!=typeof i&&(i="");try{t.length>0?l&&"function"==typeof t[0].sendToActionScript?o=t[0].sendToActionScript(e,n,i):error("flash not inited"):error("flash object not found")}catch(e){error(e)}return o}this.init=function(){!function e(){window[i]=function(e,t){if("cameraReady"!==e&&"micReady"!==e||(o.fire("access"),o.addClass("flash-access")),"cameraStatus"===e&&head.browser.ff&&(log("cameraStatus",t),"Camera.Muted"===t&&(error("showSecurityPanel"),c("showSecurityPanel"))),"debug"===e&&log("FLASH DEBUG",t),"error"===e&&(r.fire("error",t),error("FLASH ERROR",t)),"ready"===e&&(l=!0,r.fire("ready"),o.addClass("flash-ready")),"conn_status"===e){var n=t.code;"NetStream.Buffer.Empty"!==n&&log(t),"NetStream.Publish.Start"===n&&(r.fire("start"),s=!0),"NetConnection.Connect.Closed"!==n&&"NetConnection.Connect.Failed"!==n&&"NetStream.Publish.BadName"!==n||("NetStream.Publish.BadName"===n?r.fire("error","Вы уже начали трансляцию. Закройте другие вкладки браузера"):"NetConnection.Connect.Failed"===n&&r.fire("error","Ошибка соединения с сервером. Повторите попытку или выберите другой сервер"),r.fire("stop"),s=!1)}return!0}}(),function n(){t=$('<object class="video-output" data="'+a+'" id="'+i+'" type="application/x-shockwave-flash" width="300" height="300"/>');var e={quality:"high",bgcolor:"#000000",allowScriptAccess:"always",wmode:"opaque",movie:a,flashvars:"jsCallback="+i};Object.getOwnPropertyNames(e).forEach((function(n){t.append('<param name="'+n+'" value="'+e[n]+'"/>')})),o.find(".video-wrapper").html(t)}(),l&&r.fire("ready")},this.start=function(){c("setSett",{limit:e.streamLimit||!1,domain:location.host,proto:/^https/.test(location.protocol)?"https":"http",streamUrl:e.connection.uri,streamName:e.connection.name,screenUrl:e.connection.screenUrl}),c("start")},this.stop=function(){log("stopping rtmp"),c("destroy")},this.stat=function(e){n=e},this.resize=function(e,t){c("setSize",{width:e,height:t},(function(){}))},this.streamOptions=function(e){c("setSett",{streamWidth:e.width,cameraWidth:e.width,ratio:e.ratio,quality:e.quality,video:e.vcodec,audio:e.acodec}),log(e)},this.setCamera=function(e){c("camChange",{index:e.index})},this.setMic=function(e){c("micChange",{index:e.index})},this.micLevel=function(e){log("set mic level",e),c("setMicLevel",{val:e})},this.destroy=function(){this.removeTimers()},this.addInterval((function(){if(l&&s){var e=c("streamInfo");e&&(e.bandwidth&&(e.bandwidth=parseInt(8*e.bandwidth),e.fps=parseInt(e.fps)),e.bandwidth&&n&&n(e))}}),1e3)}return StreamerRTMP.prototype=new bibil.Devices.StreamDriver,StreamerRTMP}),["Devices"]),bibil.module("Playable",(function(){return function Playable(){this.el=null,this.startTime=null,this.durationEl=null,this.duration=null,this.durationInterval=null,this.destroy=function(){this.durationInterval&&clearInterval(this.durationInterval)},this.initPlayable=function(e,t){var n=this;e.data("playable",this),this.el=e,this.opt_=t,this.isFloating="fixed"===t.layout,this.isFloating&&this.floating(),e.on("click",".playable-layout-toggle",(function(){n.floating(!e.hasClass("fixed"))})),this.durationEl=e.find(".duration-stream")},this.floating=function(e){var t=this.el,n=this.opt_;if(e||void 0===e)t.draggable({handle:".header",containment:n.containment||"html",drag:function(e,t){t.position.top>=0&&t.position.left>=0&&bibil.UI.savePosition("playerDimensions",{top:t.position.top,left:t.position.left})}}),t.resizable({resize:function(e,t){t.size.width>100&&t.size.height>100&&bibil.UI.savePosition("playerDimensions",{width:t.size.width,height:t.size.height})}}),t.addClass("fixed").removeClass("static"),t.find(".playable-layout-toggle").addClass("fa-compress").removeClass("fa-external-link"),this.isFloating=!0;else{if("function"==typeof t.draggable){try{t.is(".ui-draggable")&&t.draggable("destroy"),t.is(".ui-resizable")&&t.resizable("destroy")}catch(e){error(e)}t.css({left:"",top:"",width:"",height:""})}else error("player is not floating");t.addClass("static").removeClass("fixed"),t.find(".playable-layout-toggle").removeClass("fa-compress").addClass("fa-external-link"),this.isFloating=!1}},this.setDuration=function(e){if(this.durationInterval&&clearInterval(this.durationInterval),e){this.duration=1e3*e;var t=this;this.durationInterval=setInterval((function(){t.duration+=1e3,t.durationUpdate()}),1e3)}else this.duration=null},this.durationUpdate=function(){this.durationEl&&this.durationEl.length>0&&this.durationEl.html(moment.utc(this.duration).format("HH:mm:ss"))}}}),[]),bibil.module("RTCPeerConnection",(function(){function RTCPeerConnection(e){var t,n,i,o,a,r="peer_"+bibil.makeid(10),s=!1,l="",c=[],d=[],u=this,f=!1;function p(){this.candidate=function(e){d.push(e.candidate),log("candidate",e),h()},this.answer=function(e){a=e.peerId,function t(e){log("answer received"),i.setRemoteDescription({sdp:e,type:"answer"},(function(){log("setRemoteDescription success"),m(),h()}),(function(t){error("setRemoteDescription",t,e)})),u.fire("answer")}(e.sdp)},this.errorStream=function(e){error("error rtcp ws",e),u.fire("error",e.error||"")}}function h(e){e||(e=d),a&&(e instanceof Array||(e=[e]),e.forEach((function(e,t){var n=new RTCIceCandidate(e);i.addIceCandidate(n,(function(){}),(function(t){error(t),error(e)}))})))}function m(){if(!f&&a){var e=[];c.forEach((function(t){e.push(t.candidate)})),b("candidate",{candidates:c}),f=!0}}function b(e,t){t.__scope="webrtc",t.__sessionId=r,a&&(t.peerId=a),o&&o.send(e,t)}t={iceServers:[{urls:["stun:stun.l.google.com:19302"]}],iceTransportPolicy:"all"},this.offerOptions={offerToReceiveAudio:!0,offerToReceiveVideo:!0},this.init=function(){i=new window.RTCPeerConnection(t),i.onicecandidate=function(e){i&&(e.candidate?c.push(e.candidate):(!0,log("Candidate all getting: "+c.length),log(c),m()))},i.onsignalingstatechange=function(e){i&&(log("signalingState: "+i.signalingState,i),i.signalingState)},i.oniceconnectionstatechange=function(e){if(i){var t=i.iceConnectionState;log("ice: "+t),"connected"===t&&(u.fire("connect",e),log(i)),"disconnected"!==t&&"failed"!=t||(log("remote peer disconnected"),u.fire("disconnect",e))}},i.ontrack=function(e){i?(log("ontrack"),u.fire("ontrack",e)):error("no pc")},i.onremovestream=function(e){i&&(log("onremovestream"),u.fire("removestream",e))}},this.setWebsocket=function(e){o?error("ws already added"):(o=e,n=o.handler(new p,r),log("ws handler added",n))},this.addStream=function(e){e.getTracks().forEach((function(t){log("add track to pc"),i.addTrack(t,e)}))},this.createStream=function(e,t,n){s=!0,u.offerOptions={offerToReceiveAudio:!1,offerToReceiveVideo:!1},this.createOffer(e,t,n)},this.connectStream=function(e,t,n){u.offerOptions={offerToReceiveAudio:!0,offerToReceiveVideo:!0},s=!1,this.createOffer(e,t,n)},this.setKey=function(e){l=e},this.createOffer=function(e,t,n){log("createOffer"),u.isOffer=!0,i.createOffer(u.offerOptions).then((function(o){log("createOffer success"),i.setLocalDescription(new RTCSessionDescription(o),(function(){b("offer",{sdp:o,host:t,port:n,name:e,publish:s,key:l})}),(function(e){error("createOffer, setLocalDescription:",e)}))})).catch((function(e){error("createOffer",e)}))},offer=function(e){log("offer received"),i.setRemoteDescription(e.sdp,(function(){log("setRemoteDescription success")}),(function(e){error("offer, setRemoteDescription: "+e)})),i.createAnswer((function(e){log("createAnswer success"),i.setLocalDescription(e,(function(){log("setLocalDescription success"),b("Answer",{clientId:clientId,sdp:e})}),(function(e){error("offer, setLocalDescription: "+e)}))}),(function(e){error("offer, createAnswer: "+e)})),u.fire("offer")},this.remove=function(){log("peer remove",a),i&&"closed"!==i.signalingState&&(log("peer close"),i.close()),n&&o&&o.removeHandler(n),u.fire("remove"),u.destroy(),i=null}}return RTCPeerConnection.prototype=new Bibil.Base,RTCPeerConnection}),[]),bibil.module("Recorder",(function(){function Recorder(t,n){var i,o,a,r,s,l,c,d,u,f,p,h=this,m=1e3*bibil.sett("voiceDuration"),b={block:"dialog.recorder",obj:"Playable"};function g(){d.find(".fa").removeClass("fa-stop").addClass("text-red fa-circle"),l&&(clearInterval(l),l=null),c.recording&&c.toggleRecording(),d.attr("disabled","disabled"),u.attr("disabled","disabled"),c.getBuffer((function(e){u.removeAttr("disabled"),d.removeAttr("disabled"),p[0].src=URL.createObjectURL(e)}))}t.on("click",(function(){bibil.require(["/js/libs/recorder/recorder.js","Devices"],(function(){i=bibil.make(bibil.BlockAjax,t,b),i.on("open",(function(t){o=t,a=o.find(".dropdown.mics"),d=o.find(".start"),r=$("#analyser"),s=$("#wavedisplay"),u=o.find(".upload-record"),f=o.find(".duration"),p=o.find(".player");o.find(".modal-body").width();r[0].width=r.width(),r[0].height=r.height(),s[0].width=s.width(),s[0].height=s.height(),function b(){var e=new $.Deferred;return bibil.Devices.devices({audio:!0}).then((function(t,n){t.audioinput.forEach((function(e){var t=$('<div class="dropdown-item" data-value="'+e.id+'"><span class="app-text-overflow">'+e.name+"</span></div>");a.find(".dropdown-menu").append(t)})),e.resolve(n)})).catch((function(t){error(t),bibil.UI.alert(t),e.reject(t)})),e}().then((function(t){log("stream",t),c=new e,t,c.setStream(t)})),a.on("app.change",(function(e,t){!function n(e){e,bibil.Devices.devices({audio:{deviceId:{exact:e}}}).then((function(e,t){t,log("stream",t),c&&c.setStream(t)})).catch((function(e){bibil.UI.error("Ошибка смены микрофона: "+e)}))}(t.value)})),d.on("click",(function(){c.recording?g():function e(){var e=0,t=100;$(this);c.toggleRecording(),d.find(".fa").removeClass("fa-circle text-red").addClass("fa-stop"),u.attr("disabled","disabled"),c.recording?l=setInterval((function(){e+=t,e>=m&&g(),f.text(bibil.roundFix(e/1e3,2)+"с.")}),t):g()}()})),u.on("click",(function(){if(n.url){var e=new FormData,t=c.getBlob();t&&(n.post&&$.each(n.post,(function(t,n){e.append(t,n)})),e.append("fname","record.wav"),e.append("file",t),u.attr("disabled","disabled"),bibil.Api.request(n.url,e).then((function(e){h.fire("app:complete",e.res.url,e.res),i.remove()})).catch((function(e){bibil.UI.error(e)})).done((function(){u.removeAttr("disabled")})))}}))})),i.load()}))}))}function e(){window.AudioContext=window.AudioContext||window.webkitAudioContext;var e,t,n,i,o=bibil.Devices.getAudioCTX(),a=null,r=null,s=null,l=null,c=null,d=this,u=[],f=null;function p(e){var t=document.getElementById("wavedisplay");!function n(e,t,i,o){var a=Math.ceil(o.length/e),r=t/2;i.fillStyle="silver",i.clearRect(0,0,e,t);for(var s=0;s<e;s++){for(var l=1,c=-1,d=0;d<a;d++){var u=o[s*a+d];u<l&&(l=u),u>c&&(c=u)}i.fillRect(s,(1+l)*r,1,Math.max(1,(c-l)*r))}}(t.width,t.height,t.getContext("2d"),e[0]),l.exportWAV(h)}function h(e){f=e,u.forEach((function(e){e(f)})),u=[]}function m(e){if(!c){var o=document.getElementById("analyser");n=o.width,i=o.height,c=o.getContext("2d")}var a=Math.round(n/3),r=new Uint8Array(t.frequencyBinCount);t.getByteFrequencyData(r),c.clearRect(0,0,n,i),c.fillStyle="#F6D565",c.lineCap="round";for(var s=t.frequencyBinCount/a,l=0;l<a;++l){for(var d=0,u=Math.floor(l*s),f=0;f<s;f++)d+=r[u+f];d/=s;r[l*s];c.fillStyle="hsl( "+Math.round(360*l/a)+", 100%, 50%)",c.fillRect(3*l,i,1,-d)}window.requestAnimationFrame(m)}this.setStream=function(n){!function i(n){s=o.createGain(),r=o.createMediaStreamSource(n),a=r,a.connect(s),t=o.createAnalyser(),t.fftSize=2048,s.connect(t),l=new window.Recorder(s),e=o.createGain(),e.gain.value=0,s.connect(e),e.connect(o.destination),m()}(n)},this.toggleRecording=function b(){if(d.recording)l.stop(),l.getBuffers(p),d.recording=!1;else{if(f=null,!l)return;l.clear(),l.record(),d.recording=!0}},this.recording=!1,this.getBlob=function g(){return f},this.getBuffer=function v(e){if(f)return f;e&&u.push(e)}}return $.fn.Recorder=bibil.registerJqueryPlugin(Recorder),Recorder})),bibil.module("Room",(function(){function Room(e,t){var n,i,o,a,r,s,l,c=this,d=t.room,u=t.roomId,f=$("#chat-manage"),p={name:"",text:""},h=t.background||null,m=t.members||0,b=t.member||!1;function g(){this.updateRoom=function(e){e.room&&(p=$.extend(p,e.room))},this.joined=function(t){var n=t.self;!function i(){e.find(".template-room").each((function(){var e=$(this);bibil.Template.make({el:e[0],data:p})}))}(),C(n)},this.moderated=function(e){},this.moderatedremove=function(){},this.selfUpdate=function(e){C(e.client)},this.donate=function(e){var t=["bounce","flash","pulse","rubberBand","shake","swing","tada","wobble","jello","bounceIn","zoomIn"],n=t[Math.floor(Math.random()*t.length)],i=e.voice,o=bibil.UI.alertTemplate("donate-modal",e);o.addClass(n),o.addClass("animated"),i?bibil.Utils.play(i).play():bibil.Utils.beep("money")},this.roomDestroyed=function(){bibil.Utils.beep("stop"),e.mark("zoomOut").one("app.amimated",(function(){bibil.UI.error("Чат удален",{icon:"fa fa-exclamation-triangle"})})),e.addClass("destroyed")},this.streamOff=function(e){e.room===d&&bibil.Utils.beep("stop")},this.streamsUpdate=function(e){if(("publish"===e.type||"stop"===e.type)&&e.user){var t=c.getPlayer(e.user.id);if(t){var n=t.data("StreamPlayer");n&&("publish"===e.type?l=setTimeout((function(){n.resume(e.serverId),n.setDuration(e.duration)}),5e3*Math.random()):"stop"===e.type&&(l&&clearTimeout(l),n.stop()))}}},this.confUpdate=function(){w()},this.confRequest=function(){w(),bibil.Utils.beep("conf_request")},this.confJoined=function(e){if(e.uid===bibil.sett("uid"))y(e.room_id);else{var t=$("#playable-container"),n=c.getPlayer(e.uid);!n&&t.length>0?bibil.Api.request("block",{block:"chat.conf.playerLoader",obj:"conf",params:{member_uid:e.uid,room_id:e.room_id}}).then((function(e){var n=e.res.block||"";n&&t.append(n)})):error("container memebrs not found")}},this.confLeave=function(e){e.uid===bibil.sett("uid")&&r&&(r.remove(),r=null),c.removePlayer(e.uid)},this.confRemove=function(e){a&&a.remove()},this.bandwidthAlert=function(e){bibil.UI.alert(e.text)},this.subscribe=function(e){t.isOwner||(e.userHtml="");var n=$('<div class="app-fly-ball app-fly-ball-subscribe"><div class="ico"><i class="em em-heart"></i></div><div class="user">'+(e.userHtml||"")+"</div></div>");v(n)},this.likeMe=function(e){t.isOwner||(e.userHtml="");var n=$('<div class="app-fly-ball app-fly-ball-subscribe"><div class="ico"><i class="em '+(e.positive?"em-kiss":"em-face_with_symbols_on_mouth")+'"></i></div><div class="user">'+(e.userHtml||"")+"</div></div>");v(n)},this.streamOff=function(e){var t=c.getStreamer();t&&t.length>0&&t.Streamer("setStopManual")},this.donationsnotify=function(t){"connected"!==t.type&&"error"!==t.type||bibil.UI.alert(t.message,{header:t.header||"Сервисное сообщение",modal:void 0===t.modal||t.modal,icon:"fa fa-info-circle text-warning",type:t.cls||"normal"});var n=e.find(".donationnotifybell");n.removeClass("d-none"),"error"===t.type||"closed"===t.type?n.removeClass("text-success").addClass("text-danger"):n.removeClass("text-danger").addClass("text-success"),n.data("title",t.tooltip||"")}}function v(e){$("body").append(e);var t=$("html").height();$("html").width();e.on("click",(function(){e.remove()})),setTimeout((function(){e.animate({bottom:t/100*50,opacity:.5},5e3,(function(){e.remove()}))}),2e3)}function y(e){r||(r=bibil.UI.block("chat.conf.streamLoader",{obj:"conf",opt:{room_id:e}},(function(e){e.draggable({handle:".modal-header",containment:"html",drag:function(){}}),e.resizable({handles:"n, e, s, w, se"}),e.toCenter(!0,!1)})))}function w(){var e=$("#app-conf-dialog-manager");if(a&&0!==e.length){if(e.length>0){var t=e.find(".members-list");t.BlockAjax("reload")}}else{var n={block:"chat.conf.dialog.manager",obj:"conf",opt:{room:d}};a=bibil.make(bibil.BlockAjax,null,n),a&&(a.once("open",(function(e){e.draggable({handle:".modal-header",containment:"html",drag:function(){e.css({bottom:"auto"})}}),e.resizable({handles:"n, e, s, w, se"}),e.toCenter(!0,!1)})),a.load())}}function C(e){f.toggleClass("d-none",!e.moder),f.find(".owner").toggleClass("d-none",!e.owner&&!e.moderator)}if(this.togglePlayerActive=function(e){var t=c.getPlayer(e);if(t){c.setAllPlayersBackend();var n=t.pparent(".app-playable-container");if(n.length>0){n.removeClass("backend");var i=t.data("Streamer");i&&i.setVideoOutputDimensions()}}},this.getPlayer=function(e){var t=$(".app-stream-playable[data-owner-id="+e+"]");return t.length>0?t:null},this.getStreamer=function(){return t.streamId?$(".app-streamer[data-stream-id="+t.streamId+"]"):null},this.removePlayer=function(e){var t=c.getPlayer(e);if(t){var n=t.pparent(".app-playable-container");if(n){var i=t.data("Streamer"),o=t.data("StreamPlayer");o&&o.destroy(),i&&i.destroy(),n.remove()}}},this.setAllPlayersBackend=function(e){$(".app-stream-playable").each((function(){var e=$(this),t=e.pparent(".app-playable-container");t.addClass("backend");var n=e.data("Streamer");n&&n.setVideoOutputDimensions()}))},this.getAllPlayers=function(){var e=[];return $(".app-stream-playable").each((function(){var t=$(this),n=t.data("StreamPlayer");n&&e.push(n)})),e},this.floating=function(e){$(".app-chat, .app-stream-playable").each((function(){var t,n=$(this),i="";n.hasClass("app-chat")?i="Chat":n.hasClass("app-stream-palyer")?i="StreamPlayer":n.hasClass("app-streamer")&&(i="Streamer"),i&&(t=$(this).data(i)),t&&t.floating(e)}))},this.layout=function(e,t){o=e,"row"===e?$("html").addClass("room-layout-row").removeClass("room-layout-column"):$("html").removeClass("room-layout-row").addClass("room-layout-column"),$("html").toggleClass("room-layout-fixed",t)},this.background=function(e){$("body").css(e).addClass("backgrounded")},head.screen.width<=768&&!t.embed?this.layout("column",!1):this.layout("row",!0),h&&!head.mobile&&this.background(h),m&&w(),b&&y(u),t.donationsalerts_settings&&window.DonationsAlertsAPI)try{new window.DonationsAlertsAPI(t.donationsalerts_settings)}catch(e){error(e)}$("body"),bibil.on("domAppend",(function(e,t){$(t)})),setTimeout((function(){$(".app-sticker-btn").mark("bounceIn")}),6e4*Math.random()),function k(){$(document).on("click",".stream-starter .internal",(function(){var e=$(this).hasClass("player"),t=$("#playable-container"),n=e?$(".template-internal-player"):$(".template-internal-streamer");t.prepend(n.html()),n.remove(),$(this).pparent(".stream-starter").remove()}));var n=e.find(".room-settings");e.find(".room-settings .close").on("click",(function(){$(this).pparent(".room-settings").remove()})),$(document).on("click",".room-fullscreen",(function(){bibil.fullScreen(document.documentElement),$("html").toggleClass("fullscreen")})),setTimeout((function(){$(".room-settings .b .fa").removeClass("fa-spin")}),5e3),setTimeout((function(){n.length>0&&n.mark("flash",(function(){n.remove()}))}),10000222),$(document).on("change","#room_settings input, #room_settings select",(function(){var e=$(this),t=$(this).attr("name"),n=$(this).val(),i=new Date((new Date).getFullYear()+1,1,1);if("theme"===t){var o=$('<link id="style-dark" href="/css/dark.css" rel="stylesheet">'),a=$("#style-dark");if("dark"===n)0===a.length&&$("body").append(o);else if("light"===n)a.length>0&&a.remove();else if(""!==n)return!1;n?bibil.setCookie("theme",n,i):bibil.removeCookie("theme")}if("floating"===t){if(head.mobile)return!1;e.is(":checked")?(bibil.setCookie("floating",1,i),c.floating(!0)):(c.floating(!1),bibil.storageRemove("playerDimensions"),bibil.storageRemove("chatDimensions"),bibil.removeCookie("floating"))}"donotpause"===t&&(e.is(":checked")?bibil.storage("donotpausestream",1):bibil.storageRemove("donotpausestream"))})),$(document).on("click",".app-stream-loader.backend .app-stream-playable",(function(e){var t=$(this);if(0===$(e.target).pparent(".vjs-control-bar").length){var n=t.data("ownerId");c.togglePlayerActive(n)}}));var o=".app-stream-playable.fixed, .app-chat.floating";$(document).on("mousedown",o,(function(e){var t=$(this),n=parseInt(t.css("zIndex")),i=[],a=(parseInt(t.data("zindexOld")),$(o).not(t));if(a.each((function(){var e=$(this),t=parseInt(e.css("zIndex")),n=parseInt(e.data("zindex-old"));n?(e.css("zIndex",n),i.push(n)):t&&i.push(t)})),i.length>0){var r=Math.max.apply(null,i);t.data("zindex-old",n),t.css("zIndex",r+1)}})),$(document).on("webkitfullscreenchange mozfullscreenchange msfullscreenchange fullscreenchange",(function(e){bibil.isFullScreen()||$("html").removeClass("fullscreen")})),$(document).on("app:fullscreen",".app-stream-palyer",(function(e){bibil.fullScreen(document.documentElement),$("html").toggleClass("fullscreen"),function t(e){var t=$(".chat-layout-container");t.length>0&&(e?(t.resizable({minWidth:350,handles:"w",resize:function(e,t){}}),i&&i.floating(!1)):("function"==typeof t.resizable&&t.resizable("destroy"),t.css({left:"auto",width:"auto"})))}($("html").hasClass("fullscreen"))})),$("#playable-container").addDomListener({subtree:!1}).on("app.dom.inert",(function(e,t,n){var i=$(".app-playable-container:not(.backend)");i.length>1&&i.not(n).addClass("backend")})).on("app.dom.remove",(function(e,t,n){var i=$(".app-playable-container:not(.backend)");if(0===i.length){var o=$(".app-playable-container.backend:first > .app-stream-playable:not(fixed)");o.length>0&&c.togglePlayerActive(o.data("ownerId"))}})),f.find(".dropdown-item[data-block]").on("click",(function(){$(this).pparent(".app-dropdown").dropdown("toggle")})),"chat"!==t.mode&&(t.isOwner?(head.mobile||bibil.make(bibil.BlockAjax,null,{block:"chat.dialog.settings",opt:{room:d},obj:"chat"}).load(),$("#start-button").removeClass("d-sm-block").addClass("d-none")):t.streamId&&!t.streamLive&&bibil.make(bibil.BlockAjax,null,{block:"chat.dialog.schedule_read",opt:{room_id:u},obj:"chat_room"}).load()),e.find(".chat-panel-right .close-panel").on("click",(function(){e.addClass("chat-panel-right-closed")})),bibil.Utils.on("tabVisible",(function(e){if(head.mobile||bibil.storage("donotpausestream"))return!1;s&&(clearTimeout(s),s=null),e||(s=setTimeout((function(){!function e(){c.getAllPlayers().map((function(e){e.paused||e.pauseToggle()}))}()}),9e5))}))}(),function x(){n=e.find(".app-chat"),1===n.length?n.getModule("Chat",(function(e){i=e,i.addMessHandler(g),("column"===o||t.embed)&&i.setMessagesTop(!0)})):error("chat not found")}(),function A(){$(".navbar .nav-link, .navbar .dropdown-menu .dropdown-item").each((function(){var e=$(this);e.attr("target")||e.attr("target","_blank")}))}()}return $.fn.Room=bibil.registerJqueryPlugin(Room),Room}),["Ws"]),bibil.module("Smiles",(function(){function Smiles(e,t){var n,i,o,a=t.theme||"",r=t.textareaId?$("#"+t.textareaId):e.siblings("textarea:first"),s=10;function l(){n&&n.addClass("d-none")}function c(i){n&&!n.hasClass("d-none")?l():(n||function a(){var e,i;n=$('<div class="app-smiles-popover-box border"><div class="scroll"></div></div>'),t.cls&&n.addClass(t.cls),o.on("load",(function(){bibil.fire("smiles.extended.load")})),o.items.forEach((function(t){(!i||t.group&&t.group!==e)&&(e=t.group,i=$('<div class="app-smile-items" data-group="'+e+'"></div>'),i.append('<div class="group-sep"></div>'),n.find(".scroll").append(i)),i.append(t.html())})),n.append('<button type="button" class="close" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>'),n.on("mouseleave",(function(){var e=$(this);e.removeClass("popover-over"),setTimeout((function(){e.hasClass("popover-over")||l()}),300)})),n.find(".close").on("click",(function(){l()})),n.on("mouseenter",(function(){$(this).addClass("popover-over")})),n.find(".app-smile-items").on("click",".smile",(function(){d.call(this)})),$("body").append(n)}(),function r(){n.removeClass("d-none");var t=e.find(".btn-toggle"),i=e.offset(),o=t.offset(),a=o.left-n.width()/2,r=$(document).width();n.css({left:a>0&&n.width()<r?a:0,top:i.top-3})}())}function d(){var t=$(this).data("code"),n=$(this).parents(".app-smiles-popover-box:first");r.length>0&&(r.trumbowyg?r.trumbowyg("execCmd",{cmd:"insertText",param:" :"+t+": "}):r.insertAtCaret(" :"+t+": ")),n.length>0&&l(),function i(t){var n=o.items.get(t);if(n){var i=u(),a=i.all.indexOf(t);-1!==a&&i.all.unset(t),i.all.unshift(t),i.all=i.all.slice(0,s);var r=e.find(".base [data-code='"+t+"']");r.length>0&&r.remove(),e.find(".base [data-code]").length>=s&&e.find(".base [data-code]:last").remove(),e.find(".base").prepend(n.html()),bibil.storage("smiles_recent",JSON.stringify(i))}else error("smile not found",t)}(t)}function u(){var e=bibil.storage("smiles_recent");if(e)try{e=JSON.parse(e)}catch(e){error("parse smiles recent",e)}return $.extend({all:[]},"object"==typeof e?e:{})}bibil.SmilesLoader.load((function(t){t,o=bibil.SmilesLoader.getList("items",{theme:a}),i=bibil.SmilesLoader.getList("base",{theme:a}),function n(){i.on("load",(function(){bibil.fire("smiles.rendered.load")})),function t(){var t=u(),n=[];t.all.forEach((function(e){var t=o.items.get(e);t?n.push(e):error("smile recent not found",e)})),i.items.forEach((function(e){-1===n.indexOf(e.code)&&n.push(e.code)})),n=n.slice(0,10),n.forEach((function(t){var n=o.items.get(t);n&&e.find(".base").append(n.html())})),bibil.fire("smiles.rendered")}()}(),bibil.fire("smiles.loaded")})),function f(){e.find(".app-smile-items").on("click",".smile",(function(){d.call(this)})),e.find(".btn-toggle").on("click",(function(){c($(this))}))}()}return $.fn.Smiles=bibil.registerJqueryPlugin(Smiles),Smiles}),["SmilesLoader"]),bibil.module("SmilesLoader",(function(){function SmilesLoader(n,i){var o,a=[],r=new e,s=bibil.storage("smiles"),l=bibil.storage("smiles_ver"),c=bibil.sett("ver");function d(){r=u("items",{}),a.forEach((function(e){e(o)}))}function u(n,i){var a=new e;return o[n].forEach((function(e){a.add(new t(e,i))})),a}l!==c&&(s=null),s&&(o=JSON.parse(s),d()),this.extended=r,this.getList=function(e,t){return u(e,t)},this.load=function(e){void 0===o&&(o=null,bibil.Api.request("getSmiles",{}).then((function(e){o=e.res,bibil.storage("smiles",JSON.stringify(o)),bibil.storage("smiles_ver",bibil.sett("ver")),d()})).catch((function(e){error(e)}))),e&&(o?e(o):a.push(e))},this.replaceCodes=function(e,t,n){0===r.items.size&&error("smiles not loaded");var i=bibil.sett("smilesPattern");if(i)for(var o,a,s,l,c=new RegExp(i),d=0;o=e.match(c);)d++,a=o[1],s=r.items.get(a),l=n&&d>n?"&#9760;":s?s.htmlContent({theme:t}).html():"uups("+a+")",e=e.replace(o[0],l);return e}}function e(){var e=this,t=0;this.items=new Map,this.add=function(n){this.items.set(n.code,n),n.on("load",(function(){t++,t===e.items.size&&e.fire("load")}))}}function t(e,t){t||(t={});var n=this;this.loaded=!1,this.code=e.code,this.group=e.group,this.getUrl=function(n){n=$.extend(t,n);var i=n.theme?e.theme[n.theme]:e.url;return i||error("smile not found",e,n),i},this.htmlContent=function(t){var n=this.getUrl(t),i=$('<span class="smile app-smile" data-name="'+e.code+'">'+(n?'<img src="'+n+'">':"uups("+this.code+")")+"</span>");return i},this.html=function(t){var i=new Image,o=$('<span class="smile" data-code="'+e.code+'"><span class="inner">error</span></span>'),a=this.getUrl(t);return a?(i.src=a,i.onload=function(){n.fire("load"),n.loaded=!0},o.find(".inner").html(i)):(n.fire("load"),n.loaded=!0,error("url none",e)),o}}return e.prototype=new Bibil.Base,t.prototype=new Bibil.Base,SmilesLoader.prototype=new Bibil.Base,new SmilesLoader}),[]),bibil.module("StreamPlayer",(function(){function StreamPlayer(e,t){var n,i,o,a=this,r=t.type,s=t.connection,l=t.feature||"",c=!0,d=parseFloat(bibil.storage("playerVolume")),u=parseInt(bibil.storage("playerMuted")),f=new this.Reloader({0:1e3,5:6e3,10:12e3,20:9e4});this.bufferOptions={size:3,auto:!0},this.inspector=null;function p(e){var t=this,i="abort canplay canplaythrough durationchange emptied encrypted ended error interruptbegin interruptend loadeddata loadedmetadata loadstart mozaudioavailable pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" ");this.video=e,this.firstPlaying=!0,this.lastTime=void 0,this.totalVideoFramesLast=void 0,this.freezes=void 0,this.seeking=void 0,this.bufferDecreaseTM=void 0,a.statReset(),this.bufferReset=function(){log("buffer reset"),this.bufferOverflowCount=0,this.bufferOkCount=0,this.bufferSize=2,this.minBuffer=1,this.maxBuffer=3,this.watchCount=0,this.waitingCount=0},this.bufferReset(),this.destroy=function(){log("inspector destroy");for(var t=0;t<i.length;t++){var n=i[t];n&&(this.events[n]&&e.removeEventListener(n,this.events[n]),e.removeEventListener(n,this.printEv))}this.stuckEmTm&&(clearInterval(this.stuckEmTm),this.stuckEmTm=null)},this.seekTime=function(t){if(!this.isTimepointBuffered(t))return error("time not buffered:",t);var n=this.getBuffer();t||(t=0);var i=t<0?n.end+t:t,o=e.currentTime;e.currentTime=i,log("seek",o+"==>"+e.currentTime)},this.sync=function(){var t=a.bufferOptions.auto||!1,n=this.getBuffer(),i=t?n.end-this.minBuffer:n.end-this.bufferSize;i<n.start&&(i=n.start),error("sync",e.currentTime+" ==> "+i),this.seekTime(i)},this.isTimepointBuffered=function(t){for(var n=e.buffered,i=0;i<n.length;i++){var o=n.start(i),a=n.end(i);if(t>=o&&t<a)return!0}return!1},this.stuckEmulate=function(){this.stuckEmTm=setInterval((function(){e.currentTime=e.currentTime+20}),1e3)},this.qualityWatch=function(){var i=this.getBuffer(),o=n.getVideoPlaybackQuality(),r=o.droppedVideoFrames>0&&o.totalVideoFrames>0?100*o.droppedVideoFrames/o.totalVideoFrames:0,s=a.bufferOptions.auto||!1,l=a.bufferOptions.size,c=this.watchCount>0?100*this.waitingCount/this.watchCount:0,d=[];!s&&l&&(this.bufferSize=parseFloat(l)),a.stat.width=e.videoWidth,a.stat.height=e.videoHeight,a.stat.frames=o.totalVideoFrames,a.stat.dropped=o.droppedVideoFrames,a.stat.droppedPerc=r.toFixed(0),a.stat.delta=i.delta.toFixed(2),a.stat.waitingPerc=c.toFixed(0),a.stat.waitCount=this.waitingCount,a.stat.watchCount=this.watchCount,a.stat.buffLen=this.bufferSize.toFixed(2),this.watchCount%30==0&&log("quality, dropped: "+r.toFixed(0)+"%"),this.watchCount%10==0&&i.log("progress"),"flv2js"===a.type&&(this.framesPrev&&a.stat.frames===this.framesPrev||this.timePrev&&this.timePrev===e.currentTime)?this.stuckTm||(info("stuck detected"),this.stuckTm=setTimeout((function(){t.stuckTm=null,error("reload on stuck"),n.play(!0)}),2e4)):this.stuckTm&&(clearTimeout(this.stuckTm),this.stuckTm=null),this.framesPrev=a.stat.frames,this.timePrev=e.currentTime,r>20&&o.totalVideoFrames,i.needSync()?(this.bufferOverflowCount++,this.bufferOkCount=0,a.stat.buffOverflow++,this.bufferDecreaseTM&&(clearTimeout(this.bufferDecreaseTM),this.bufferDecreaseTM=null),this.bufferOverflowCount>3&&"flv2js"===a.type&&(d.push("Переполнение буфера: "+this.bufferSize),i.error("bufferOverflow",this.bufferOverflowCount),a.stat.syncCount++,s&&this.bufferSize<this.maxBuffer&&(this.bufferSize+=.3,i.info("buffer increase",.3)))):(this.bufferOkCount++,this.bufferOverflowCount=0,!this.bufferDecreaseTM&&s&&(this.bufferDecreaseTM=setTimeout((function(){t.bufferSize-.1>=t.minBuffer&&(t.bufferSize-=.1,i.info("buffer decrease",.1)),t.bufferDecreaseTM=null}),5e3))),this.watchCount++,d.length},this.getBuffer=function(){return new this.Buffer},this.Buffer=function(){var n=e.buffered.length,i=n>0?e.buffered.start(0):-1,o=n>0?e.buffered.end(0):-1;this.buffLen=n,this.start=i,this.end=o,this.delta=i>=0&&o>=0?o-e.currentTime:0,this.deltaBuff=i>=0&&o>=0?o-i:0,this.log_=function(){var n=[].slice.call(arguments);n.push("time: "+e.currentTime+"#"+e.readyState,"delta: "+this.delta.toFixed(2),"Buffered: "+this.start.toFixed(2)," => "+this.end.toFixed(2),"buffSize: "+t.bufferSize.toFixed(2)),window[n[0]].apply(null,n.slice(1))},this.log=function(){var e=[].slice.call(arguments);e.unshift("log"),this.log_.apply(this,e)},this.needSync=function(){return this.delta>t.bufferSize&&this.end>0},this.error=function(){var e=[].slice.call(arguments);e.unshift("error"),this.log_.apply(this,e)},this.info=function(){var e=[].slice.call(arguments);e.unshift("info"),this.log_.apply(this,e)}},this.events={error:function(t){error("video error",e.error)},waiting:function(){t.getBuffer().log("waiting"),t.waitingCount++},progress:function(){e.paused?e.seeking:t.qualityWatch()}},this.printEv=function(e){"seeking"===e.type?info("@",e.type):log("@",e.type)};for(var o=0;o<i.length;o++){var r=i[o];r&&(this.events[r]&&e.addEventListener(r,this.events[r]),-1===["progress","timeupdate"].indexOf(r)&&this.video.addEventListener(r,this.printEv))}}function h(){e.on("resize",(function(){})),e.find(".server-change").on("change",(function(){n&&n.play(!0)})),e.find(".stoped-overlay").on("click",(function(){n&&n.play()})),e.on("change",".playable-type-toggle",(function(){var e=$(this).val();Cookies.set("player_type",e,{expires:15}),a.type=e,n&&n.play(!0),a.debugToggle(!1)})),e.one("touchend",".video-js .vjs-tech",(function(){n&&c&&n.play()})),e.on("click",".playable-close",(function(){a.destroy(),e.remove()})),e.on("click",".refresh-connection",(function(){a.reload(!1),n&&n.play(!0)})),e.find(".debug-player-box .close-btn").on("click",(function(){a.debugToggle(!1)}))}function m(t){a.error=null;var i=t.connection;a.typesAvail=t.typesAvail,a.servers=t.servers,a.serverId=t.server_id,a.server=t.server,a.type=t.type,a.poster=t.poster;var o=n.getChild("controlBar").getChild("SettingsButton");return o&&("rtmp"!==t.type?o.show():o.hide()),"rtmp"!==t.type||bibil.hasFlash()||(bibil.UI.error(bibil2.render("flash",{}).html()),a.loading=!1),t.duration&&a.setDuration(t.duration),i.uri?(e.find(".vjs-live-display").html(i.host),a.connection=i,a.live=t.live,log("current conn",a.connection),!0):(bibil.UI.error("Выбранный тип доставки не поддерживается сервером: "+r),!1)}this.playerInit=function(){var r=videojs.getComponent("Player"),f={controls:!0,inactivityTimeout:__debug?5e4:500,muted:!(!u&&"conf"!==l&&"3ios"!=head.browser.name),volume:d||.5,controlBar:{progressControl:!1,MyButton:!0,FullButton:$("html").hasClass("room-layout-row"),SettingsButton:!0},flv:{},flash:{swf:"/i/flash/VideoJS.swf"},autoplay:!1};return function h(){var n=videojs.getComponent("Button"),i=videojs.getComponent("MenuButton"),o=videojs.getComponent("Menu"),r=videojs.getComponent("PlayToggle"),s=videojs.extend(n,{constructor:function(){n.apply(this,arguments);var e=this.el_.getElementsByClassName("vjs-icon-placeholder")[0];e&&(e.classList.add("fa"),e.classList.add("fa-bug")),this.el_.setAttribute("data-title","Проблемы воспроизведения? Отправить отчет!"),this.el_.setAttribute("data-block","dialog.playerReport"),this.el_.setAttribute("data-obj","chat_room"),this.el_.setAttribute("data-submit",JSON.stringify({stream_id:t.streamId}))},handleClick:function(){}}),l=videojs.extend(n,{constructor:function(){n.apply(this,arguments),$(this.el_).find(".vjs-icon-placeholder").addClass("fa fa-arrows-alt"),this.el_.setAttribute("data-title","Полный экран")},handleClick:function(){a.isFloating&&a.floating(!1),e.trigger("app:fullscreen")}}),c=videojs.extend(i,{constructor:function(){i.apply(this,arguments),$(this.el_).find("button .vjs-icon-placeholder").addClass("vjs-icon-cog")},createMenu:function(){var e=videojs.getComponent("MenuBuffer"),t=new e(this.player_);return t}}),d=videojs.extend(o,{constructor:function(){o.apply(this,arguments);var t=e.find(".buffer-menu").clone();if(0===t.length)return error("buffer menu not found",e),!1;var n=this;t.removeClass("d-none"),t.formAssign(a.bufferOptions),t.find("input[name], select[name]").on("change select",(function(){var e=t.formToObject();e.auto=!!e.auto,bibil.storageJson("buff",e),a.bufferOptions=e,n.settings(e)})),t.find(".debug-toggle").on("change",(function(){a.debugToggle($(this).is(":checked"))})),this.contentEl_.appendChild(t[0]),this.settings(a.bufferOptions)},settings:function(e){$(this.contentEl_).find(".buffer-size").toggleClass("d-none",e.auto)},createEl:function(){this.contentEl_=videojs.dom.createEl("div",{className:"vjs-menu-content"}),this.contentEl_.setAttribute("role","menu");var e=videojs.dom.createEl("div",{append:this.contentEl_,className:"vjs-menu"});return $(e).addClass("vjs-menu-buffer"),e.appendChild(this.contentEl_),e}}),u=videojs.extend(r,{constructor:function(){r.apply(this,arguments)},handleClick:function(){a.updateConnForce=!0,a.paused=!this.player_.paused(),r.prototype.handleClick.call(this,arguments)}});videojs.registerComponent("MyButton",s),videojs.registerComponent("MenuBuffer",d),videojs.registerComponent("SettingsButton",c),videojs.registerComponent("FullButton",l),"ios"!==head.browser.name&&videojs.registerComponent("PlayToggle",u)}(),n=videojs(i.get(0),f,(function(){log("player ready"),u||n.volume(d||.5),n.on("error",(function(e){error("error player"),a.live&&(a.loading=!0,a.playing=!1,a.reload())})),n.on("loadstart",(function(e){"rtmp"!==a.type&&(a.inspector=new p(n.tech().el_),log("inspector",a.inspector))})),n.on("loadedmetadata",(function(e){log("loadedmetadata"),"rtmp"===a.type&&n.muted()&&(n.volume(0),n.muted(!0)),$(".vjs-live-control.vjs-control").removeClass("vjs-hidden"),a.error=null,a.loading=!1,a.playing=!0,a.reload(!1)})),n.on("volumechange",(function(){bibil.storage("playerVolume",n.volume()),bibil.storage("playerMuted",n.muted()?1:0)})),n.tech().on("flashEvent",(function(e,t){log("flash event",t)})),n.tech().on("netstream_status",(function(e,t){var i=t[0].code||"";log("netstream_status",i),"NetStream.Video.DimensionChange"===i&&(!function o(){var e=n?n.tech().el():"";e&&(e=$(e),error("resize stage"),e.css("width","99%"),setTimeout((function(){error("restore stage"),e.css("width","100%")}),1e3))}(),log(t))})),"conf"!==l&&this.controlBar.liveDisplay.show()})),n.play=function(e){var i=!a.connection||e||a.updateConnForce;a.reload("pause"),a.paused=!1,i?(a.loading=!0,n.unloadSource(),function o(){var e=new $.Deferred;log("playerConnection..."),s?(m(s)?e.resolve():e.reject(),s=null):bibil.Api.request("playerConnection",{type:a.type,stream_id:t.streamId,server_id:a.serverId,browser:head.browser.name,browser_detail:head.browser,flash:bibil.hasFlash()?1:0,mobile:head.mobile?1:0,mse:videojs.getTech("flv").isSupported()?1:0,password:a.password}).then((function(t){t.res?m(t.res)?e.resolve():e.reject():(error("empty result",t),e.reject())})).catch((function(t){a.reload(!1),a.error=t instanceof Array?t[0]:t,error(t),e.reject()}));return e}().then((function(){a.updateConnForce=!1,n.playDo(!0)})).catch((function(e){error(e)})).done((function(){a.loading=!1}))):n.playDo()},n.sourceLoaded=function(){return!(!n.tech_||!n.tech_.flvPlayer)&&n.tech_.sourceLoaded()},n.playDo=function(e){a.live?(n.sourceLoaded()&&!e||(a.loading=!0,log("load source",a.connection.uri,a.connection.mime),a.inspector&&(a.inspector.destroy(),a.inspector=null),n.src({src:a.connection.uri,type:a.connection.mime})),setTimeout((function(){n.playNative()}),1)):(log("stream is off, paused"),n.pause())},n.playNative=function(){var e=r.prototype.play.call(this);e.then((function(){info("played normal"),c=!1})).catch((function(e){error("playNative error",e)})),log("play try",e)},n.pause=function(){log("stream is stopped"),r.prototype.pause.call(this),a.reload(!1),a.playing=!1,a.loading=!1,a.poster&&(log("set poster",a.poster),n.poster(a.poster)),n.unloadSource()},n.unloadSource=function(){log("unloadSource"),n.tech_&&(n.tech_.hls&&n.tech_.hls.playlists?n.tech_.hls.playlists.dispose():n.tech_.flvPlayer?n.tech_.unload():n.tech_.Flash)},"rtmp"===this.type&&(o=e.find(".vjs-tech"),0===o.length&&(o=null)),n.on("error",(function(e){error("player error",this.error().message),n.error(null)})),log("player",this),log("vjplayer",n),window.__debug&&(window.streamPlayerGlobal=a),n.play(),n},this.floating=function(t){StreamPlayer.prototype.floating.call(this,t),this.isFloating&&"conf"!==l&&bibil.UI.restorePosition("playerDimensions",e)},this.debugToggle=function(t){e.toggleClass("debug-show",t),a.debugEnabled=t},this.playerErrorNotice=function(t){if(bibil.sett("admin")){var n=e.find(".error-notice-ico");if(0===n.length)return!1;if("boolean"==typeof t)e.toggleClass("error-notice",t),n.removeAttr("data-title");else{t instanceof Array&&(t=t.join("<br/>"));n.data("bs.tooltip");n.attr("data-original-title",t),e.addClass("error-notice")}}},this.stop=function(){a.live=!1,n&&n.pause()},this.isPlaying=function(){return"rtmp"===r?void 0:n&&4===n.readyState()},this.resume=function(e){if(a.paused)return log("player is paused, cancel resume"),!1;f.refresh();var t=!1;(!a.live||!a.connection||a.connection&&e&&a.connection.server_id!==e)&&(t=!0),a.live=!0,n&&n.play(t)},this.reload=function(e){void 0===e||"boolean"==typeof e&&e?(log("reload start"),f.start((function(){n&&n.play()}))):(log("reload canceled",e),"pause"===e?f.pause():f.cancel())},this.destroy=function(){n&&n.dispose(),n=null,this.__destroy(),f&&f.cancel(),log("desployed player")},this.pauseToggle=function(){if(n)try{n.getChild("controlBar").getChild("playToggle").handleClick()}catch(e){error(e)}},this.statReset=function(){this.stat={width:0,height:0,dropped:0,droppedPerc:0,frames:0,buffLen:0,buffOverflow:0,delta:0,waitingPerc:0,syncCount:0,waitCount:0,watchCount:0}},this.live=!1,this.el=e,this.type=r,this.connection=null,this.typesAvail=[],this.playing=!1,this.pause=!1,this.paused=!1,this.poster=null,this.loading=!0,this.password=t.password||"",this.serverId=t.server_id||0,this.servers=[],this.server=[],this.error=null,this.statReset(),this.debugEnabled=!1,this.mobile=head.mobile,e.renderTemplate({data:this}),e=$("#"+e.attr("id")),function b(){!function t(){i=e.find(".video-output"),i.addClass("video-output video-js vjs-default-skin"),a.bufferOptions=$.extend(a.bufferOptions,bibil.storageJson("buff")),bibil.on("roomPassword",(function(e){a.password=e,n&&n.play()})),a.playerInit()}(),h()}(),this.initPlayable(e,t)}return StreamPlayer.defaults={playerOptions:{autoplay:!0,controlBar:{volumePanel:{inline:!1}}}},StreamPlayer.prototype=new bibil.Playable,$.fn.StreamPlayer=bibil.registerJqueryPlugin(StreamPlayer),StreamPlayer}),["/js/stream_players_bundle.js","Playable"]),bibil.module("StreamsTimeline",(function(){function StreamsTimeline(e,t){e.find(".control");var n,i,o=e.find(".chart"),a=e.pparent(".modal"),r=e.find(".chart-loader"),s=e.find(".btn-back"),l=e.find(".btn-yesterday, .btn-today"),c=new Date(t.dateToday),d=new Date;function u(){google.charts.load("current",{packages:["corechart","controls"],language:"ru"}),google.charts.setOnLoadCallback(f)}function f(){s.addClass("d-none"),l.removeClass("d-none"),p("/api/StreamsStatBar",{}).then((function(e){n=new google.visualization.BarChart(o[0]),i=new google.visualization.DataTable(e.res.chart),n.draw(i,{height:1e3,title:"История ТОП трансляций",hAxis:{title:"в чате",baselineColor:"transparent",gridlines:{color:"none",count:0},minorGridlines:{count:0},textStyle:{color:"#333333",fontSize:12}},vAxis:{direction:-1,baselineColor:"transparent",gridlines:{color:"none",count:24},minorGridlines:{count:0},textStyle:{color:"#333333",fontSize:12}},chartArea:{top:40,height:"90%"},legend:{position:"none"},annotations:{textStyle:{fontSize:12}},tooltip:{trigger:"selection",isHtml:!0}}),n.setAction({id:"lick",text:"Показать остальных",action:function(){var e=n.getSelection(),t=i.getValue(e[0].row,0);return function a(e){s.removeClass("d-none"),l.addClass("d-none"),p("/api/StreamsStatPie",{hour:e}).then((function(e){n=new google.visualization.PieChart(o[0]),i=new google.visualization.DataTable(e.res.chart),n.draw(i,{})})).catch((function(e){bibil.UI.error(e)}))}(t[0]),!1}}),n.setAction({id:"user",text:"Автор трансляции",action:function(){var e=n.getSelection(),t=i.getValue(e[0].row,5);return open(t),!1}})})).catch((function(e){bibil.UI.error(e)}))}function p(e,t){var n;r.removeClass("d-none"),t||(t={}),d instanceof Object&&(n=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()),t.date=n;var i=bibil.Api.request(e,t);return i.then((function(){r.addClass("d-none")})),i}d.setTime(c.getTime()),a.length>0?a.on("shown.bs.modal",(function(){u()})):u(),s.length>0&&s.on("click",(function(){f()})),l.length>0&&l.on("click",(function(){l.removeClass("btn-primary").addClass("btn-secondary"),$(this).removeClass("btn-secondary").addClass("btn-primary"),$(this).is(".btn-yesterday")?d.setDate(c.getDate()-1):d.setDate(c.getDate()),f()}))}return $.fn.StreamsTimeline=bibil.registerJqueryPlugin(StreamsTimeline),StreamsTimeline}),["https://www.gstatic.com/charts/loader.js"]),bibil.module("Template",(function(){function Template(e,t){var n,i=$.extend({},t.vueGlobal,t.vue||{});e&&(i=$.extend({template:e[0]},i),n=e.data("target")),this.vm=new Vue(i),this.mount=function(e){this.vm.$mount("string"==typeof e?"#"+e:e)},n&&this.mount(n)}return Template.render=function(e){var t=bibil.make(Template);return t.render(e)},Template.renderEl=function(e,t){var n=bibil.make(Template,null,{vue:$.extend(t,{template:"string"==typeof e?"#"+e:e})}),i=$("<div></div>");return n.vm.$mount(i[0]),$(n.vm.$el)},Template.renderElement=function(e,t){return Template.renderEl(e,{data:t})},Template.make=function(e,t){return bibil.make(Template,t?"string"==typeof t?$("#"+t):t:null,{vue:e})},Template.mount=function(e,t,n){return bibil.make(Template,"string"==typeof e?$("#"+e):e,{vue:{data:t,mounted:n}})},Template.prototype=new Bibil.Base,Template.defaults={vueGlobal:{delimiters:["${","}"]}},$.fn.renderTemplate=bibil.registerJqueryPlugin((function e(t,n){var i=t.find(".template"),o=bibil.make(Template,i.eq(0),{vue:n});return o.vm.$mount(i[0]),o.vm.$el})),Template}),[]),bibil.module("UI",(function(){var e=new function UI(){var e,t=this,n=$('<div class="app-ajax-loader"><img src="/i/loader.gif"/></div>'),i={fancybox:!0,autosize:!0,tooltip:!0,flip:!0,clipboard:!0,selectize:!0,selectors:[{name:".app-datepicker",requires:[],init:function(e){var t=e.data("format");!t&&/^\d{4}-\d{2}-\d{2}$/.test(e.val())&&e.val(e.val().split("-").reverse().join(".")),e.datepicker($.extend({language:"ru",format:"dd.mm.yyyy",autoclose:!0,todayHighlight:!0,endDate:"new Date()"},e.data())),e.attr("autocomplete","off")}},{name:".app-sound-toggler",init:function(e){var t=function(t){t?(e.addClass("btn-danger").removeClass("btn-secondary"),e.find(".fa").addClass("fa-volume-off").removeClass("fa-volume-up")):(e.addClass("btn-secondary").removeClass("btn-danger"),e.find(".fa").addClass("fa-volume-up").removeClass("fa-volume-off"))};t(bibil.storage("sound_disabled")),e.on("click",(function(){bibil.storage("sound_disabled")?(bibil.storageRemove("sound_disabled"),t()):(bibil.storage("sound_disabled",1),t(!0))}))}},{name:".app-fly-ball",init:function(e){}},{name:".app-horizontal-scroll",init:function(e){var t,n=e.find(">.row");e.toggleClass("overflowed",n.isOverflow()),e.append('<div class="app-horizontal-scroll-next scrollers"><i class="fa fa-arrow-right" aria-hidden="true"></i></div>'),e.append('<div class="app-horizontal-scroll-prev scrollers"><i class="fa fa-arrow-left" aria-hidden="true"></i></div>'),n.isOverflow()&&e.addClass("has-next"),e.find(".scrollers").on("click",(function(){})),e.find(".scrollers").on("mousedown",(function(){var i=$(this).hasClass("app-horizontal-scroll-next");t&&(clearInterval(t),t=null),t=setInterval((function(){!function o(i){var o=n[0].scrollLeft,a=n[0].scrollWidth,r=o;i?r+=5:r-=5,r<=0?(r=0,e.removeClass("has-left"),t&&(clearInterval(t),t=null)):e.addClass("has-left"),log(r,a),n.scrollLeft(r)}(i)}),20)})),e.find(".scrollers").on("mouseup",(function(){t&&(clearInterval(t),t=null)}))}},{name:".comments-loader",init:function(e){var t=$("#"+e.data("target"));t.length&&(e.on("click",(function(){t.BlockAjax("load")})),t.on("app.block.load",(function(){e.remove()})),t.on("app.block.before",(function(){e.html('<i class="fa fa-spinner fa-spin"></i> щас...')})))}},{name:".app-stream-animated",init:function(e){e.find(".main");var t=e.find("img.slide"),n=function(){setTimeout((function(){var e=t.filter(".front");0===e.length?(e=t.eq(0),e.addClass("front")):(t.removeClass("back"),e.removeClass("front").addClass("back"),e=e.next(".slide"),0===e.length&&(e=t.eq(0)),e.removeClass("back").addClass("front")),e.mark("fadeIn",(function(){n()}))}),500)};setTimeout((function(){n()}),3e3)}},{name:"[data-videocall]",init:function(e){var t=e.data("videocall");e.on("click",(function(){bibil.Api.request("message",{uid:t,videocall:t}).then((function(e){bibil.UI.alert(e.res.videocallRes)})).catch((function(e){bibil.UI.error(e)}))}))}},{name:".app-chat-loader",init:function(e){e.on("click",(function(){var t=e.data("wrapper")||"body";e.html('<img src="/i/chat_enter.gif">'),bibil.Api.request("chatLoad",{}).then((function(n){$("html").addClass("chat-glob-opened"),$(t).append(n.res.chatHtml),$(t).removeClass("d-none"),e.remove()})).catch((function(e){bibil.UI.error(e)}))}))}}]},o=0,a="*[data-help], *[data-title]";function r(e){var t=e.attr("aria-describedby");e.tooltip("hide"),t&&$("#"+t).remove()}function s(e){var t=e.attr("aria-describedby");"popover"in e&&e.popover("hide"),t&&$("#"+t).remove()}function l(e){"tooltip"in $.fn&&i.tooltip&&$(e).findAndSelf(a).tooltip({trigger:"hover",html:!1,title:function(){return $(this).data("help")||$(this).data("title")},container:"body"}).on("click",(function(){r($(this))})),"function"==typeof autosize&&i.autosize&&$(e).find("textarea:not(.autosize-disable)").on("focus",(function(){autosize($(this))})).on("blur",(function(){})),"flip"in $.fn&&$(e).find(".app-flip").each((function(){$(this).flip($.extend({trigger:"manual",autoSize:!1},$(this).data())).on("flip:done",(function(e,t){$("#card").data("flip-model")}))})),"slick"in $.fn&&$(e).find("[data-slick]").each((function(){$(this).slick($.extend({},$(this).data()))})),"function"==typeof Clipboard&&$(e).findAndSelf("[data-clipboard], .app-clipboard").each((function(){var e,t=$(this),n=t.parents(".modal:first"),i={text:function(e){return e.getAttribute("data-clipboard")}};n.length>0&&(i.container=n[0]),e=new ClipboardJS(this,i),e.on("success",(function(e){setTimeout((function(){y($(e.trigger),"Ссылка скопирована!",{autohide:1e3})}),100),e.clearSelection()}))})),$(e).find("[data-passgen]").on("click",(function(){var e=$(this).data("passgen"),t=$(this).data("length"),n=$("#"+e);bibil.makeid();n.length>0&&(t||(t=n.attr("minlength")||6),n.val(bibil.makeid(t)))})),$(e).find("input,textarea").on("keyup keydown",(function(e){var t,n=String.fromCharCode(e.charCode?e.charCode:e.which),i=new RegExp("^[a-zA-Z0-9]+$"),o=new RegExp("^[0-9]+$"),a=i.test(n),r=i.test(e.key)&&a;t={isAlphaNum:a,isNum:o.test(n),isAlphaNumLat:r,key:e.key,ev:e},$(this).trigger("app."+e.type,t)})),$(e).find("input,textarea").on("keydown",(function(e){var t=$(this),n=t[0].tagName.toLowerCase(),o=t.data("keytype")||("textarea"===n?"ctrl_enter":"enter"),a=e.keyCode||e.which,r=t.parents("form:first"),s=r.find("[type=submit]"),l=t.val();if("enter"===o&&13===a&&e.ctrlKey&&(t.val(l+"\n"),"function"==typeof autosize&&i.autosize&&autosize.update($(this)),$(this).scrollEnd()),"ctrl_enter"===o&&e.ctrlKey&&13===a||"enter"===o&&!e.ctrlKey&&!e.shiftKey&&13===a)return s.length>0&&s.trigger("click"),t.trigger("app.entered",l),!1})),$(e).find("[data-clipboard-upload]").on("paste",(function(e){var n=e.originalEvent,i=$(this).data("clipboardUpload"),o=$("#"+i);void 0!==n.clipboardData&&t.uploadClipboard(n.clipboardData,o)})),$(e).find("[data-remove-parent]").on("click",(function(){$(this).data("action")||$(this).pparent("."+$(this).data("removeParent")).remove()})),"banBox"in $.fn&&$(e).findAndSelf(".app-ban-box").banBox(),$(e).find("[autofocus]").focus(),$(e).find(".app-radio").each((function(){var e=$(this).find("input[type=radio]");e.is(":checked")&&$(this).addClass("active"),$(this).on("click",(function(e){if("input"!==e.target.nodeName.toLowerCase()){var t=$(this).find("input[type=radio]");t.trigger("click"),$(this).parents(".app-radio-container:first").find(".app-radio").removeClass("active"),$(this).addClass("active")}}))})),"undefined"!=typeof uLogin&&$(e).findAndSelf("[data-ulogin]").each((function(){var e="ulogin_"+bibil.makeid(10);$(this).removeAttr("data-ulogin-inited").attr("id",e),uLogin.customInit(e)})),$(e).find(".modal[data-comp-auto-show]").each((function(){var e=$(this);e.modal()})),$(e).find("form.ajax").each((function(){var e=$(this),t=e.pparent(".modal");if(t.length>0){var n=t.find(".submit-trigger");if(n.length>0&&e.length>0&&0===e.find("button[type=submit], input[type=submit]").length){var i=$('<button class="submit-holder" type="submit">Отправить</button>');e.append(i),n.on("click",(function(){var e=$(this);e.attr("name")&&i.attr("name",e.attr("name")),e.attr("value")&&i.attr("value",e.attr("value")),i.trigger("click")}))}}}));var n=i.selectors;n.forEach((function(t,n){var i=$(e).findAndSelf(t.name);i.length>0&&(t.requires?bibil.require(t.requires,(function(){"function"==typeof t.init&&i.each((function(){t.init($(this))}))})):"function"==typeof t.init&&i.each((function(){t.init($(this))})))})),$(e).findAndSelf(".app-pickimage").PickImage(),$(e).findAndSelf("[data-action][data-submit]").ActionSubmit(),$(e).findAndSelf(".app-dropdown").DropDown(),$(e).findAndSelf(".app-dropdown-status").DropDownStatus(),$(e).findAndSelf(".app-like").Like(),$(e).findAndSelf(".app-notifications").Notifications(),$(e).findAndSelf(".app-online-status").OnlineStatus(),$(e).findAndSelf(".app-stream-loader").StreamLoader(),$(e).findAndSelf(".app-pay-button").PayButton(),$(e).findAndSelf(".app-donate-button").DonateButton(),$(e).findAndSelf(".app-playable").Playable(),$(e).findAndSelf(".app-support-ask").SupportAsk(),$(e).findAndSelf(".app-text-anim").TextAnim(),"selectize"in $.fn&&($(e).findAndSelf("select.app-select").SelectCustom(),$(e).findAndSelf("input.app-tags").TagsInput());var o=[{name:"BlockAjax",selector:$(e).findAndSelf("[data-block]")},{name:"FormAjax",selector:$(e).find("form.ajax")},{name:"Uploader",selector:$(e).findAndSelf(".app-uploader-wrapper")},{name:"ListAjax",selector:$(e).findAndSelf(".app-list-ajax")},{name:"Chat",selector:$(e).findAndSelf("[data-chat]")},{name:"Smiles",selector:$(e).findAndSelf(".app-smiles")},{name:"Content",selector:$(e).findAndSelf(".app-content.can-edit")},{name:"Editor",selector:$(e).findAndSelf(".app-editor")},{name:"Doska",selector:$(e).findAndSelf(".app-doska")},{name:"Friends",selector:$(e).findAndSelf(".app-friends")},{name:"Streamer",selector:$(e).findAndSelf(".app-streamer")},{name:"StreamPlayer",selector:$(e).findAndSelf(".app-stream-palyer")},{name:"VideoPlayer",selector:$(e).findAndSelf(".app-video-palyer")},{name:"VideoRecord",selector:$(e).findAndSelf(".app-video-record")},{name:"Room",selector:$(e).findAndSelf(".app-room")},{name:"Recorder",selector:$(e).findAndSelf(".app-recorder")},{name:"Comments",selector:$(e).findAndSelf(".app-comments")},{name:"Vote",selector:$(e).findAndSelf(".app-vote")},{name:"ColorPicker",selector:$(e).findAndSelf(".app-colorpicker")},{name:"UserStat",selector:$(e).findAndSelf(".app-user-stat")},{name:"StreamsTimeline",selector:$(e).findAndSelf(".app-streams-timeline")},{name:"Phone",selector:$(e).findAndSelf(".app-phone")}];o.forEach((function(e){e.selector.length>0&&(void 0===bibil[e.name]?bibil.require(e.name,(function(){c(e)})):c(e))})),$(".app-hide-loading").removeClass("app-hide-loading")}function c(e){if("function"!=typeof e.selector[e.name])return error(e.name+" is not jquery plugin"),!1;e.selector.data(e.name)?"function"==typeof console.warn&&console.warn("already inited",e.name,e.selector):(e.selector[e.name](),"BlockAjax"===e.name&&e.selector.each((function(){var e=$(this),t=e[0].nodeName.toLowerCase();e.data("auto")?e.BlockAjax("load"):e.on("click",(function(){if(!e.data("manual")){var n=e.data("BlockAjax"),i=($("#"+n.blockId),e.data("modalHidden"));if(i&&n.blockExists()?e.BlockAjax("showModal"):e.BlockAjax("load"),"a"===t)return!1}}))})))}function d(e,t){return e instanceof Array||(e=[e]),e=$.map(e,(function(e,n){return e instanceof Error&&(e=e instanceof Bibil.Error?e.message:e.name),t?t(e):e})),e.join("",e)}function u(e,t){return d(e,(function(e){return'<div class="alert alert-'+t+'"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> '+e+"</div>"}))}function f(e){this.btn=function(t){var n=$('<button type="button" class="btn btn-success submit"></button>');return n.html(t),e.find(".modal-footer").append(n),n},this.el=function(){return e}}function p(e,t){t=$.extend({type:"info",header:"Сообщение"},t);var n=$('        <div class="modal app-alert" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">            <div class="modal-dialog" role="document">                <div class="modal-content">                    <div class="modal-header">                        <h5 class="modal-title"></h5>                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">                            <span aria-hidden="true">&times;</span>                        </button>                    </div>                    <div class="modal-body"></div>                    <div class="modal-footer">                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>                        <button type="button" class="submit d-none btn btn-primary">Сохранить</button>                    </div>                </div>            </div>        </div>'),i={};return"normal"!==t.type&&(e=u(e,t.type)),n.on("hidden.bs.modal",(function(){n.remove()})),t.btn&&n.find(".modal-footer .btn.submit").removeClass("d-none").html(t.btn),t.modal&&(i.backdrop="static"),t.centered&&n.addClass("centered"),n.find(".modal-body").html(e),n.find(".modal-title").html(t.header),t.icon&&n.find(".modal-title").prepend('<i class="'+t.icon+'"></i> '),t.ok&&n.find(".modal-footer [data-dismiss]").text(t.ok),n.modal(i),n.modal("show"),n}function h(){var e=new Map,t=h.defaults,n=$('<div id="app-popup-fixed-container"></div>'),i=$("#app-popup-fixed-container");if(0===i.length&&($(t.parent).append(n),i=n),t.afterEl){var o=$(t.afterEl);i.css({top:o.outerHeight()+"px"})}this.add=function(t,n){var o=new b(t,n);e.set("popup_"+bibil.makeid(10),o),i.append(o.el)}}function m(){this.template="",this.animateRemove="",this.el=null,this.init=function(e,t){t||(t={}),t=$.extend({autoHide:3333},t);var n,i=t.type||"success",o=this,a=$.extend({link:"",target:""},t,{text:d(e),type:i,icon:t.icon||"",link:t.link||""});n=this.el=bibil.Template.renderEl(this.template,{data:a}),!1!==t.autoHide&&setTimeout((function(){o.remove()}),t.autoHide),n.on("click",(function(){o.remove()}))},this.remove=function(){var e=this;e.animateRemove?e.el.mark(e.animateRemove,(function(){e.el.remove()})):e.el.remove()}}function b(e,t){this.template="tpl-popup-fixed",this.animateRemove="slideOutUp",this.init(e,t)}function g(e,t){this.template="tpl-popup-left",this.animateRemove="bounceOutLeft",this.init(e,t),$("body").append(this.el)}function ActionSubmit(e,t){var n,i="opt"in t?bibil.json(t.opt):{},o=e[0].tagName.toLowerCase(),a="input"===o||"textarea"===o,r="checkbox"===e.attr("type"),s="string"==typeof t.action?t.action:"",l="post"in t?t.post:{},c="/api/action/"+s,d=!("toggle"in t)||t.toggle,u="group"in t?t.group:"",f="submit"in t?bibil.json(t.submit):{},p=t.toggleCls,h=(e.getClassesOf("btn-"),t.toggleParent||null),m=$('<i class="fa fa-spinner fa-spin"></i>'),b=t.successReplace,g=!1;function v(){var e=u?$("[data-group="+u+"]"):"",t=$();return e&&e.length>0&&(t=e),t}function y(n){n?(e.addClass("loading"),"button"===o&&e.attr("disabled","disabled")):(e.removeClass("loading"),t.once||e.removeAttr("disabled"))}function w(){$.ajax({url:c,method:"post",data:n,beforeSend:function(){bibil.UI.loading(!0),y(!0)},success:function(n){var i,o=new bibil.Api(n);o.errors.length>0?(bibil.UI.error(o.errors),r&&e.prop("checked",!e.prop("checked"))):(i=parseInt(o.result),e.trigger("action.submit",o.result),d&&function s(t){t=parseInt(t),a?e.AnimationHTML({prop:"border-color: green; background-color: rgb(219, 243, 216)",speed:"1s"}):0===t?(v().removeClass(p[1]),e.removeClass(p[0]).addClass(p[1])):(v().removeClass(p[0]),e.removeClass(p[1]).addClass(p[0]))}(o.result),"removeParent"in t&&e.parents("."+t.removeParent+":first").remove(),h&&(0===i?e.parents("."+h[0]+":first").removeClass(h[1]):e.parents("."+h[0]+":first").addClass(h[1])),"string"==typeof o.success&&o.success.length>0&&(b?e.html(o.success):bibil.UI.modal(o.success)))},error:function(e,t){alert(t)},complete:function(){bibil.UI.loading(!1),y(!1)}})}-1!==s.search("/")?c=s:f=$.extend(f,{action:s}),t.obj&&(f=$.extend(f,{obj:t.obj})),n=$.extend({opt:i},f,l),e.prepend(m),a?r?e.on("change",(function(){g||(n.opt.checked=$(this).is(":checked")?1:0,w())})):e.on("app.entered",(function(e,t){g||(n.opt.text=t,w())})):e.on("click",(function(t){var n=e.data("confirm");if(n&&(n=n.replace(/\\n/g,"\n")),n&&!window.confirm(n))return!1;g||w()})),this.action=s,this.disable=function C(){g=!0},this.setOpt=function k(e){n.opt=e}}function PickImage(e,t){var n=e.find(">.image"),i=e.find(".app-uploader-wrapper"),o=e.find(".actions .removeImage");function a(t){var n="progress-bar-striped progress-bar-animated loading";t?e.addClass(n):e.removeClass(n)}function r(e,t){n.find("img").attr("src",e),n.find("a").length>0&&n.find("a").attr("href",t||"#")}n.find(">a").on("click",(function(e){return"function"==typeof i.Uploader&&i.Uploader("open"),!1})),function s(t){t.on("action.submit",(function(t,n){$(this).hasClass("removeImage")&&(e.addClass("no-image"),r(bibil.sett("imageBlank")),e.trigger("pickimage.remove"))}))}(e.find(".actions *[data-action]")),i.on("uploader.start",(function(e,t){a(!0)})),i.on("uploader.complete",(function(e,t){a(!1),i.Uploader("resetUI")})),i.on("uploader.error",(function(e,t){})),i.on("uploader.upload",(function(n,i){var a,s=t.size?i[t.size]||i.sizes[t.size]:i._orig;s?(a=o.length>0?o.data("ActionSubmit"):"",r(s,i.sizes.big),e.removeClass("no-image"),a&&a.setOpt({file_id:i.file_id}),e&&e.trigger("pickimage.upload")):error("size not found: "+t.size)}))}function v(e,t){var n,i=e,o=t.group,a=[],r=[],s=!0;function l(e){var t=e.attr("aria-describedby"),n=t?$("#"+t):0;return n&&n.length>0?n:null}function c(e,t){t?e.data("popover-hide-timeout",t):e.data("popover-hide-timeout",null)}function d(e){var n=$(this),i=n.data("popover-hide-timeout");i&&clearTimeout(i),l(n)&&c(n,setTimeout((function(){n.hasClass("popover-over")||n.popover("hide")}),t.delay||500))}function u(e){var t=$(this),n=function i(e,t){return e.data("popover-hide-timeout")}(t);o&&$("[data-popova-group="+o+"]").not(t).popover("hide"),n&&(clearTimeout(n),c(t)),l(t)?t.popover("hide"):t.popover("show")}function f(e){a="string"==typeof e.hideOn?e.hideOn.split(" "):[],r="string"==typeof e.showOn?e.showOn.split(" "):[],i.popover("dispose"),e.title?s=!1:e.title="fixme",i.popover(e),n&&clearTimeout(n),i.unbind("click",u),i.unbind("mouseleave",d),-1!==$.inArray("click",r)&&(i.on("click",u),i.on("mouseleave",d)),i.on("hidden.bs.popover",(function(){var e=$(this);e.removeClass("popover-over")})),i.on("shown.bs.popover",(function(){var e=$(this).data("bs.popover");e.__SHOW__=!0})),i.on("inserted.bs.popover",(function(){var n=$(this),o=n.data("bs.popover"),r=$(o.getTipElement());e.cls&&r.addClass(t.cls),r.unbind("mouseenter"),r.unbind("mouseleave"),r.on("mouseenter",(function(){n.addClass("popover-over")})),r.on("mouseleave",(function(){n.removeClass("popover-over"),-1!==$.inArray("mouseleave",a)&&d.call(n[0])})),r.on("click",(function(){-1!==$.inArray("click",a)&&p(),i.trigger("app.popova.click")})),s&&(r.find(".popover-header").remove(),r.addClass("title-fixed"))})),e.autohide&&(n=setTimeout((function(){p()}),e.autohide))}function p(){i.popover("hide")}f(t),i.addClass("app-popova"),o&&i.attr("data-popova-group",o),this.show=function h(){o&&i.popover("hide"),i.popover("show")},this.hide=p,this.initialize=f}function y(e,t,n){n=n||{},n=$.extend({},{autohide:5e3,content:t,placement:"top",title:"",hideOn:"click",showOn:"manual"},n),e.popova(n).popova("show"),e.on("click",(function(){e.popova("hide")}))}function w(e,t){var n,i,o,a=document.createElement("style");function r(){s(),n=bibil.makeid(10),i="app-animation-"+n,o="Animation_"+n,a.id=n,$(a).addClass("app-animation-template"),a.type="text/css",a.innerHTML="."+i+" { animation: "+o+" "+t.speed+" "+t.func+" "+t.count+"; }\n",a.innerHTML+="@keyframes "+o+" { 0% {"+t.prop+"} }",document.getElementsByTagName("head")[0].appendChild(a),e.addClass(i)}function s(){n&&(e.removeClass("app-animation-"+n),$("#"+n).remove())}r(),this.stop=s,this.initialize=function l(e){t=e,r()}}function C(e){var t,n=$("head > title"),i=n.data("timer");if(i&&(clearInterval(i),n.text(n.data("textOrig")),n.removeClass("title-animate")),e){var o=n.text();n.data("textOrig",o),t=setInterval((function(){$("html").toggleClass("title-animate"),$("html").hasClass("title-animate")?n.text(e):n.text(o)}),1e3),n.data("timer",t)}}function Select(e,t){var n,i={allowEmptyOption:!0,dropdownParent:"body",closeAfterSelect:!0,onDropdownOpen:function(){}},o=this,a=!1;t.create&&(i.create=!0),t.searchField||(t.searchField=t.labelField),"string"==typeof t.url&&(i=$.extend(i,{render:{option:function(e,n){var i=e[t.renderField]||e[t.labelField];return'<div><span class="title"><span class="name">'+i+"</span></span></div>"}},valueField:t.valueField,labelField:t.labelField,searchField:t.searchField,loadThrottle:300,load:function(e,n){!function i(e,n){if(!e.length)return n();bibil.Api.request(t.url,{q:e}).then((function(e){n(e.res.items)})).catch((function(e){bibil.UI.error(e),n()}))}(e,n)}}),a=!0),this.loadValue=function(e){if(!e)return error("value empty"),!1;bibil.Api.request(t.url,{id:e}).then((function(n){var i=n.res.items&&n.res.items.length>0?n.res.items[0]:null;if(i){var a={};a[t.labelField]=i[t.labelField],a[t.valueField]=e,o.selectize.addOption(a),o.selectize.setValue(e)}else error("item not found",e,n.res.items)})).catch((function(e){error(e)}))},this.setValue=function(e){if(a)return this.loadValue(e);o.selectize.$input&&o.selectize.$input.find("option[value='"+e+"']").length>0?o.selectize.setValue(e):o.selectize.settings.create?(o.selectize.addOption({text:e,value:e}),o.selectize.setValue(e)):error("value incorrect",e)},this.reset=function(){o.selectize.clear()},e.selectize(i),n=this.selectize=e[0].selectize,n.$control.on("click",(function(){n.clearOptions(),n.close()})),t.value&&this.setValue(t.value)}$("body").append(n),b.prototype=new m,g.prototype=new m,this.popupFix=function(t,n){return e.add(t,n)},this.popupFixError=function(e,t){return t||(t={}),this.popupFix(e,$.extend(t,{type:"danger"}))},this.popupLeft=function(e,t){return new g(e,t)},v.defaults={trigger:"manual",html:!0,title:"",showOn:"click",hideOn:"mouseleave",autohide:!1},$.fn.mark=function(e,t){return this.removeClass("animated").removeClass(e),this.addClass("animated").addClass(e),this.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",(function(){t&&t.call(this),$(this).removeClass(e),$(this).trigger("app.amimated")})),this},$.fn.flyTo=function(e){},w.defaults={speed:"0.4s",count:"1",func:"linear",prop:"background-color: green"},ActionSubmit.defaults={toggleCls:["btn-success","btn-second"]},PickImage.defaults={size:"medium"},Select.defaults={valueField:"id",labelField:"name",renderField:"html"},h.defaults={parent:"body",afterEl:""},this.block=function(e,t,n){t||(t={}),t.block=e;var i=bibil.make(bibil.BlockAjax,null,t);return i&&(i.on("open",(function(e){"function"==typeof n&&n(e)})),i.load()),i},this.uploadClipboard=function(e,t){for(var n,i,o=0;o<e.items.length;o++)i=e.items[o],bibil.isImageByMime(i.type)&&(n=i.getAsFile(),t.length>0&&t.Uploader("attachFile",n))},this.savePosition=function(e,t){var n=bibil.storage(e);n=n?JSON.parse(n):{};var i=$.extend(n,t);bibil.storage(e,JSON.stringify(i))},this.restorePosition=function(e,t){var n=bibil.storage(e);n=n?JSON.parse(n):{};var i=parseInt(n.width),o=parseInt(n.height),a=parseInt(n.top),r=parseInt(n.left);!isNaN(i)&&i>0&&t.css({width:i+"px"}),!isNaN(o)&&o>0&&t.css({height:o+"px"}),isNaN(a)||(a<40&&(a=40),t.css({top:a+"px"})),isNaN(r)||t.css({left:r+"px"})},this.loading=function k(e){e?($("body").addClass("app-ajax-loading"),o++):(o--,0==o&&$("body").removeClass("app-ajax-loading"))},this.ActionSubmit=ActionSubmit,this.AnimationHTML=w,this.PickImage=PickImage,this.Popova=v,this.alert=function x(e,t){return p(e,t)},this.error=function A(e,t){return p(e,$.extend(t,{type:"danger"}))},this.modal=function j(e,t){return p(e,$.extend({},t,{type:"normal"}))},this.win=function I(e,t){var n=p(e,$.extend({},t,{type:"normal"}));return new f(n,t)},this.alertTemplate=function S(e,t,n){var i=bibil.Template.renderEl("tpl-"+e,{data:t});return i.hasClass("modal")&&i.modal("show"),$("body").append(i),i},this.init=function T(t){i=$.extend(i,t),e=new h(h.defaults),bibil.require([]).then((function(){l($("body")),bibil.on("domAppend",(function(e,t){l(t)})),bibil.on("domRemove",(function(e,t){"tooltip"in $.fn&&$(t).findAndSelf(a).each((function(){r($(this))})),"popover"in $.fn&&$(t).findAndSelf("[aria-describedby]").each((function(){s($(this))}))})),$(document).on("click",".dropdown-menu .dropdown-item-noclose",(function(e){e.stopPropagation()})),$(document).on("change","form select.app-submit-on-select",(function(e){$(this).parents("form:first").submit()})),$(document).on("click","a.app-url-parsed:not(.self)",(function(e){if(!confirm("Вы переходите на сторонний сайт, который может потенциально содержать вирусы и прочее вредоносное содержание.\n\nПЕРЕЙТИ ПО ССЫЛКЕ НА СВОЙ СТРАХ И РИСК?"))return!1})),$(document).on("hidden.bs.modal",(function(){$(".modal.show").length>0&&$("body").addClass("modal-open")})),$(document).on("click",".app-submit-parent",(function(){return $(this).parents("form:first").submit(),!1})),$(document).on("click dblclick",".app-navbar-toggler",(function(e){return!$("body").hasClass("app-site-menu-fix-force")&&("dblclick"===e.type?($("body").toggleClass("app-site-menu-fix-force app-site-menu-fix-open"),!1):void $("body").toggleClass("app-site-menu-fix-open"))})),$(document).on("mousemove",(function(e){if($("body").hasClass("app-site-menu-fix-force"))return!1;e.pageX,e.pageX>300&&$("body").removeClass("app-site-menu-fix-open")})),$(document).on("touchmove",".app-touch-remove",(function(){})),$(".app-new-message-alert").on("click",(function(){return bibil.broadcast("messagesreadMark",{}),bibil.Daemon&&"function"==typeof bibil.Daemon.messagesreadMark&&bibil.Daemon.messagesreadMark(!0),!1}))}))},this.renderAlert=u,this.popup=y,this.BanBox=function BanBox(e,t){var n=$(e),i=t.mode||"",o={data:{}},a=n.findAndSelf(".__goban");function r(){l(),s();var e=$.extend({},o,t.post);bibil.Api.request("ban",e).then((function(e){"chat"!==i&&bibil.UI.alert(e.success)})).catch((function(e){bibil.UI.alert(e)}))}function s(){o=t,n.data("ban-options",t)}function l(){n.find(".dropdown-menu [name]").each((function(){this.tagName.toLowerCase();var e=$(this),t=e.attr("type"),n=e.attr("name"),i=e.val();"string"==typeof t&&(t=t.toLowerCase()),"checkbox"===t&&(!e.prop("checked")&&n in o&&delete o[n],e.prop("checked")||(i=null)),null!==i&&(o[n]=i)}))}s(),a.on("click",(function(){o.warning=0,r()})),n.on("hide.bs.dropdown",(function(){l()})),n.find(".dropdown-menu select").on("change",(function(){l()})),n.find(".dropdown-menu [type=checkbox]").on("change",(function(){l()})),n.find(".__warning").on("click",(function(){l(),o.warning=1,r()}))},this.confirm=function _(e,t,n){var i=p(e,$.extend({},t,{type:"normal"}));return i.find(".modal-footer .btn.submit").on("click",(function(){i.find(".modal-body [name]");n()})),i},this.DropDown=function DropDown(e,t){var n=e.find(".dropdown-menu");function i(e){return 0===e.children().length?e.text():""}function o(t){e.find(".dropdown-toggle .status-text").length>0?e.find(".dropdown-toggle .status-text").text(t):e.find(".dropdown-toggle").text(t)}function a(e){n.find(".dropdown-item").removeClass("active");var t="string"==typeof e?r(e):e;return t.addClass("active"),t}function r(e){if(e)return n.find(".dropdown-item[data-value="+e+"]")}e.on("click",".dropdown-item",(function(){var n=$(this),r=n.data("value"),s=i(n);e.trigger("app.change",{value:r,text:s,el:n}),t.sync&&s&&o(s),(void 0===t.setable||t.setable)&&a(n)})),t.title&&o(t.title),t.value&&a(t.value),this.setTitle=o,this.setValue=a,this.getValue=function s(){},this.close=function l(){n.removeClass("show")},this.setByValue=function c(e){var t=a(e),n=i(t);n&&o(n)},this.getByValue=r,this.getActive=function d(){return n.find(".dropdown-item.active")}},this.title=C,this.titleInactive=function D(e){bibil.Utils.tabVisible||C(e),bibil.Utils.once("tabVisible",(function(e){C()}))},this.removePopoversAll=function M(e){e.find("[aria-describedby]").each((function(){s($(this))}))},this.Select2=function P(e,t){},this.Select=Select,this.Tags=function Tags(e,t){var n,i={create:!0,delimiter:",",dropdownParent:"body",closeAfterSelect:!0,plugins:["remove_button"],texts:{add:"xxx"}};t.url&&(i=$.extend(i,{render:{item:function(e,n){var i=e[t.renderField]||e[t.labelField]||e.text;return'<div><span class="title"><span class="name">'+i+"</span></span></div>"}},valueField:t.valueField,labelField:t.labelField,searchField:t.searchField,loadThrottle:300,load:function(e,i){!function o(e,i){if(!e.length)return i();bibil.Api.request(t.url,{q:e}).then((function(e){e.res.items.forEach((function(e){n.addOption({text:e.text,value:e.text})})),n.refreshOptions(),n.open()})).catch((function(e){bibil.UI.error(e),i()}))}(e,i)}})),this.addTag=function(e){n.createItem(e.text)},e.selectize(i),n=this.selectize=e[0].selectize},this.PopupFixedManager=h,this.Like=function Like(e,t){e.find(".trigger").on("click",(function(){var n=$(this),i=n.hasClass("positive");(function o(e){$.Deferred();return bibil.Api.request("like",{obj:t.obj,obj_id:t.objId,positive:e?1:0})})(i).then((function(t){n.attr("disabled","disabled"),function i(t,n){t=parseInt(t),n=parseInt(n),e.find(".trigger.positive .v").text(t>0?t:""),e.find(".trigger.negative .v").text(n>0?n:"")}(t.res.positive,t.res.negative)})).catch((function(e){bibil.UI.error(e)}))}))},this.Notifications=function Notifications(e){var t=e.find(".notifications-icon"),n=e.find(".notifications-dropdown"),i=t.find(".fa"),o=(e.find(".notifications-actions"),e.find(".notifications-items .items"));function a(t){t||(t={}),e.addClass("loading"),e.find(".notifications-items .items").html(""),bibil.Api.request("getAlerts",t).then((function(e){o.html(e.res.html)})).catch((function(e){o.html('<div class="alert alert-danger m-0 rounded-0">'+bibil.UI.objectToText(e)+"</div>")})).done((function(){e.removeClass("loading")}))}e.find(".notifications-actions .close-actions").on("click",(function(){!function t(){e.removeClass("open")}()})),e.find(".notifications-actions .clear").on("click",(function(){a({clear:!0}),$(this).remove()})),o.on("click",".alert-item",(function(){var e=$(this),t=e.find(".holder"),n=e.data("id"),i=e.data("link");i&&(window.location=i),n&&!e.hasClass("loaded")&&(e.find(".alert-loader").removeClass("d-none"),bibil.Api.request("getAlert",{id:n}).then((function(e){t.html(e.res.html)})).catch((function(e){t.html(bibil.UI.objectToText(e))})).done((function(){e.addClass("loaded"),e.find(".alert-loader").addClass("d-none")})))})),t.on("click",(function(){i.removeClass("infinite"),e.toggleClass("open"),function t(){var e=parseInt(n.css("top"))||0,t=0;n.children().not(".notifications-items").each((function(){t+=$(this).outerHeight(!0)})),o.css({maxHeight:$(window).height()-t-(isNaN(e)?0:e)+"px"})}(),a()})),this.update=function(){i.addClass("infinite"),e.removeClass("d-none")}},this.objectToText=d,this.TypingMess=function TypingMess(e,t){e.on("app.keydown",(function(e,n){var i=$(this).data("__typingTimer");n.isAlphaNum&&(i&&clearTimeout(i),i=setTimeout((function(){t.go&&t.go.call()}),300),$(this).data("__typingTimer",i))}))},this.TypedFrom=function TypedFrom(e,t){var n,i=e.find("small");i.length>0?n=new Typed(i[0],{strings:["","вам","что то","пишет"],loop:!0}):error("typed no child small"),this.start=function(){e.removeClass("d-none"),n&&n.start()},this.stop=function(){n.stop(),n&&e.addClass("d-none")}},this.OnlineStatus=function OnlineStatus(e){var t=bibil.Daemon,n=t.getWs(),i={connected:!1,online:0,all:0};n.auth((function(e){i.connected=!0})),t.addMessHandler((function o(){this.update=function(e){i.online=e.count,i.all=e.all}})),n.on("close",(function(){i.connected=!1})),e.renderTemplate({data:i})},this.DropDownStatus=function DropDownStatus(e,t){var n=e.data("DropDown");function i(t){bibil.Api.request("status",t).then((function(t){e.mark("bounce")})).catch((function(e){bibil.UI.error(e)}))}e.find(".custom .btn").on("click",(function(o,a){var r=$(this),s=r.siblings("input"),l=s.val(),c=r.parents(".app-dropdown:first");e.trigger("app.custom",l),c.DropDown("close"),t.user&&i({status:"custom",statusText:l}),t.sync&&n.setTitle(l)})),e.find(".custom input").on("keydown",(function(e,t){"Enter"===e.key&&$(this).siblings(".btn").trigger("click")})),e.on("app.change",(function(o,a){var r=a.value;"custom"!==r&&(e.trigger("app.select",r),t.user&&i({status:r}),t.sync&&n.setByValue(r))})),t.status&&("custom"!==t.status?n.setByValue(t.status):t.statusText&&n.setTitle(t.statusText))},this.StreamLoader=function StreamLoader(e,t){var n=t.submit,i=t.feature||"",o="chrome"===head.browser.name&&-1===navigator.userAgent.indexOf("OPR/"),a=parseInt(n.streamer),r={layout:Cookies.get("floating")&&!head.mobile?"fixed":"static",mobile:head.mobile?1:0,flash:bibil.hasFlash()?1:0,browser:head.browser.name,browser_detail:head.browser,feature:i},s=head.browser.version>86&&"chrome"===head.browser.name;if(a){var l=Cookies.get("streamer_type");r.type=l||(head.mobile||s?"webrtc":"rtmp")}else{var c=Cookies.get("player_type");r.type=c||(bibil.hasFlash()&&o?"rtmp":"auto")}var d=function(e){a&&s&&"rtmp"===e&&bibil.UI.error("Вы используете браузер Chrome > 86 версии, в котором отключили использование микрофонов.<br/><br/>Используйте другие сбособы трансляции")};d(r.type);var u=bibil.make(bibil.BlockAjax,e,{block:"stream.ajax",obj:"chat_room",opt:r,submit:n});function f(t){t||(t={});var n=e.find(".app-stream-playable").data("playable");n&&n.password&&(t.password=n.password),n&&n.serverId&&(t.server_id=n.serverId),r=$.extend({},r,t),function i(){var t=e.find(".app-stream-playable").data("playable");t&&t.destroy()}(),u.reload(r)}u.on("open",(function(){})),function p(){a&&e.on("change",".playable-type-toggle",(function(){var t=e.find(".app-stream-playable").data("playable"),n=$(this).val();if(d(n),!t||!t.tryReload())return!1;Cookies.set("streamer_type",n,{expires:15}),f({type:n})}))}(),u.load(),this.reload=f},this.PayButton=function PayButton(e,t){var n,i=t.offer;n=bibil.make(bibil.BlockAjax,null,{block:"money.pay",obj:"offer",submit:$.extend(t.options||{},{offer_id:i,type:t.type})}),n.on("open",(function(e){var t=e.find(".app-pay-form-wrapper");t.on("form.success",".ajax.app-form",(function(e,n){t.html(n.form)})),t.on("click",".app-order-form .order-cancel",(function(){var e=$(this).val();n.reload({restart:!0,order_id:e})}))})),e.on("click",(function(){n.load()}))},this.DonateButton=function DonateButton(e,t){var n;n=bibil.make(bibil.BlockAjax,null,{block:"money.donate",obj:"chat_room",submit:$.extend(t.options||{},{uid:t.uid,type:t.type})}),n.on("open",(function(e){var t=e.find(".app-donation-form-wrapper");t.on("form.success",".ajax.app-form",(function(e,n){t.html(n.form)})),t.on("click",".app-donation-form .donation-cancel",(function(){n.reload()}))})),e.on("click",(function(){n.load()}))},this.Playable=function Playable(e,t){var n,i=t.url,o=t.autoplay;function a(){n||(n=bibil.Utils.play(i),n.on("end",(function(){error("stop"),r()}))),n.playing()?r():(e.find(".fa").removeClass("fa-play").addClass("fa-stop"),n.play())}function r(){e.find(".fa").removeClass("fa-stop").addClass("fa-play"),n.playing()&&n.stop()}e.on("click",(function(){a()})),o&&a()},this.TextAnim=function TextAnim(e,t){var n=e.text(),i=t.textAnimTimeout||0;return e.contents().filter((function(){return 3===this.nodeType})).each((function(e,t){var n="",o=t.textContent.trim();if(o.length){var a,r=o.match(/./gi);if(r){n=$('<span class="text-animated"/>');for(e=0;e<r.length;e++)a=r[e],n.append("<span>"+a+"</span>")}if(n.length>0){$(t).replaceWith(n);var s=n.find(">span"),l=setInterval((function(){s.each((function(e,t){t.style.setProperty("color",bibil.getRandomColor(),"important")}))}),500);i&&setTimeout((function(){n.replaceWith(document.createTextNode(o)),clearInterval(l)}),i)}}})),n}};return $.fn.ActionSubmit=bibil.registerJqueryPlugin(e.ActionSubmit),$.fn.AnimationHTML=bibil.registerJqueryPlugin(e.AnimationHTML,{multi:!0}),$.fn.PickImage=bibil.registerJqueryPlugin(e.PickImage),$.fn.popova=bibil.registerJqueryPlugin(e.Popova,{noData:!0}),$.fn.banBox=bibil.registerJqueryPlugin(e.BanBox),$.fn.DropDown=bibil.registerJqueryPlugin(e.DropDown),$.fn.SelectCustom=bibil.registerJqueryPlugin(e.Select),$.fn.TagsInput=bibil.registerJqueryPlugin(e.Tags),$.fn.Like=bibil.registerJqueryPlugin(e.Like),$.fn.Notifications=bibil.registerJqueryPlugin(e.Notifications),$.fn.TypingMess=bibil.registerJqueryPlugin(e.TypingMess),$.fn.TypedFrom=bibil.registerJqueryPlugin(e.TypedFrom),$.fn.OnlineStatus=bibil.registerJqueryPlugin(e.OnlineStatus),$.fn.DropDownStatus=bibil.registerJqueryPlugin(e.DropDownStatus),$.fn.StreamLoader=bibil.registerJqueryPlugin(e.StreamLoader),$.fn.PayButton=bibil.registerJqueryPlugin(e.PayButton),$.fn.DonateButton=bibil.registerJqueryPlugin(e.DonateButton),$.fn.Playable=bibil.registerJqueryPlugin(e.Playable),$.fn.TextAnim=bibil.registerJqueryPlugin(e.TextAnim),e}),["Api","Utils"]),bibil.module("Uploader",(function(){function Uploader(e,t){t=t||{};var n=this,i=e.find(".uploader-buttons"),o=e.find(".app-uploader-fileholder"),a=e.find(".app-uploader-abort"),r=e.find(".app-uploader-file"),s=e.find(".progress"),l=s.find(".progress-bar"),c=e.find(".preview"),d=e.find(".messages"),u=null,f=0,p=t.post?$.extend({},t.post):{},h="bound987943875943y",m=null,b=[],g=[],v=new function y(){var e=[];this.addHandler=function t(n){e.push(n)},this.run=function i(t){var i=[],o=$.Deferred();return e.length>0?(e.forEach((function(e){i.push(e(t))})),$.when.apply(n,i).then((function(){for(var e={},t=0;t<arguments.length;t++)e=$.extend(e,arguments[t]);o.resolve(e)}))):o.resolve(),o}},w=t.cropper;function C(e){return log("files to attach:"+e.length),e instanceof FileList||e instanceof Array||(e=[e]),function n(){d.html("")}(),t.maxFiles>0&&function i(){return x().length}()>=t.maxFiles?(k(),I("Максимум "+t.maxFiles+" файл(ов). Удалите и повторите попытку"),error("Максимум "+t.maxFiles+" файл(ов). Удалите и повторите попытку"),!1):(b=[],g=[],u=e,"FileReader"in window?(f=0,void S()):(k(),I("Ваш браузер не поддерживает работу с картинками. Установите нормальный браузер."),!1))}function k(){r[0].value=""}function x(){var e=c.find(".image-attached input"),t=[];return e.map((function(e,n){var i=$(n).val();i?t.push(i):error("value empty")})),t}function A(){r.trigger("click")}function j(e){"boolean"==typeof e?e?s.addClass("in-progress"):(l.removeClass("progress-bar"),l.width(0),l.addClass("progress-bar"),s.removeClass("in-progress")):l.width(e)}function I(e,n){if(e instanceof Array||(e=[e]),void 0===n&&(n="danger"),t.errorPopup&&"popover"in $.fn){var o=i;"string"==typeof t.errorPopup&&/^#/.test(t.errorPopup)&&(o=$(t.errorPopup)),bibil.UI.popup(o,bibil.UI.renderAlert(e,n))}else e.forEach((function(e){d.append('<div class="alert alert-'+n+'">'+e+"</div>")}))}function S(n){var i=function o(){return u.length>0&&void 0!==u[f]?u[f]:null}();i?v.run(i).then((function(o){if(e.trigger("uploader.start",i),t.maxFileSize&&i.size>t.maxFileSize)return I("Слишком большой размер файла("+bibil.bytes(i.size)+"), максимальный размер: "+bibil.bytes(t.maxFileSize)),r[0].value="",!1;j(!1),j(!0),e.addClass("in-progress"),function a(e,n){var i,o,a,r,s=m=new XMLHttpRequest,l=$.Deferred(),c="name"in e?e.name:"image",d=0,u=$.extend({},p,n),f=null,b="type"in e?e.type:"application/octet-stream";s.upload.onprogress=function(e){d=e.loaded/e.total*100,l.notify(d,e)},s.onload=function(){if(200===s.status){a=s.response;try{a=JSON.parse(a)}catch(e){}i=new bibil.Api(a),0===i.errors.length?l.resolve(i):l.reject(i.errors)}else l.reject("Ошибка загрузки файла: "+s.status)},s.onerror=function(){l.reject("Ошибка соединения с сервером")},s.onabort=function(){l.reject("Загрузка прервана")},s.open("POST",t.url),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),f?(s.setRequestHeader("Content-type",'multipart/form-data; boundary="'+h+'"'),s.setRequestHeader("Cache-Control","no-cache"),o="--"+h+"\r\n",o+="Content-Disposition: form-data; name='"+t.inputname+"'; filename='"+unescape(encodeURIComponent(c))+"'\r\n",o+="Content-Type: "+b+"\r\n\r\n",o+=f.result+"\r\n",$.each(u,(function(e,t){o+=_(e,t)})),o+=_("base64_encoded","1"),o+="--"+h+"--",XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(e){function t(e){return 255&e.charCodeAt(0)}var n=Array.prototype.map.call(e,t),i=new Uint8Array(n);this.send(i.buffer)}),s.sendAsBinary?s.sendAsBinary(o):s.send(o)):(r=new FormData,r.append(t.inputname,e),$.each(u,(function(e,t){"object"!=typeof t?r.append(e,t):$.each(t,(function(t,n){r.append(e+"["+t+"]",n)}))})),s.send(r));return l.promise()}(i,o).then((function(i){t.obj_id;var o=$('<div class="img border image-attached" data-title="Удалить"></div>'),a=$('<input type="hidden" name="'+t.bindname+'" value="'+i.result.id+'"/>'),r=$('<img class="i" src="'+i.result.image+'"/>');o.addClass("crosshair"),o.on("click",(function(){o.remove()})),o.append(r).append(a),c.append(o),g.push(i.result),f++,e.trigger("uploader.upload",[i.result]),S(n)})).progress((function(e){j(e+"%")})).fail((function(t){I(t),e.trigger("uploader.error",t),T(),b.push(t),f++,S(n)}))})):(T(),e.trigger("uploader.complete",[g,b]),log("finish upload"))}function T(){j(!1),k(),e.removeClass("in-progress")}function _(e,t){var n="";return n+="--"+h+"\r\n",n+="Content-Disposition: form-data; name='"+e+"'\r\n\r\n",n+=t+"\r\n",n}t.maxFileSize>Uploader.defaults.maxFileSize&&(t.maxFileSize=Uploader.defaults.maxFileSize,log("maxFileSize correct")),t.obj&&(p.obj=t.obj),t.obj_id&&(p.obj_id=t.obj_id),t.alias&&(p.alias=t.alias),t.onlyProgress&&e.addClass("only-progress"),1===t.maxFiles?r.removeAttr("multiple"):r.attr("multiple","multiple"),o.length>0&&o.on("click",(function(){A()})),w&&(v.addHandler((function(e){var t,n=$.Deferred();return bibil.require("ImageCropper",(function(){t=bibil.make(bibil.ImageCropper,e,w),t.on("complete",(function(e){n.resolve({crop:e})})),t.on("cancel",(function(){u=null,n.reject()}))})),n})),v.addHandler((function(e){var t=$.Deferred();return t.resolve({ccccc:3}),t}))),r.change((function(){log("change"),C(this.files)})),a.on("click",(function(){m&&m.abort()})),this.resetUI=function D(){c.html("")},this.open=A,this.getAttached=x,this.attachFile=C}return Uploader.defaults={maxFileSize:bibil.sett("uploadMaxSize"),maxFiles:0,post:{},obj:"",obj_id:"",inputname:"file",bindname:"files[]",url:"/api/uploadFile"},$.fn.Uploader=bibil.registerJqueryPlugin(Uploader),Uploader})),bibil.module("UserStat",(function(){function UserStat(e,t){var n,i,o,a,r=e,s=e.find(".control"),l=e.find(".chart"),c=e.pparent(".modal"),d=e.find(".chart-loader"),u=e.find(".btn-back");function f(){google.charts.load("current",{packages:["corechart","controls"],language:"ru"}),google.charts.setOnLoadCallback(p)}function p(){o=new google.visualization.BarChart(l[0]),s.addClass("d-none"),u.addClass("d-none"),h("/api/UserStatBar",{}).then((function(e){a=new google.visualization.DataTable(e.res.chart),o.draw(a,{height:400,orientation:"horizontal",chart:{title:"Статистика"},hAxis:{title:"дата"},legend:{position:"none"},tooltip:{trigger:"selection",isHtml:!0}}),o.setAction({id:"lick",text:"Показать график",action:function(){var e=o.getSelection(),t=a.getValue(e[0].row,0);return function c(e){e instanceof Object&&(e=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()),h("/api/UserStatLinear",{date:e}).then((function(e){s.removeClass("d-none"),u.removeClass("d-none"),a=new google.visualization.DataTable(e.res.chart),n=new google.visualization.Dashboard(r[0]),o=new google.visualization.ChartWrapper({chartType:"LineChart",containerId:l[0],options:{height:400,chartArea:{width:"90%",height:"88%"},hAxis:{textStyle:{fontSize:10},slantedText:!1},legend:{position:"none"},tooltip:{}}}),i=new google.visualization.ControlWrapper({controlType:"ChartRangeFilter",containerId:s[0],options:{filterColumnIndex:0,ui:{chartType:"LineChart",chartOptions:{enableInteractivity:!1,pointSize:0,pointsVisible:!1,height:50,hAxis:{baselineColor:"none"}},chartView:{}}},state:{range:{}}}),log(n),n.bind(i,o),n.draw(a)})).catch((function(e){bibil.UI.error(e)}))}(t),!1}})})).catch((function(e){bibil.UI.error(e)}))}function h(e,n){d.removeClass("d-none"),n||(n={}),n.uid=t.uid;var i=bibil.Api.request(e,n);return i.then((function(){d.addClass("d-none")})),i}c.length>0?c.on("shown.bs.modal",(function(){f()})):f(),u.length>0&&u.on("click",(function(){p()}))}return $.fn.UserStat=bibil.registerJqueryPlugin(UserStat),UserStat}),["https://www.gstatic.com/charts/loader.js"]),bibil.module("Utils",(function(){function Utils(){var e=this;function t(e){var t=new Howl({src:e});this.play=function(e){bibil.storage("sound_disabled")&&(e=0),void 0!==e&&t.volume(e),t.play()},this.stop=function(){t.stop()},this.playing=function(){return t.playing()},this.on=function(e,n){t.on(e,n)}}function n(e,t){e||(e="alert");var n="/i/beeps/"+e+".ogg";i.stop({tag:"mess"});var o=i.make(n,{tag:"mess"});o.play(t)}var i=new function o(){var e=new Map;this.make=function(n,i){var o=new t(n);return e.set(bibil.makeid(10),$.extend(i,{sound:o})),o},this.stop=function(t){t||(t={}),e.forEach((function(e){(!t.tag||t.tag&&t.tag===e.tag)&&e.sound.stop()}))}};Visibility.isSupported()?Visibility.change((function(t,n){e.tabVisible="visible"===n,e.fire("tabVisible",e.tabVisible)})):error("Visibility not supported"),this.beep=n,this.play=function a(e){var t=i.make(e,{tag:"playurl"});return t},this.beepOnce=function r(e,t){bibil.runOnceTab((function(){n(e,t)}),"beep")},this.tabVisible=!0}return Utils.prototype=new Bibil.Base,new Utils}),[]),bibil.module("VideoPlayer",(function(){function VideoPlayer(e,t){var n=e.find("video");n.addClass("video-js vjs-default-skin");var i={controls:!0,inactivityTimeout:__debug?5e4:500,controlBar:{progressControl:!0}},o=videojs(n.get(0),i,(function(){o.timelineFrames(t.frames)}))}return VideoPlayer.defaults={},$.fn.VideoPlayer=bibil.registerJqueryPlugin(VideoPlayer),VideoPlayer}),[]),bibil.module("VideoRecord",(function(){function VideoRecord(e,t){var n,i=e.find(".video-popup-handler"),o=t.recordId,a=t.dateStart;if(i.length>0){var r=i.attr("href").substring(1),s=$("#"+r);s.length>0&&i.on("click",(function(){$.fancybox.open(s.html(),{type:"html",touch:!1,wheel:!1,afterShow:function(){var e,t,i=this.$content.find(".chat-container"),r=this.$content.find(".video-js");r.length>0&&videojs&&(t=videojs.getPlayer(r.attr("id"))),bibil.Api.request("chatRecord",{record_id:o}).then((function(t){i.html(t.res.html),e=i.find(".chat-item")})).catch((function(e){i.html(bibil.UI.renderAlert(e,"danger"))})),t&&(n=setInterval((function(){var n=t.currentTime(),i=parseInt(a+n);e&&e.length>0&&e.each((function(){var t=parseInt($(this).data("timestamp"));if(t&&!isNaN(t)&&t>=i)return e.removeClass("mess-active"),$(this).addClass("mess-active"),!1})),log("time",i)}),1e3))},afterClose:function(){n&&clearTimeout(n)}})}))}}return VideoRecord.defaults={},$.fn.VideoRecord=bibil.registerJqueryPlugin(VideoRecord),VideoRecord}),[]),bibil.module("Vote",(function(){function Vote(e,t){var n=bibil.Daemon,i=t.owner||"",o=null,a=t.moder?1:10*Math.random()*1e3,r=n.addMessHandler((function s(){this.voteUpdate=function(t){o&&clearTimeout(o),o=setTimeout((function(){!function t(){bibil.Api.request("VoteHTML",{owner_id:i}).then((function(t){e.html(t.res.html)})).catch((function(){}))}()}),a)},this.Voted=function(t){var n=e.find(".result-wrapper");n.length>0&&0===n.find("form.asks").length&&n.html(t.html)},this.voteRemove=function(){l()}}));function l(){e.remove(),r&&(n.removeMessHandler(r),error("handler removed",r))}e.on("form.success",".asks",(function(t,n){$(this).remove();var i=e.find(".result-wrapper");i.html(n.resultVoteHTML)})),e.on("click",".collapse-vote",(function(t,n){e.toggleClass("collapsed")})),e.on("click",".close-vote",(function(t,n){head.mobile||e.hasClass("fixed")?l():(e.addClass("fixed"),e.addClass("collapsed"),e.draggable({handle:".header",containment:"html"}),e.toCenter(!0,!1))}))}return $.fn.Vote=bibil.registerJqueryPlugin(Vote),Vote}),[]),bibil.module("Ws",(function(){function Ws(e){e=e||{};var t,n,i=this,o=e.uri,a=void 0===e.reconnectOnError||e.reconnectOnError,r=0,s=1e3,l=!1,c=new Map,d=!1;Ws.defaults;function u(e,n){f()?("string"==typeof e&&(e={mess:e,data:n||{}}),window.__debug&&(e.__salt__=bibil.makeid(4)),-1===["pong"].indexOf(e.mess)&&log("Send:",e,n),t.send(JSON.stringify(e))):error("error ws send: not opened",t)}function f(){return t&&t.readyState===t.OPEN}function p(e){e&&(l=!0,f()&&t.close()),i.fire("close",e),t=null}function h(e){t=new WebSocket(o),log("connect ws to",o),t.onopen=function(e){s=1e3,i.fire("open"),r||i.fire("opened"),r=0},t.onmessage=function(e){var t,n,o;try{t=JSON.parse(e.data)}catch(t){error("parse error: "+e.data)}t&&(n=t.mess||"",o=t.response||{},-1===["money","ping"].indexOf(t.mess)&&log("Mess: "+t.mess,o),"authorized"===n&&(d=o,i.fire("authorized",o)),"stopReconnect"===n&&(l=!0),"ping"===n&&u("pong",{from:"ping",imAlive:(new Date).getTime()}),"money"===n&&u("pong",{from:"money",imAlive:(new Date).getTime()}),i.fire("message",n,o,t),c.forEach((function(e){if(e){if(e.__sessionId&&e.__sessionId!==o.__sessionId)return!1;"function"==typeof e[n]&&e[n](o)}})),window.mobileAppInterfaceReceiver&&window.mobileAppInterfaceReceiver.avail()&&window.mobileAppInterfaceReceiver.call("wsMessage",t))},t.onerror=function(e){error("ws error"),i.fire("error"),p(),m()},t.onclose=function(e){error("ws closed",e.target?e.target.url:"",e.code),p(),m()}}function m(){!l&&a&&(n&&clearTimeout(n),n=setTimeout((function(){log("reconnect: "+r),h(),r++,3===r?s=5e3:100===r&&(s=3e4)}),s))}this.connect=h,this.send=u,this.start=function b(e){f()?e():i.on("open",(function(){e()}))},this.ready=function g(e){f()?e():i.once("open",(function(){e()}))},this.auth=function v(e){(function t(){return d})()&&e(d),i.on("authorized",(function(t){e(t)}))},this.handler=function y(e,t){var n=bibil.makeid(15);return t&&(e.__sessionId=t),c.set(n,e),n},this.removeHandler=function w(e){c.delete(e)},this.getUri=function C(){return o},this.close=function k(){p(!0)},this.isOpened=f}return Ws.MessageHandlerDefault=function(){this.error=function(e){var t=e;"object"==typeof e&&"errors"in e&&(t=e.errors),e.code||bibil.UI.popupFixError(t)},this.selfExists=function(){bibil.UI.error("Вы вошли в другом окне")},this.alert=function(e){bibil.UI.popupFix(e.text)}},Ws.MessageHandlerDefault.prototype=new Bibil.Base,Ws.BaseMessaging=function(){var e=this;this.messHandler=null,this.baseMess={},this.relay=function(e,t,n,i){"object"!=typeof n||i||(i=n,n=null),n&&this.once("mess."+e+"Accept",(function(e){n(e)})),this.send("relay",{mess:e,clientId:t,params:i})},this.replay=function(e,t,n){this.relay(e+"Accept",t,null,n)},this.echo=function(e,t,n){n&&this.once("mess.__echo"+bibil.firstToUpper(e),(function(e){n(e)})),this.send(e,t)},this.send=function(e,t,n){t=$.extend({},t,this.baseMess),this.ws.send(e,t)},this.addMessHandler=function(e){if(this.messHandler=new e,this.ws)return this.ws.handler(this.messHandler);error("ws is not set")},this.removeMessHandler=function(e){this.ws&&this.ws.removeHandler(e)},this.setWs=function(e){var t=this;this.ws=e,e.on("message",(function(e,n){t.fire("mess."+e,n)}))},this.getWs=function(){return this.ws},this.connect=function(){this.ws.connect()},this.User=function(e){this.getAvatarHref=function(){return this.info.profile?this.info.profile:this.info.ava&&this.info.ava.big?this.info.ava.big:null},this.isAvatarUrlImage=function(){var e=this.getAvatarHref();return!!e&&bibil.isPathImage(e)},this.update=function(e){for(var t in e)this[t]=e[t]},this.userHTML=function(e){var t=bibil.Template.renderEl("app-chat-user-tpl",{data:this,computed:{role:function(){return this.owner?"автор":this.moderator?"модератор":this.moder?"смотрящий":void 0},classes:function(){var e={moder:this.moder,moderator:this.moderator,admin:this.admin,"has-status":this.info.status,owner:this.owner,self:this.self,ignored:this.ignored};return this.info.extended&&this.info.extended.sex&&(e["sex-"+this.info.extended.sex]=!0),e},avatarHref:function(){return this.getAvatarHref()},avatarHTML:function(){var e=this.getAvatar();if(e)return'<img class="app-avatar" src="'+e+'"/>'}}});return t.data("user",this),t},this.confHTML=function(e){var t=bibil.Template.renderEl("app-chat-conf-tpl",{data:this,computed:{role:function(){},pass:function(){return this.videoSettings&&this.videoSettings.hasPass},classes:function(){var e={conf:!0,"owner-conf":this.owner,"self-conf":this.self};return e},avatarHref:function(){return this.getAvatarHref()},avatarHTML:function(){var e=this.getAvatar();if(e)return'<img class="app-avatar" src="'+e+'"/>'}}});return t.data("user",this),t},this.getAvatar=function(){if(this.info&&this.info.avatar)return this.info.avatar},this.update(e)},this.UserManager=function(){var t=new Map;this.add=function(e){return t.set(e.id,this.createUser(e)),t.get(e.id)},this.createUser=function(t){return new e.User(t)},this.remove=function(e){t.delete(e)},this.update=function(e){t.has(e.id)?t.get(e.id).update(e):error("user not found",e.id)},this.getOwner=function(){var e;return t.forEach((function(t,n){t.owner&&(e=t)})),e},this.getById=function(e){return t.has(e)?t.get(e):null},this.getAll=function(){return t}}},Ws.BaseMessaging.prototype=new Bibil.Base,Ws.defaults={pingInterval:5e3},Ws})),bibil.module("SupportAsk",(function(){function SupportAsk(e,t){var n=this,i=t.name;e.parents(".trumbowyg-editor").length>0||(this.radio=function(e,t,n){return t||(t=""),n||(n=e),'<label class="custom-control custom-radio"><input required type="radio" name="'+t+'" value="'+n+'" class="custom-control-input"><span class="custom-control-indicator"></span><span class="custom-control-label" >'+e+"</span></label>"},e.find("textarea,input,select").each((function(){var e=$(this).attr("name");e&&e.length>0&&($(this).attr("data-name",e),$(this).attr("name","__additional["+e+"]"))})),function e(t){var o;t.find(">li").each((function(){$(this).contents().each((function(t,a){3===a.nodeType?""!==a.data.trim()&&(o=i||"radio_0",$(a).replaceWith(n.radio(a.data,o))):"ul"===a.nodeName.toLowerCase()&&e($(a))}))}))}(e),function o(){e.on("change","input[type=radio]",(function(){var e=$(this).pparent("li");e.siblings().removeClass("active"),e.find("li").removeClass("active"),e.addClass("active")}))}())}return $.fn.SupportAsk=bibil.registerJqueryPlugin(SupportAsk),SupportAsk})),bibil.module("Phone",(function(){function Phone(e,t){var n=new window.Phone;n.init(e[0],$.extend({},t))}return $.fn.Phone=bibil.registerJqueryPlugin(Phone),Phone}),["Daemon"]);
