function App(){var e=this;bibil.checkClient().then((function(){bibil.require(["UI","Messages","Daemon","Template","Notify","SmilesLoader"],(function(){try{bibil.UI.PopupFixedManager.defaults.afterEl=".navbar.main",bibil.SmilesLoader.load(),bibil.UI.init({}),bibil.Messages.init({}),window.__legasyBrowser||bibil.Daemon.connect(),bibil.Notify.init(),bibil.Utils.on("tabVisible",(function(t){t&&app.streamsUpdatedNeed&&e.streamsReload(1e3*bibil.rand(2,3),{a:"tab"})}));var t=bibil.sett("aliveTimeout");t&&setInterval((function(){bibil.Api.request("alive",(function(e){}))}),1e3*t)}catch(e){error(e),"function"==typeof window.__errorHandle&&window.__errorHandle(e)}}))})).catch((function(e){alert("Ошибка авторизации. Обновите страницу"),error("auth error",e)})),head.browser&&"chrome"===head.browser.name&&head.browser.version<=49&&$("head").append("<style>.col{height:100%}</style>"),this.onUpdateStreams=function(e){var t=e.type,n=e.user,a=e.room,i=e.alert;t&&(this.streamsUpdatedNeed=!0,this.streamsReload(null,a?{r:a.alias,t:t}:{})),"publish"===t&&a&&n&&i&&!head.mobile&&bibil.UI.popupLeft('<i class="fa fa-rss text-red"></i> '+a.name,{icon:n.ava,autoHide:1e4,type:"light",link:a.link,target:"_blank"})},this.streamsReload=function(t,n){var a=$.Deferred(),i=$(".list-streams-ajax");return null==t&&(t=1e3*bibil.rand(2,10)),i.length>0&&(bibil.Utils.tabVisible?(log("update list",t),e.setTimeoutOne((function(){i.ListAjax("refresh",n),app.streamsUpdatedNeed=!1}),t,"streamsUpdate")):info("list update cancel, tab invisible")),a},this.streamsUpdatedNeed=!1}function Money(e,t){var n,a=null;function i(){var e=$("#cart");return e.length>0?e:null}function o(){var e=i();e&&"function"==typeof e.BlockAjax&&e.BlockAjax("reload")}function r(){var e=i(),t=$("#app-cart-wrapper");e&&e.find(".app-cart-block").remove(),$("body").removeClass("has-cart"),t.length>0&&t.remove()}function s(e){var t=$(this).parents(".app-order-form-wrapper:first"),n=t.data("flipModel");n?n.isFlipped?(t.find(">.back").html(""),t.find(">.front").html(e),t.flip(!1)):(t.find(">.front").html(""),t.find(">.back").html(e),t.flip(!0)):t.html(e)}function l(){var e=$(this).data("orderSuccess"),t=$(this),n=t.pparent(".modal"),a=t.pparent("form");t.is("button")&&t.attr("disabled","disabled"),t.is("a")&&(setTimeout((function(){t.attr("href","#")}),500),t.addClass("disabled")),t.pparent("form").addClass("pay-submitted"),a.find(".pay-content").addClass("d-none"),a.find(".pay-in-progress").removeClass("d-none"),n.length,e&&0===n.length&&setTimeout((function(){window.location.href=e}),1e3)}function d(e){var t;$(e).find(".app-cart-button").on("action.submit",(function(e,t){var n=$(this).parents(".app-cart-button-wrapper:first");$(this).addClass("d-none"),n.find(".order").removeClass("d-none").mark("swing"),o()})),$(e).find("[data-action=removeCart]").on("action.submit",(function(e,t){o(),$(this).parents(".list-item-col:first").remove()})),t=$(e).findAndSelf(".app-cart-block"),t.length>0&&($("body").addClass("has-cart"),t.find(".close").on("action.submit",(function(e,t){r()})));var a=$(e).find("#cash_out");a.length>0&&(n||(n=new c(a)))}function c(e){var t=e.find("select[name=method]"),n=e.find(".comission"),i=e.find("[type=submit]"),o=e.find("[name=amount]"),r=e.find(".errors-bottom");function s(e){e instanceof Array&&(e=e.join("<br/>")),e.length>0?(r.html(e),r.removeClass("d-none")):r.addClass("d-none")}function l(e){void 0===e?i.attr("disabled","disabled"):i.removeAttr("disabled")}function d(){var a=t.val(),i=e.find("[name=account]").val()||"",r=o.val();if(l(),s(""),r.length>0&&a.length>2){if("mobile"===a&&!i)return n.addClass("d-none"),!1;n.removeClass("d-none"),e.addClass("commission-getting"),bibil.Api.request("checkOut",{method:a,account:i,amount:r}).then((function(t){!function a(e){n.removeClass("d-none"),n.find(".amount_full").html(e)}(t.res.amount),i.length>0&&l(!1),e.removeClass("commission-getting")})).catch((function(t){s(t),n.addClass("d-none"),e.removeClass("commission-getting")}))}}function c(e){a&&clearTimeout(a),a=setTimeout((function(){d()}),500)}function f(){var t=$(this).val(),a=e.find(".account");l(),"BlockAjax"in a&&(t.length>0?(log("handleMethod"),a.BlockAjax("load",{params:{method:t}}),d()):(a.BlockAjax("clear"),n.addClass("d-none")))}function p(e){$(e).findAndSelf("[name=account]").on("copy paste cut change input",(function(e,a){$(this).val().length>1?c():(l(),"mobile"==t.val()&&n.addClass("d-none"))}))}bibil.on("domAppend",(function(e,t){p(t)})),e.find("[name=amount]").on("input",(function(e,t){$(this).val().length>0?c():(l(),n.addClass("d-none"))})),e.on("form.success",(function(e,t){})),p(e[0]),t.on("change",(function(e){f.call(this)}))}$(document).on("form.success",".app-order-form-wrapper .app-order-form",(function(e,t){s.call(this,t.form),t.cartClean&&r()})),$(document).on("click",".app-order-form a[data-order-success]",(function(e){l.call(this)})),$(document).on("submit",".app-order-form",(function(e){l.call($(this).find("[data-order-success]")[0])})),$(document).on("click",".app-order-form-wrapper .app-order-form .order-cancel",(function(){var e=$(this).val(),t=$(this),n=t.parents("form:first")[0];$(n).FormAjax&&$(n).FormAjax("loading",!0),bibil.Api.request("orderCancel",{order_id:e}).then((function(e){s.call(n,e.res)})).catch((function(e){}))})),d($("body")),bibil.on("domAppend",(function(e,t){d(t)}))}window.Popper&&(window.Popper.Defaults.eventsEnabled=!1),$((function(){$("form.create-room input[name=alias], .app-url-example").on("keydown paste input",(function(e,t){var n=$(this).data("pattern"),a=$(this).siblings(".url").find("span"),i=$(this).val(),o=a.text(),r=e.key||"";if(!e.ctrlKey&&!e.shiftKey&&!e.altKey&&("input"===e.type||"keydown"===e.type)&&n&&r){var s=new RegExp(n,"i");if(!s.test(r))return!1}o=o.replace(/\/[^\/]*$/,"/"+i.toLowerCase()),a.text(o)}));var e=function(){$("body").css({paddingBottom:$("footer").outerHeight()+"px"})};e(),$(window).on("resize",(function(){e()})),$(".user-chat-join").on("click",(function(){var e=$("#chat_template").html();$(this).parent().after(e),$(this).parent().remove()})),$("nav.main .center  form [type=submit]").on("click",(function(){var e=$(this).siblings("input");$(this).parents("form:first");if("none"===e.css("display"))return $("nav.main").addClass("form-abs"),e.focus(),!1})),$(".app-height-100").each((function(){var e=$(this),t=parseInt(e.css("top"))||0;e.css({maxHeight:$(window).height()-(isNaN(t)?0:t)+"px"})})),$(".skip-promo").on("click",(function(){setTimeout((function(){$("#promo_home").remove()}),head.mobile?1e3:100),Cookies.set("promo_hidden",1,{expires:1})}))})),App.prototype=new Bibil.Base,window.app=new App,new Money,$((function(){$(".user-extended-filter [type=submit]");var e=$(".user-extended-filter");$(".user-extended-filter");e.on("form.before",(function(){e.addClass("filter-on"),$(".users-list-static").remove()})),e.find("input[type=radio], input[type=checkbox]").on("change",(function(t){e.trigger("submit")})),$(".list-users-ajax").on("app.list-ajax.before",(function(){e.find("input, select").attr("disabled","disabled"),e.find(".selectize-input").addClass("disabled")})).on("app.list-ajax.complete",(function(){e.find("input, select").removeAttr("disabled","disabled"),e.find(".selectize-input").removeClass("disabled")})),e.find(".reset-filter").on("click",(function(){e.removeClass("filter-on")}))})),$((function(){$(document).on("form.success",".modal.seller-dialog-createOffer form.ajax, .modal.seller-dialog-createCoupon form.ajax, .modal.seller-dialog-createDonation form.ajax",(function(e,t){var n=$(this),a=n.parents(".modal:first"),i=$(".app-list-ajax").data("ListAjax"),o=n.hasClass("editable")?100:3e3,r=a.length>0?a.data("BlockAjax"):"";i&&i.refresh(),r&&setTimeout((function(){r.remove()}),o)})),$(document).on("click",".modal.tags_select .modal-body [data-name]",(function(){var e=$(".seller-dialog-createOffer input[name=tags]").data("Tags"),t=$(this);return e&&(log(e),e.addTag({text:t.data("name"),value:t.data("id")})),!1}));var e=$(".market-settings form ");function t(){var t=e.find("input[name=protect]:checked"),n=e.find("input[name=protect_type]:checked"),a=e.find("input[name=protect_effect]:checked");e.find(".protect-setting").toggleClass("d-none","none"===t.val()),"none"!==t.val()&&(e.find(".protect-text").toggleClass("d-none","text"!==n.val()),e.find(".protect-logo").toggleClass("d-none","logo"!==n.val()),e.find(".protect-effect-amount").toggleClass("d-none","none"===a.val()))}e.find("input").on("change",(function(){t()})),$(".setting-protect").removeClass("d-none"),t(),$(document).on("app.block.load",".modal.seller-dialog-requestShow .createOfferRequest",(function(){var e=$(this).parents(".modal:first");e.length>0&&e.modal("hide")}))}));
